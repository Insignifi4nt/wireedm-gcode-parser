System.register([],function(t,e){"use strict";return{execute:function(){var t=document.createElement("style");t.textContent=':root{--color-bg-primary: #1a1a1a;--color-bg-secondary: #2a2a2a;--color-bg-tertiary: #333;--color-bg-dark: #0a0a0a;--color-bg-input: #404040;--color-text-primary: #e0e0e0;--color-text-secondary: #ccc;--color-text-accent: #4CAF50;--color-text-white: white;--color-accent-primary: #4CAF50;--color-accent-hover: #45a049;--color-accent-secondary: #555;--color-accent-hover-secondary: #666;--color-success: #4CAF50;--color-error: #f44336;--color-warning: #ff9800;--color-info: #2196F3;--color-path-rapid: #ffff00;--color-path-cutting: #00ff00;--color-path-start: #ff0000;--color-path-end: #0000ff;--color-point-clicked: #ff00ff;--color-grid-minor: rgba(255, 255, 255, .1);--color-grid-major: rgba(255, 255, 255, .2);--color-grid-axis: rgba(255, 255, 255, .4);--font-family-primary: Arial, sans-serif;--font-family-mono: monospace;--font-size-base: 14px;--font-size-small: 12px;--font-size-large: 16px;--font-weight-normal: 400;--font-weight-medium: 500;--font-weight-bold: 700;--line-height-base: 1.4;--line-height-tight: 1.2;--spacing-xs: 2px;--spacing-sm: 5px;--spacing-md: 10px;--spacing-lg: 15px;--spacing-xl: 20px;--spacing-xxl: 30px;--border-radius-sm: 3px;--border-radius-md: 5px;--border-radius-lg: 8px;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .2);--shadow-md: 0 2px 5px rgba(0, 0, 0, .3);--shadow-lg: 0 4px 8px rgba(0, 0, 0, .4);--shadow-inset: inset -2px 0 5px rgba(0, 0, 0, .3);--transition-fast: .15s ease;--transition-normal: .3s ease;--transition-slow: .5s ease;--z-index-base: 1;--z-index-elevated: 10;--z-index-modal: 100;--z-index-overlay: 500;--z-index-toast: 1000;--sidebar-width: 380px;--sidebar-width-mobile: 100%;--header-height: auto;--canvas-bg: var(--color-bg-dark);--button-padding: 8px 15px;--button-padding-small: 2px 8px;--button-border-radius: var(--border-radius-md);--button-transition: background-color var(--transition-normal);--input-padding: var(--spacing-md) var(--spacing-lg);--input-border-radius: var(--border-radius-md);--input-transition: all var(--transition-normal);--breakpoint-mobile: 480px;--breakpoint-tablet: 768px;--breakpoint-desktop: 1024px;--breakpoint-large: 1200px}@media (prefers-contrast: high){:root{--color-text-primary: #ffffff;--color-bg-primary: #000000;--color-bg-secondary: #1a1a1a;--shadow-md: 0 2px 5px rgba(255, 255, 255, .1)}}@media (prefers-reduced-motion: reduce){:root{--transition-fast: 0s;--transition-normal: 0s;--transition-slow: 0s}}@media print{:root{--color-bg-primary: white;--color-bg-secondary: #f5f5f5;--color-text-primary: black;--color-text-secondary: #333;--shadow-md: none}}*{box-sizing:border-box}html{font-size:var(--font-size-base);line-height:var(--line-height-base)}body{margin:0;padding:0;font-family:var(--font-family-primary);background-color:var(--color-bg-primary);color:var(--color-text-primary);display:flex;flex-direction:column;height:100vh;overflow:hidden}#app{display:flex;flex-direction:column;height:100vh;width:100%}.wire-edm-viewer{display:flex;flex-direction:column;height:100%;width:100%}#loading{display:flex;align-items:center;justify-content:center;height:100vh;font-size:var(--font-size-large);color:var(--color-text-secondary)}.main-container{flex:1;display:flex;overflow:hidden;min-height:0}#sidebar-container{display:flex;justify-content:center;align-items:flex-start;width:var(--sidebar-width);background-color:var(--color-bg-secondary);padding:var(--spacing-md);box-shadow:var(--shadow-inset)}h1,h2,h3,h4,h5,h6{margin:0 0 var(--spacing-md) 0;color:var(--color-text-accent);font-weight:var(--font-weight-medium);line-height:var(--line-height-tight)}h3{margin-top:0;font-size:var(--font-size-base)}p{margin:0 0 var(--spacing-md) 0}button{background-color:var(--color-accent-secondary);color:var(--color-text-white);border:none;padding:var(--button-padding);border-radius:var(--button-border-radius);cursor:pointer;font-family:inherit;font-size:var(--font-size-base);font-weight:var(--font-weight-normal);transition:var(--button-transition);line-height:1;text-align:center;user-select:none;-webkit-user-select:none}button:hover:not(:disabled){background-color:var(--color-accent-hover-secondary)}button:focus{outline:2px solid var(--color-accent-primary);outline-offset:2px}button:disabled{opacity:.6;cursor:not-allowed}button:active:not(:disabled){transform:translateY(1px)}.button-primary{background-color:var(--color-accent-primary)}.button-primary:hover:not(:disabled){background-color:var(--color-accent-hover)}.button-small{padding:var(--button-padding-small);font-size:var(--font-size-small)}.button-danger{background-color:var(--color-error)}.button-danger:hover:not(:disabled){background-color:#d32f2f}input[type=file]{position:absolute;left:-9999px;opacity:0;width:0;height:0}label{display:inline-block;cursor:pointer;font-weight:var(--font-weight-normal)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--color-bg-secondary);border-radius:var(--border-radius-sm)}::-webkit-scrollbar-thumb{background:var(--color-accent-secondary);border-radius:var(--border-radius-sm)}::-webkit-scrollbar-thumb:hover{background:var(--color-accent-hover-secondary)}*{scrollbar-width:thin;scrollbar-color:var(--color-accent-secondary) var(--color-bg-secondary)}:focus{outline:2px solid var(--color-accent-primary);outline-offset:2px}::selection{background-color:var(--color-accent-primary);color:var(--color-text-white)}.visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.no-select{user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.loading{opacity:.6;pointer-events:none}.loading:after{content:"";position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid var(--color-accent-primary);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.error{color:var(--color-error);border-color:var(--color-error)}.success{color:var(--color-success);border-color:var(--color-success)}@media print{body{background:#fff;color:#000}.no-print,button,.header{display:none!important}.main-container{flex-direction:column}.canvas-container{width:100%!important}.sidebar{width:100%!important;box-shadow:none;border-top:1px solid #ccc;margin-top:var(--spacing-md)}}.header{background-color:var(--color-bg-secondary);padding:var(--spacing-lg);box-shadow:var(--shadow-md);position:relative;z-index:var(--z-index-elevated)}.controls{display:flex;gap:var(--spacing-xl);align-items:center;flex-wrap:wrap}.file-input-wrapper{position:relative;overflow:hidden;display:inline-block}.file-input-label{background-color:var(--color-accent-primary);color:var(--color-text-white);padding:var(--spacing-md) var(--spacing-xl);border-radius:var(--border-radius-md);cursor:pointer;transition:var(--transition-normal);display:inline-block;font-weight:var(--font-weight-medium);text-align:center;border:2px solid transparent}.file-input-label:hover{background-color:var(--color-accent-hover);transform:translateY(-1px)}.file-input-label:focus-within{outline:2px solid var(--color-accent-primary);outline-offset:2px}.file-input-label.drag-over{background-color:var(--color-accent-hover);border-color:var(--color-accent-primary);box-shadow:var(--shadow-md)}.file-input-label:disabled{opacity:.6;cursor:not-allowed;transform:none}.zoom-controls{display:flex;gap:var(--spacing-md);align-items:center;flex-wrap:wrap}.zoom-display{font-family:var(--font-family-mono);background-color:var(--color-bg-tertiary);padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius-sm);color:var(--color-text-secondary);font-size:var(--font-size-small);min-width:80px;text-align:center;border:1px solid var(--color-accent-secondary)}.canvas-container{flex:1;position:relative;overflow:hidden;background-color:var(--canvas-bg);min-width:0}canvas{cursor:crosshair;display:block;width:100%;height:100%;border:1px solid var(--color-accent-secondary);background-color:var(--canvas-bg)}canvas:focus{outline:2px solid var(--color-accent-primary);outline-offset:2px}.canvas-container.loading canvas{opacity:.6;cursor:wait}.canvas-container.error canvas{border-color:var(--color-error);opacity:.8}.sidebar{width:100%;max-width:calc(var(--sidebar-width) - var(--spacing-lg) * 2);background-color:transparent;padding:0;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;gap:var(--spacing-lg)}.gcode-drawer{position:fixed;top:0;height:100vh;width:420px;background:var(--color-bg-tertiary);box-shadow:var(--shadow-lg);transition:transform var(--transition-normal);display:flex;flex-direction:column;z-index:var(--z-index-overlay)}.gcode-drawer.gcode-drawer--right{right:0;left:auto;border-left:1px solid rgba(255,255,255,.1);transform:translate(100%)}.gcode-drawer.gcode-drawer--right.open{transform:translate(0)}.gcode-drawer.gcode-drawer--left{left:0;right:auto;border-right:1px solid rgba(255,255,255,.1);transform:translate(-100%)}.gcode-drawer.gcode-drawer--left.open{transform:translate(0)}.gcode-drawer-header{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-md) var(--spacing-lg);border-bottom:1px solid rgba(255,255,255,.1)}.gcode-drawer-title{display:flex;align-items:center;gap:var(--spacing-lg)}.gcode-line-count{color:var(--color-text-secondary);font-family:var(--font-family-mono);font-size:12px;opacity:.8}.gcode-mode-toggle{display:flex;background:var(--color-bg-secondary);border-radius:var(--border-radius-md);padding:2px;gap:0}.gcode-mode-btn{padding:var(--button-padding-small);background:transparent;border:none;color:var(--color-text-secondary);border-radius:calc(var(--border-radius-md) - 2px);cursor:pointer;font-size:11px;font-weight:var(--font-weight-medium);transition:var(--button-transition);min-width:40px;text-align:center}.gcode-mode-btn:hover:not(.active){background:var(--color-accent-hover-secondary);color:var(--color-text-primary)}.gcode-mode-btn.active{background:var(--color-accent-primary);color:var(--color-text-white);box-shadow:0 1px 3px rgba(0,0,0,.3)}.gcode-action-btn{background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--color-text-primary);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:14px;transition:var(--transition-fast);min-width:32px;height:32px;display:flex;align-items:center;justify-content:center}.gcode-action-btn:hover:not(:disabled){background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2)}.gcode-action-btn:disabled{opacity:.4;cursor:not-allowed}.gcode-context-toolbar{background:var(--color-bg-secondary);border-bottom:1px solid rgba(255,255,255,.1);padding:var(--spacing-sm) var(--spacing-lg);display:flex;align-items:center;justify-content:space-between;gap:var(--spacing-md)}.gcode-selection-info{display:flex;align-items:center}.gcode-selection-counter{font-size:12px;color:var(--color-accent-primary);background:rgba(255,165,0,.15);padding:4px 8px;border-radius:12px;font-weight:500}.gcode-selection-actions{display:flex;align-items:center;gap:4px}.gcode-toolbar-btn{background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--color-text-primary);padding:4px 8px;border-radius:3px;cursor:pointer;font-size:12px;transition:var(--transition-fast);min-height:24px}.gcode-toolbar-btn:hover:not(:disabled){background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2)}.gcode-toolbar-btn:disabled{opacity:.4;cursor:not-allowed}.gcode-help-text{color:var(--color-text-secondary);opacity:.8;font-size:11px;text-align:center;padding:var(--spacing-sm)}.gcode-drawer-body{flex:1;overflow:auto;font-family:var(--font-family-mono);font-size:12px}.gcode-line{display:flex;gap:8px;padding:2px 10px;white-space:pre;position:relative}.gcode-line.has-changes:before{content:"●";position:absolute;left:-8px;top:50%;transform:translateY(-50%);color:orange;font-size:8px;opacity:.8}.gcode-line.editing{background:rgba(255,165,0,.08);border-left:2px solid rgba(255,165,0,.4)}.gcode-line:hover{background:rgba(255,255,255,.05);cursor:pointer}.gcode-line.selected{background:rgba(255,165,0,.25);border-left:3px solid #ffa500;box-shadow:inset 0 0 0 1px rgba(255,165,0,.3)}.gcode-line-num{width:48px;color:var(--color-text-secondary);text-align:right}.gcode-line-text{color:var(--color-text-primary);flex:1}.gcode-line-text[contenteditable=true]{outline:none}.gcode-del{background:transparent;color:var(--color-text-secondary);border:none;cursor:pointer;min-width:20px;min-height:20px;padding:2px 4px;border-radius:3px;display:flex;align-items:center;justify-content:center;transition:var(--transition-fast);font-size:14px;font-weight:700}.gcode-del:hover{color:var(--color-error);background:rgba(220,53,69,.15);border:1px solid rgba(220,53,69,.3);transform:scale(1.05)}.gcode-drawer--mode-edit .gcode-line,.gcode-drawer--mode-edit .gcode-line:hover{cursor:text}.gcode-drawer--mode-select .gcode-line{cursor:pointer}.gcode-drawer--mode-select .gcode-line-text{user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;caret-color:transparent}.gcode-drawer--mode-edit .gcode-context-toolbar{display:none!important}.gcode-del:active{transform:scale(.95)}.gcode-drawer-footer{border-top:1px solid rgba(255,255,255,.1);display:flex;justify-content:center}.gcode-drawer-actions{display:flex;gap:4px;align-items:center}.sidebar-section{background-color:var(--color-bg-tertiary);padding:var(--spacing-xl);border-radius:var(--border-radius-md);border:1px solid rgba(255,255,255,.1);transition:var(--transition-normal);overflow-x:hidden;margin-bottom:var(--spacing-sm)}.coordinates-display,.clicked-points,.path-info,.usage-panel{background-color:var(--color-bg-tertiary);padding:var(--spacing-xl);border-radius:var(--border-radius-md);border:1px solid rgba(255,255,255,.1);transition:var(--transition-normal);overflow-x:hidden;box-shadow:var(--shadow-sm);position:relative;width:100%}.coordinates-display:hover,.clicked-points:hover,.path-info:hover,.usage-panel:hover{background-color:rgba(51,51,51,.8);border-color:rgba(255,255,255,.2);box-shadow:var(--shadow-md);transform:translateY(-1px)}.coordinate-item{margin:var(--spacing-md) 0;font-family:var(--font-family-mono);font-size:var(--font-size-small);display:flex;justify-content:center;align-items:center;padding:var(--spacing-sm) var(--spacing-md);background-color:var(--color-bg-input);border-radius:var(--border-radius-sm);border:1px solid rgba(255,255,255,.05);overflow:hidden;white-space:nowrap;transition:var(--transition-fast);gap:var(--spacing-md)}.coordinate-item:hover{background-color:rgba(64,64,64,.6);border-color:rgba(255,255,255,.1)}.coordinate-item span{font-weight:var(--font-weight-medium);color:var(--color-accent-primary)}.sidebar h3{margin:0 0 var(--spacing-lg) 0;color:var(--color-text-accent);font-size:var(--font-size-base);font-weight:var(--font-weight-medium);text-align:center;padding-bottom:var(--spacing-sm);border-bottom:1px solid rgba(255,255,255,.1)}.point-list{max-height:200px;overflow-y:auto;font-family:var(--font-family-mono);font-size:var(--font-size-small);padding:var(--spacing-sm) 0;margin-top:var(--spacing-md)}.point-item{padding:var(--spacing-md);margin:var(--spacing-sm) 0;background-color:var(--color-bg-input);border-radius:var(--border-radius-sm);display:flex;justify-content:center;align-items:center;transition:var(--transition-fast);border:1px solid rgba(255,255,255,.05);gap:var(--spacing-lg)}.point-item:hover{background-color:rgba(64,64,64,.8);border-color:var(--color-accent-primary);transform:scale(1.02)}.point-label{color:var(--color-text-accent);font-weight:var(--font-weight-medium);margin-right:var(--spacing-sm)}.point-coords{color:var(--color-text-primary);font-weight:var(--font-weight-normal);flex:1;text-align:center}.delete-point-btn{background-color:var(--color-error);color:var(--color-text-white);border:none;padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius-sm);cursor:pointer;font-size:11px;font-weight:var(--font-weight-medium);transition:var(--transition-fast);flex-shrink:0;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center}.delete-point-btn:hover{background-color:#d32f2f;transform:scale(1.05)}.delete-point-btn:focus{outline:2px solid var(--color-error);outline-offset:1px}.no-points{text-align:center;color:var(--color-text-secondary);font-style:italic;padding:var(--spacing-xl) var(--spacing-md);background-color:var(--color-bg-input);border-radius:var(--border-radius-sm);border:1px solid rgba(255,255,255,.05);margin-top:var(--spacing-md)}.path-info div{margin-top:var(--spacing-md)}.path-stat{margin:var(--spacing-sm) 0;padding:var(--spacing-sm) var(--spacing-md);background-color:var(--color-bg-input);border-radius:var(--border-radius-sm);border:1px solid rgba(255,255,255,.05);font-family:var(--font-family-mono);font-size:var(--font-size-small);display:flex;justify-content:center;align-items:center;transition:var(--transition-fast);gap:var(--spacing-md)}.path-stat:hover{background-color:rgba(64,64,64,.6);border-color:rgba(255,255,255,.1)}.stat-label{color:var(--color-text-secondary);font-weight:var(--font-weight-normal)}.stat-value{color:var(--color-accent-primary);font-weight:var(--font-weight-medium)}.path-stats strong{color:var(--color-accent-primary)}.usage-panel{margin-top:var(--spacing-md)}.usage-panel:hover{background-color:rgba(51,51,51,.8);border-color:rgba(255,255,255,.2)}.usage-content{font-size:var(--font-size-small);line-height:1.4;word-wrap:break-word;overflow-wrap:break-word;margin-top:var(--spacing-md)}.usage-section{margin-bottom:var(--spacing-lg);padding:var(--spacing-md);background-color:var(--color-bg-input);border-radius:var(--border-radius-sm);border:1px solid rgba(255,255,255,.05)}.usage-section h4{color:var(--color-accent-primary);margin:0 0 var(--spacing-sm) 0;font-size:var(--font-size-small);font-weight:var(--font-weight-medium)}.usage-section p{margin:var(--spacing-xs) 0;color:var(--color-text-secondary);font-size:12px}.usage-section strong{color:var(--color-text-primary);font-weight:var(--font-weight-medium)}.status-message{position:fixed;top:var(--spacing-xl);right:var(--spacing-xl);background-color:var(--color-success);color:var(--color-text-white);padding:var(--spacing-lg) var(--spacing-xl);border-radius:var(--border-radius-md);display:none;z-index:var(--z-index-toast);max-width:400px;box-shadow:var(--shadow-lg);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(10px);animation:slideInRight .3s ease-out}.status-message.show{display:block}.status-message.hide{animation:slideOutRight .3s ease-in forwards}.status-message.success{background-color:var(--color-success)}.status-message.error{background-color:var(--color-error)}.status-message.warning{background-color:var(--color-warning);color:var(--color-bg-primary)}.status-message.info{background-color:var(--color-info)}.status-message-content{display:flex;align-items:flex-start;gap:var(--spacing-md)}.status-message-text{flex:1;font-size:var(--font-size-base);line-height:var(--line-height-base)}.status-message-close{background:none;border:none;color:inherit;cursor:pointer;font-size:18px;padding:0;margin-left:var(--spacing-md);opacity:.8;transition:var(--transition-fast)}.status-message-close:hover{opacity:1;transform:scale(1.1)}.status-progress{margin-top:var(--spacing-md);background-color:rgba(255,255,255,.2);border-radius:var(--border-radius-sm);height:4px;overflow:hidden}.status-progress-bar{height:100%;background-color:rgba(255,255,255,.8);border-radius:var(--border-radius-sm);transition:width var(--transition-normal);width:0%}@keyframes slideInRight{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes slideOutRight{0%{transform:translate(0);opacity:1}to{transform:translate(100%);opacity:0}}@media (max-width: 768px){.header{padding:var(--spacing-md)}.controls{gap:var(--spacing-md);justify-content:center}#sidebar-container{width:320px}.status-message{right:var(--spacing-md);left:var(--spacing-md);max-width:none}}@media (max-width: 480px){.main-container{flex-direction:column}#sidebar-container{width:100%;max-height:40vh;order:2;box-shadow:var(--shadow-md)}.canvas-container{order:1;min-height:60vh}.header{padding:var(--spacing-md) var(--spacing-sm)}.controls{flex-direction:column;gap:var(--spacing-sm);align-items:stretch}.zoom-controls{justify-content:center;flex-wrap:wrap}.file-input-label{text-align:center;width:100%}.status-message{top:var(--spacing-sm);right:var(--spacing-sm);left:var(--spacing-sm);font-size:var(--font-size-small)}.coordinates-display,.clicked-points,.path-info{padding:var(--spacing-md)}.point-list{max-height:120px}}@media (min-width: 1200px){#sidebar-container{width:450px}.controls{gap:var(--spacing-xxl)}.header{padding:var(--spacing-xl)}}@media (prefers-contrast: high){.file-input-label,button{border:2px solid currentColor}.status-message{border:2px solid var(--color-text-white)}.point-item{border:1px solid var(--color-text-primary)}canvas{border:2px solid var(--color-text-primary)}}@media (prefers-reduced-motion: reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}.status-message{animation:none}.file-input-label:hover,.point-item:hover,.delete-point-btn:hover{transform:none}}.skip-to-content{position:absolute;top:-40px;left:6px;background:var(--color-accent-primary);color:var(--color-text-white);padding:8px;text-decoration:none;z-index:var(--z-index-overlay);border-radius:var(--border-radius-sm);transition:top var(--transition-fast)}.skip-to-content:focus{top:6px}.sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important}button:focus-visible,.file-input-label:focus-visible,canvas:focus-visible{outline:3px solid var(--color-accent-primary);outline-offset:2px;box-shadow:0 0 0 1px var(--color-bg-primary)}.point-item:focus-within{outline:2px solid var(--color-accent-primary);outline-offset:1px}@media (pointer: coarse){button,.file-input-label,.delete-point-btn{min-height:44px;min-width:44px;padding:var(--spacing-md) var(--spacing-lg)}.delete-point-btn{min-width:44px;padding:var(--spacing-md)}.zoom-controls button{min-width:60px}}@supports (container-type: inline-size){.sidebar{container-type:inline-size}@container (max-width: 280px){.coordinates-display,.clicked-points,.path-info{padding:var(--spacing-md)}.point-item{flex-direction:column;align-items:flex-start;gap:var(--spacing-sm)}.delete-point-btn{align-self:flex-end}}}@media (hover: none){.file-input-label:active,button:active{transform:scale(.98)}}@media (orientation: portrait) and (max-width: 768px){.main-container{flex-direction:column}.canvas-container{min-height:50vh}.sidebar{max-height:50vh}}@media (orientation: landscape) and (max-height: 500px){.header{padding:var(--spacing-sm) var(--spacing-md)}.controls{gap:var(--spacing-md)}#sidebar-container{width:360px}.coordinates-display,.clicked-points,.path-info{padding:var(--spacing-md)}}@media print{.header,.status-message{display:none!important}.main-container{flex-direction:column;height:auto}.canvas-container,#sidebar-container{width:100%!important;max-width:none!important;box-shadow:none!important}#sidebar-container{border-top:2px solid #333;margin-top:var(--spacing-lg);page-break-before:auto}.coordinates-display,.clicked-points,.path-info{background:#f9f9f9!important;border:1px solid #ddd!important;color:#333!important}h3{color:#333!important}}\n/*$vite$:1*/',document.head.appendChild(t);const e="file:load:start",i="file:load:success",s="file:load:error",n="file:load:progress",o="file:cleared",a="gcode:parse:start",r="gcode:parse:success",l="gcode:parse:error",d="gcode:parse:progress",h="viewport:zoom:change",c="viewport:pan:change",u="viewport:reset",p="viewport:fit:screen",g="mouse:move",m="mouse:click",v="mouse:down",f="mouse:up",y="mouse:wheel",b="mouse:enter:canvas",x="mouse:leave:canvas",w="point:add",S="point:delete",_="point:update",E="point:clear:all",C="point:select",T="point:deselect",I="point:get:clicked",L="point:clicked:response",M="grid:snap:toggle",D="grid:visibility:toggle",P="ui:toolbar:toggle",k="ui:sidebar:toggle",z="ui:theme:change",O="ui:resize",A="key:down",R="key:up",H="key:shortcut",B="export:start",F="export:success",N="export:error",X="status:show",Y="status:hide",$="status:update",G="canvas:redraw",W="canvas:clear",q="canvas:resize",U="app:init",K="app:ready",V="app:destroy",Z={MOUSE:{screenX:"number",screenY:"number",worldX:"number",worldY:"number",button:"number",ctrlKey:"boolean",shiftKey:"boolean",altKey:"boolean",originalEvent:"Event"},VIEWPORT:{zoom:"number",offsetX:"number",offsetY:"number",bounds:"Object",canvasWidth:"number",canvasHeight:"number"},POINT:{id:"string",x:"number",y:"number",index:"number",metadata:"Object"},FILE:{name:"string",size:"number",type:"string",content:"string",progress:"number"},GCODE:{path:"Array",bounds:"Object",moveCount:"number",rapidCount:"number",cutCount:"number",arcCount:"number"},KEYBOARD:{key:"string",code:"string",ctrlKey:"boolean",shiftKey:"boolean",altKey:"boolean",metaKey:"boolean",originalEvent:"KeyboardEvent"},STATUS:{message:"string",type:"string",duration:"number",persistent:"boolean"},ERROR:{message:"string",error:"Error",context:"string",stack:"string"}};class j{static validate(t,e){const i=j.getSchema(t);if(!i)return{valid:!0,errors:[]};const s=[];if(null==e)return!1!==i.required&&s.push(`Event data is required for ${t}`),{valid:0===s.length,errors:s};for(const[n,o]of Object.entries(i)){if("required"===n)continue;const t=e[n],i=typeof t;void 0!==t&&("Array"!==o||Array.isArray(t)?"Object"!==o||"object"==typeof t&&null!==t&&!Array.isArray(t)?"Event"===o?t instanceof Event||"object"==typeof t&&null!==t&&(void 0!==t.type||void 0!==t.target||void 0!==t.currentTarget||void 0!==t.clientX||void 0!==t.clientY||void 0!==t.button||"function"==typeof t.preventDefault||"function"==typeof t.stopPropagation)||s.push(`Field '${n}' must be of type Event, got ${typeof t}`):"KeyboardEvent"===o?t instanceof KeyboardEvent||"object"==typeof t&&null!==t&&(void 0!==t.type||void 0!==t.target||void 0!==t.currentTarget||void 0!==t.key||void 0!==t.code||void 0!==t.keyCode||"function"==typeof t.preventDefault||"function"==typeof t.stopPropagation)||s.push(`Field '${n}' must be a KeyboardEvent object`):"Error"!==o||t instanceof Error?"string"==typeof o&&i!==o&&s.push(`Field '${n}' must be of type ${o}, got ${i}`):s.push(`Field '${n}' must be an Error object`):("bounds"===n&&console.debug("Bounds validation failed:",{field:n,expectedType:o,actualType:typeof t,isNull:null===t,isArray:Array.isArray(t),value:t}),s.push(`Field '${n}' must be an object, got ${Array.isArray(t)?"array":typeof t}`)):s.push(`Field '${n}' must be an array, got ${i}`),"number"!==o||isFinite(t)||s.push(`Field '${n}' must be a finite number`))}return{valid:0===s.length,errors:s}}static getSchema(t){return{[g]:Z.MOUSE,[m]:Z.MOUSE,[v]:Z.MOUSE,[f]:Z.MOUSE,[y]:Z.MOUSE,[b]:Z.MOUSE,[x]:Z.MOUSE,[h]:Z.VIEWPORT,[c]:Z.VIEWPORT,[u]:Z.VIEWPORT,[p]:Z.VIEWPORT,[w]:Z.POINT,[S]:Z.POINT,[_]:Z.POINT,[C]:Z.POINT,[T]:Z.POINT,[e]:Z.FILE,[i]:Z.FILE,[s]:Z.ERROR,[n]:Z.FILE,[a]:{required:!1},[r]:Z.GCODE,[l]:Z.ERROR,[d]:{progress:"number"},[A]:Z.KEYBOARD,[R]:Z.KEYBOARD,[H]:Z.KEYBOARD,[X]:Z.STATUS,[Y]:{required:!1},[$]:Z.STATUS,[G]:{required:!1},[W]:{required:!1},[q]:{width:"number",height:"number"}}[t]||null}}class J{constructor(t=document,e=()=>{}){this.root=t,this.emit=e,this._delegations=new Map}add(t,e,i,s){if("string"!=typeof t)throw new Error("Selector must be a string");if("string"!=typeof e)throw new Error("DOM event type must be a string");if("function"!=typeof s)throw new Error("Data extractor must be a function");const n=`${t}:${e}`;if(!this._delegations.has(n)){const i=e=>{const i=e.target?.closest?.(t);if(!i)return;const s=this._delegations.get(n);s&&s.handlers.forEach((t,s)=>{try{const n=t(e,i);this.emit(s,n)}catch(n){console.error("DOMDelegation: Error in delegated handler:",n)}})};this._delegations.set(n,{selector:t,eventType:e,listener:i,handlers:new Map}),this.root.addEventListener(e,i,!0)}return this._delegations.get(n).handlers.set(i,s),()=>{const t=this._delegations.get(n);t&&(t.handlers.delete(i),0===t.handlers.size&&(t.listener&&this.root.removeEventListener(t.eventType,t.listener,!0),this._delegations.delete(n)))}}size(){return this._delegations.size}clear(){this._delegations.forEach(t=>{t.listener&&this.root.removeEventListener(t.eventType,t.listener,!0)}),this._delegations.clear()}}class Q{constructor(t=100){this.maxHistorySize=t,this._events=[]}record(t,e,i){this._events.push({type:t,data:e,timestamp:Date.now(),listeners:i}),this._events.length>this.maxHistorySize&&this._events.shift()}getEvents(){return[...this._events]}clear(){this._events.length=0}}let tt=null;class et{static getInstance(){return tt||(tt=new it),tt}static setImplementation(t){tt&&"function"==typeof tt.destroy&&tt.destroy(),tt=t}static reset(){tt&&"function"==typeof tt.destroy&&tt.destroy(),tt=null}static on(t,e,i){return et.getInstance().on(t,e,i)}static once(t,e){return et.getInstance().once(t,e)}static off(t,e){return et.getInstance().off(t,e)}static emit(t,e,i){return et.getInstance().emit(t,e,i)}static delegate(t,e,i,s){return et.getInstance().delegate(t,e,i,s)}}class it{constructor(){this.listeners=new Map,this.onceListeners=new Map,this.isDestroyed=!1,this._history=new Q(100),this._domDelegation=new J(document,(t,e)=>{this.emit(t,e,{skipValidation:!0})}),this.listenerCount=0,this.eventCount=0}on(t,e,i={}){if(this._validateEventType(t),this._validateCallback(e),this.isDestroyed)return console.warn("EventManager: Cannot add listener to destroyed instance"),()=>{};const{once:s=!1,priority:n=0}=i,o=s?this.onceListeners:this.listeners;o.has(t)||o.set(t,new Set);const a={callback:e,priority:n,id:this._generateListenerId(),createdAt:Date.now()};return o.get(t).add(a),this.listenerCount++,()=>{o.get(t)?.delete(a),this.listenerCount--,0===o.get(t)?.size&&o.delete(t)}}once(t,e){return this.on(t,e,{once:!0})}off(t,e){this._validateEventType(t),this._validateCallback(e),[this.listeners,this.onceListeners].forEach(i=>{const s=i.get(t);if(s){for(const t of s)t.callback===e&&(s.delete(t),this.listenerCount--);0===s.size&&i.delete(t)}})}emit(t,e=null,i={}){if(this._validateEventType(t),this.isDestroyed)return void console.warn("EventManager: Cannot emit events from destroyed instance");const{async:s=!1,skipValidation:n=!1}=i;if(!n){const i=j.validate(t,e);i.valid||console.warn(`EventManager: Invalid event data for ${t}:`,i.errors)}this._recordEvent(t,e),this.eventCount++,s?setTimeout(()=>this._executeListeners(t,e),0):this._executeListeners(t,e)}delegate(t,e,i,s){return this._validateEventType(i),this._domDelegation.add(t,e,i,s)}getListeners(t){return this._validateEventType(t),[...Array.from(this.listeners.get(t)||[]),...Array.from(this.onceListeners.get(t)||[])].sort((t,e)=>e.priority-t.priority).map(t=>t.callback)}removeAllListeners(t){if(t){this._validateEventType(t);const e=this.listeners.get(t)?.size||0,i=this.onceListeners.get(t)?.size||0;this.listeners.delete(t),this.onceListeners.delete(t),this.listenerCount-=e+i}else this.listeners.clear(),this.onceListeners.clear(),this.listenerCount=0}destroy(){this.isDestroyed||(this.removeAllListeners(),this._domDelegation.clear(),this._history.clear(),this.isDestroyed=!0,console.debug("EventManager destroyed"))}getEventHistory(){return this._history.getEvents()}getStats(){return{listenerCount:this.listenerCount,eventCount:this.eventCount,eventTypes:{regular:this.listeners.size,once:this.onceListeners.size},delegations:this._domDelegation.size(),historySize:this._history.getEvents().length,isDestroyed:this.isDestroyed}}_executeListeners(t,e){const i=[],s=this.listeners.get(t);s&&i.push(...s);const n=this.onceListeners.get(t);n&&i.push(...n),i.sort((t,e)=>e.priority-t.priority),i.forEach(i=>{try{i.callback(e,t)}catch(s){console.error(`EventManager: Error in listener for ${t}:`,s)}}),n&&n.size>0&&(this.onceListeners.delete(t),this.listenerCount-=n.size)}_recordEvent(t,e){this._history.record(t,e,this.getListeners(t).length)}_validateEventType(t){if("string"!=typeof t)throw new Error("Event type must be a string");if(0===t.length)throw new Error("Event type cannot be empty")}_validateCallback(t){if("function"!=typeof t)throw new Error("Callback must be a function")}_generateListenerId(){return`listener_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}class st{static createMouseEventData(t,e){if(!t)throw new Error("DOM event is required");let i={x:0,y:0},s={x:0,y:0};if(e)if("function"==typeof e.getMouseCoordinates){const n=e.getMouseCoordinates(t);n&&(i=n.screen,s=n.world)}else console.warn("EventManager: Received viewport state instead of Viewport instance. Coordinate accuracy may be affected."),i.x=t.clientX,i.y=t.clientY,s.x=t.clientX,s.y=t.clientY;else i.x=t.clientX,i.y=t.clientY,s.x=t.clientX,s.y=t.clientY;return{screenX:i.x,screenY:i.y,worldX:s.x,worldY:s.y,button:t.button||0,ctrlKey:t.ctrlKey||!1,shiftKey:t.shiftKey||!1,altKey:t.altKey||!1,target:"canvas",originalEvent:t}}static createKeyboardEventData(t){if(!t)throw new Error("DOM event is required");return{key:t.key,code:t.code,ctrlKey:t.ctrlKey||!1,shiftKey:t.shiftKey||!1,altKey:t.altKey||!1,metaKey:t.metaKey||!1,originalEvent:t}}static throttle(t,e){return function(t,e){if("function"!=typeof t)throw new Error("First argument must be a function");if("number"!=typeof e||e<0)throw new Error("Delay must be a non-negative number");let i=!1,s=null;return function(...n){i?s=n:(t.apply(this,n),i=!0,setTimeout(()=>{i=!1,s&&(t.apply(this,s),s=null)},e))}}(t,e)}static debounce(t,e){return function(t,e){if("function"!=typeof t)throw new Error("First argument must be a function");if("number"!=typeof e||e<0)throw new Error("Delay must be a non-negative number");let i=null;return function(...s){i&&clearTimeout(i),i=setTimeout(()=>{t.apply(this,s),i=null},e)}}(t,e)}static rateLimit(t,e,i){return function(t,e,i){if("function"!=typeof t)throw new Error("First argument must be a function");const s=[];return function(...n){const o=Date.now();for(;s.length>0&&s[0]<=o-i;)s.shift();if(s.length<e)return s.push(o),t.apply(this,n);console.debug(`Rate limit exceeded: ${e} calls per ${i}ms`)}}(t,e,i)}static deduplicate(t,e=50,i=null){return function(t,e=50,i=null){if("function"!=typeof t)throw new Error("First argument must be a function");const s=new Map;return function(...n){const o=Date.now(),a=i?i(...n):JSON.stringify(n),r=s.get(a);if(!r||o-r>e){if(s.set(a,o),s.size>100)for(const[t,i]of s.entries())o-i>2*e&&s.delete(t);return t.apply(this,n)}}}(t,e,i)}}const nt=5,ot={MINOR:"#2a2a2a",MAJOR:"#555",LABELS:"#666"},at={MINOR:.25,MAJOR:1},rt=1,lt=1e-6,dt=1e6,ht=1.2,ct=.1,ut=50,pt=50,gt={MIN_FACTOR:.001,MAX_FACTOR:1e3},mt="crosshair",vt="move",ft={RAPID:{COLOR:"#ffff00",LINE_WIDTH_PX:1,LINE_DASH_PX:[4,3]},CUT:{COLOR:"#00ff00",LINE_WIDTH_PX:1.6,LINE_DASH_PX:[]},ARC:{COLOR:"#00ff00",LINE_WIDTH_PX:1.6,LINE_DASH_PX:[]}},yt={COLOR:"#ff0000",RADIUS_PX:4,LABEL:"START",FONT:"bold 10px Arial",OFFSET:{X:6,Y:-6}},bt={COLOR:"#0000ff",RADIUS_PX:3,LABEL:"END",FONT:"bold 4px Arial",OFFSET:{X:5,Y:-5}},xt={COLOR:"#ff00ff",RADIUS_PX:3,FONT:"4px Arial",OFFSET:{X:4,Y:-4}},wt=[".gcode",".nc",".txt",".iso"],St=52428800,_t={DURATION:3e3,COLORS:{SUCCESS:"#4CAF50",ERROR:"#f44336",WARNING:"#ff9800",INFO:"#2196F3"},POSITION:{TOP:"20px",RIGHT:"20px",LEFT:"20px",BOTTOM:"20px"}},Et={COMMENT_PREFIXES:[";","(","%"],LINEAR_MOVES:["G0","G1"],ARC_MOVES:["G2","G3"],COORDINATE_PARAMS:["X","Y","Z","I","J","K"],DEFAULT_PRECISION:3},Ct={EXTENSION:".gcode",MIME_TYPE:"text/plain",HEADER_COMMENT:"; Exported points from Wire EDM G-Code Viewer",DATE_FORMAT:"YYYY-MM-DD HH:mm:ss"},Tt={EXTENSION:".iso",MIME_TYPE:"text/plain"},It={FAST:150,NORMAL:300,SLOW:500,EASE:"cubic-bezier(0.4, 0.0, 0.2, 1)"},Lt=3,Mt={STEPS:[1,2,5],TARGET_MINOR_PX:12,MINOR_VISIBILITY_PX:3,TARGET_LABEL_PX:80,LABEL_VISIBILITY_PX:50,HYSTERESIS:{GRID_PX:.5,LABEL_PX:10}};class Dt{static screenToWorld(t,e,i,s,n,o){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const a=(t-s)/i,r=(o-e-n)/i;return{x:zt.round(a,Lt),y:zt.round(r,Lt)}}static worldToScreen(t,e,i,s,n,o){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const a=t*i+s,r=o-(e*i+n);return{x:Math.round(100*a)/100,y:Math.round(100*r)/100}}static applyTransform(t,e,i,s,n){t.setTransform(1,0,0,1,0,0),t.translate(i,n-s),t.scale(e,-e)}static worldToScreenTextSpace(t,e,i,s,n){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const o=t*i+s,a=e*i+n;return{x:Math.round(100*o)/100,y:Math.round(100*a)/100}}static screenToWorldTextSpace(t,e,i,s,n){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const o=(t-s)/i,a=(e-n)/i;return{x:zt.round(o,Lt),y:zt.round(a,Lt)}}}class Pt{static distance(t,e,i,s){const n=i-t,o=s-e;return Math.sqrt(n*n+o*o)}static angleRadians(t,e,i,s){return Math.atan2(s-e,i-t)}static angleDegrees(t,e,i,s){return Pt.angleRadians(t,e,i,s)*(180/Math.PI)}static midpoint(t,e,i,s){return{x:(t+i)/2,y:(e+s)/2}}}class kt{static snapToGrid(t,e){return Math.round(t/e)*e}static snapPointToGrid(t,e,i){return{x:kt.snapToGrid(t,i),y:kt.snapToGrid(e,i)}}static pickGridSpacing(t,e=Mt.TARGET_MINOR_PX){const i=e/t,s=Math.pow(10,Math.floor(Math.log10(i)));for(const n of Mt.STEPS){const t=n*s;if(t>=i)return t}return 10*s}static pickLabelSpacing(t,e,i=Mt.TARGET_LABEL_PX){const s=i/e,n=Math.ceil(s/t),o=Math.pow(10,Math.floor(Math.log10(n))),a=[1,2,5];for(const r of a){const e=r*o;if(e>=n)return e*t}return 10*o*t}static calculateGridLines(t,e,i,s,n,o){const a=-e/t,r=(s-e)/t,l=-i/t,d=(n-i)/t,h=Math.ceil(a/o),c=Math.floor(r/o),u=Math.ceil(l/o),p=Math.floor(d/o),g=[],m=[],v=[],f=[];for(let y=h;y<=c;y++)g.push(y*o),v.push(y);for(let y=u;y<=p;y++)m.push(y*o),f.push(y);return{vertical:g,horizontal:m,verticalIndices:v,horizontalIndices:f}}}class zt{static round(t,e=Lt){const i=Math.pow(10,e);return Math.round(t*i)/i}static format(t,e=Lt){return zt.round(t,e).toFixed(e)}static approximately(t,e,i=1e-10){return Math.abs(t-e)<i}}class Ot{static isValidCoordinate(t){return"number"==typeof t&&isFinite(t)&&!isNaN(t)}static isValidPoint(t){return t&&Ot.isValidCoordinate(t.x)&&Ot.isValidCoordinate(t.y)}static sanitizeCoordinate(t,e=0){const i=parseFloat(t);return Ot.isValidCoordinate(i)?i:e}}class At{static createEmptyBounds(){return{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}}static updateBounds(t,e,i){return{minX:Math.min(t.minX,e),maxX:Math.max(t.maxX,e),minY:Math.min(t.minY,i),maxY:Math.max(t.maxY,i)}}static isValidBounds(t){return isFinite(t.minX)&&isFinite(t.maxX)&&isFinite(t.minY)&&isFinite(t.maxY)}static getBoundsDimensions(t){return At.isValidBounds(t)?{width:t.maxX-t.minX,height:t.maxY-t.minY,centerX:(t.minX+t.maxX)/2,centerY:(t.minY+t.maxY)/2}:{width:0,height:0,centerX:0,centerY:0}}static expandBounds(t,e){return{minX:t.minX-e,maxX:t.maxX+e,minY:t.minY-e,maxY:t.maxY+e}}}class Rt{static calculateArcParameters(t,e,i,s,n,o,a){const r=Pt.distance(t,e,n,o),l=Math.atan2(e-o,t-n),d=Math.atan2(s-o,i-n);let h=d-l;return a?h>0&&(h-=2*Math.PI):h<0&&(h+=2*Math.PI),{radius:r,startAngle:l,endAngle:d,angleSpan:Math.abs(h)}}static pointOnArc(t,e,i,s){return{x:t+i*Math.cos(s),y:e+i*Math.sin(s)}}static calculateArcBounds(t,e,i,s,n,o,a){const{radius:r,startAngle:l,endAngle:d}=Rt.calculateArcParameters(t,e,i,s,n,o,a);let h=At.createEmptyBounds();h=At.updateBounds(h,t,e),h=At.updateBounds(h,i,s);const c=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(const u of c)if(Rt.angleInArcSpan(u,l,d,a)){const t=Rt.pointOnArc(n,o,r,u);h=At.updateBounds(h,t.x,t.y)}return h}static angleInArcSpan(t,e,i,s){const n=t=>{for(;t<0;)t+=2*Math.PI;for(;t>=2*Math.PI;)t-=2*Math.PI;return t},o=n(e),a=n(i),r=n(t);return s?o>=a?r<=o&&r>=a:r<=o||r>=a:o<=a?r>=o&&r<=a:r>=o||r<=a}}class Ht{constructor(t){this.canvas=t,this.displayWidth=800,this.displayHeight=600,this.gridSnapEnabled=!1,this.gridSnapSize=1,this.minZoom=lt,this.maxZoom=dt,this.reset()}_updateDisplayDimensions(){this.displayWidth=this.canvas.clientWidth||this.canvas.width,this.displayHeight=this.canvas.clientHeight||this.canvas.height,(this.displayWidth<=0||this.displayHeight<=0)&&(console.warn("Viewport: Invalid canvas dimensions detected, using fallback values"),this.displayWidth=this.displayWidth||800,this.displayHeight=this.displayHeight||600)}reset(){this.zoom=rt,this._updateDisplayDimensions(),this.offsetX=this.displayWidth/2,this.offsetY=this.displayHeight/2,this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.minZoom=lt,this.maxZoom=dt}getState(){return{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY,isDragging:this.isDragging,bounds:this.getBounds()}}setState(t){void 0!==t.zoom&&(this.zoom=this.clampZoom(t.zoom)),void 0!==t.offsetX&&(this.offsetX=t.offsetX),void 0!==t.offsetY&&(this.offsetY=t.offsetY),void 0!==t.isDragging&&(this.isDragging=t.isDragging)}getBounds(){const t=this.screenToWorld(0,0),e=this.screenToWorld(this.displayWidth,this.displayHeight);return{minX:t.x,maxX:e.x,minY:e.y,maxY:t.y}}clampZoom(t){const e=this.minZoom??lt,i=this.maxZoom??dt;return Math.max(e,Math.min(i,t))}screenToWorld(t,e){return Dt.screenToWorld(t,e,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}worldToScreen(t,e){return Dt.worldToScreen(t,e,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}applyTransform(t){Dt.applyTransform(t,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}getMouseCoordinates(t,e=!1,i=1){const s=this.canvas.getBoundingClientRect();let n=t.clientX-s.left,o=t.clientY-s.top;this.canvas.width===s.width&&this.canvas.height===s.height||(n*=this.canvas.width/s.width,o*=this.canvas.height/s.height);let a=this.screenToWorld(n,o);if(!this.isValidCoordinate(a.x)||!this.isValidCoordinate(a.y))return null;const r=e||this.gridSnapEnabled,l=i||this.gridSnapSize||1;return r&&(a=kt.snapPointToGrid(a.x,a.y,l)),{screen:{x:n,y:o},world:a}}setGridSnap(t,e=null){this.gridSnapEnabled=!!t,"number"==typeof e&&isFinite(e)&&e>0&&(this.gridSnapSize=e)}isValidCoordinate(t){return!isNaN(t)&&isFinite(t)}debugCoordinateConversion(t){const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,n=this.screenToWorld(i,s),o=this.worldToScreen(n.x,n.y),a=Math.abs(i-o.x),r=Math.abs(s-o.y);return{originalScreen:{x:i,y:s},worldCoords:n,backToScreen:o,coordinateError:{x:a,y:r},accuracy:a<.1&&r<.1?"GOOD":"POOR",dimensionConsistency:this.displayWidth===this.canvas.clientWidth&&this.displayHeight===this.canvas.clientHeight,coordinateSystemInfo:{usingDisplayHeight:this.displayHeight,canvasClientHeight:this.canvas.clientHeight,canvasHeight:this.canvas.height,heightConsistency:this.displayHeight===this.canvas.clientHeight,transformParameters:{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY}},coordinateSystemValidation:this.validateCoordinateSystem(),mouseCoordinateScaling:{scaleX:this.canvas.width/e.width,scaleY:this.canvas.height/e.height,isScaled:this.canvas.width!==e.width||this.canvas.height!==e.height},dimensions:{displayWidth:this.displayWidth,displayHeight:this.displayHeight,canvasWidth:this.canvas.width,canvasHeight:this.canvas.height,clientWidth:this.canvas.clientWidth,clientHeight:this.canvas.clientHeight,cssWidth:e.width,cssHeight:e.height},validation:{heightSync:this.displayHeight===this.canvas.height,widthSync:this.displayWidth===this.canvas.width,canvasToDisplaySync:this.displayHeight===this.canvas.height&&this.displayWidth===this.canvas.width?"SYNCED":"MISMATCHED",canvasToCssSync:this.canvas.width===e.width&&this.canvas.height===e.height?"SYNCED":"SCALED"}}}validateCoordinateSystem(){const t=[],e=[];return this.displayHeight!==this.canvas.clientHeight&&t.push(`Height mismatch: displayHeight=${this.displayHeight}, clientHeight=${this.canvas.clientHeight}`),this.displayWidth!==this.canvas.clientWidth&&t.push(`Width mismatch: displayWidth=${this.displayWidth}, clientWidth=${this.canvas.clientWidth}`),(this.displayWidth<=0||this.displayHeight<=0)&&t.push(`Invalid dimensions: ${this.displayWidth}x${this.displayHeight}`),this.canvas.width===this.canvas.clientWidth&&this.canvas.height===this.canvas.clientHeight||e.push("Canvas buffer size differs from display size - High-DPI or scaling detected"),{isValid:0===t.length,issues:t,warnings:e,dimensions:{display:{width:this.displayWidth,height:this.displayHeight},client:{width:this.canvas.clientWidth,height:this.canvas.clientHeight},buffer:{width:this.canvas.width,height:this.canvas.height}}}}logCoordinateSystemStatus(){const t=this.validateCoordinateSystem(),e=this.canvas.getBoundingClientRect();console.group("🎯 Coordinate System Status"),console.log("Validation Result:",t.isValid?"✅ VALID":"❌ INVALID"),t.issues.length>0&&(console.warn("Issues found:"),t.issues.forEach(t=>console.warn("- "+t))),t.warnings.length>0&&(console.info("Warnings:"),t.warnings.forEach(t=>console.info("- "+t))),console.table({"Display Dimensions":{width:this.displayWidth,height:this.displayHeight},"Canvas Buffer":{width:this.canvas.width,height:this.canvas.height},"Canvas CSS":{width:this.canvas.clientWidth,height:this.canvas.clientHeight},"Actual CSS":{width:e.width,height:e.height}});const i=this.canvas.width/e.width,s=this.canvas.height/e.height;console.log("Mouse Coordinate Scaling:",{scaleX:i,scaleY:s,isScaled:1!==i||1!==s}),console.log("Viewport State:",{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY}),console.groupEnd()}zoomIn(){this.zoom=this.clampZoom(this.zoom*ht)}zoomOut(){this.zoom=this.clampZoom(this.zoom/ht)}setZoom(t){this.zoom=this.clampZoom(t)}zoomAtPoint(t,e,i){const s=this.screenToWorld(t,e),n=i>0?1+ct:1-ct;this.zoom=this.clampZoom(this.zoom*n),this.offsetX=t-s.x*this.zoom,this.offsetY=e-s.y*this.zoom}startDrag(t,e){this.isDragging=!0,this.dragStartX=t-this.offsetX,this.dragStartY=e+this.offsetY,this.canvas.style.cursor=vt}updateDrag(t,e){this.isDragging&&(this.offsetX=t-this.dragStartX,this.offsetY=this.dragStartY-e)}endDrag(){this.isDragging=!1,this.canvas.style.cursor=mt}fitToBounds(t,e=ut){const{minX:i,maxX:s,minY:n,maxY:o}=t;if(!(this.isValidCoordinate(i)&&this.isValidCoordinate(s)&&this.isValidCoordinate(n)&&this.isValidCoordinate(o)))return void console.error("Invalid bounds for fitToBounds:",t);const a=s-i,r=o-n;if(0===a||0===r)return this.zoom=rt,this.offsetX=this.displayWidth/2,void(this.offsetY=this.displayHeight/2);const l=this.displayWidth,d=this.displayHeight,h=(l-2*e)/a,c=(d-2*e)/r,u=Math.min(h,c),p=gt?.MIN_FACTOR,g=gt?.MAX_FACTOR;this.minZoom=Math.max(lt,u*p),this.maxZoom=Math.min(dt,u*g),this.zoom=this.clampZoom(u);const m=(i+s)/2,v=(n+o)/2;this.offsetX=l/2-m*this.zoom,this.offsetY=d/2+v*this.zoom}onCanvasResize(){0===this.offsetX&&(this.offsetX=this.displayWidth/2),0===this.offsetY&&(this.offsetY=this.displayHeight/2)}getZoomPercentage(){return Math.round(100*this.zoom)+"%"}isPointVisible(t,e){const i=this.worldToScreen(t,e);return i.x>=0&&i.x<=this.displayWidth&&i.y>=0&&i.y<=this.displayHeight}pan(t,e){this.offsetX+=t,this.offsetY+=e}}let Bt,Ft;function Nt(t,e,i={}){const s=i.displayWidth,n=i.displayHeight,o=i.devicePixelRatio||1,a=e.getState(),r=kt.pickGridSpacing(a.zoom,Mt.TARGET_MINOR_PX),l=kt.pickLabelSpacing(r,a.zoom,Mt.TARGET_LABEL_PX),d=r*a.zoom,h=l*a.zoom,c=Mt.HYSTERESIS&&Mt.HYSTERESIS.GRID_PX||0,u=Mt.HYSTERESIS&&Mt.HYSTERESIS.LABEL_PX||0;let p,g;if("boolean"==typeof Bt){const t=Mt.MINOR_VISIBILITY_PX;p=Bt?d>=t-c:d>=t+c}else p=d>=Mt.MINOR_VISIBILITY_PX;if("boolean"==typeof Ft){const t=Mt.LABEL_VISIBILITY_PX;g=Ft?h>=t-u:h>=t+u}else g=h>=Mt.LABEL_VISIBILITY_PX;Bt=p,Ft=g;const m=kt.calculateGridLines(a.zoom,a.offsetX,a.offsetY,s,n,r);p&&Xt(t,e,m,!1,o),Xt(t,e,m,!0,o),g&&function(t,e,i,s={}){const{vertical:n,horizontal:o,verticalIndices:a,horizontalIndices:r}=i,l=s.displayHeight,d=s.labelSpacing,h=s.minorSpacing,c=Math.max(0,-Math.floor(Math.log10(d))),u=Math.round(d/h);t.save(),t.setTransform(1,0,0,1,0,0);const p=s.devicePixelRatio||1;p>1&&t.scale(p,p),t.fillStyle=ot.LABELS,t.font="9px Arial",t.textAlign="left",t.textBaseline="top",n.forEach((i,s)=>{if(a[s]%u===0&&0!==i){const s=e.worldToScreen(i,0);t.fillText(zt.format(i,c),s.x+2,l-15)}}),o.forEach((i,s)=>{if(r[s]%u===0&&0!==i){const s=e.worldToScreen(0,i);t.fillText(zt.format(i,c),5,s.y-2)}}),t.restore()}(t,e,m,{displayHeight:n,devicePixelRatio:o,labelSpacing:l,minorSpacing:r})}function Xt(t,e,i,s,n,o){const{vertical:a,horizontal:r}=i,l=e.getBounds(),{minX:d,maxX:h,minY:c,maxY:u}=l,p=t=>t/(n*e.zoom);s?(t.strokeStyle=ot.MAJOR,t.lineWidth=p(at.MAJOR)):(t.strokeStyle=ot.MINOR,t.lineWidth=p(at.MINOR)),t.setLineDash([]),s?(t.beginPath(),t.moveTo(d,0),t.lineTo(h,0),t.moveTo(0,c),t.lineTo(0,u),t.stroke()):(t.beginPath(),a.forEach(e=>{0!==e&&(t.moveTo(e,c),t.lineTo(e,u))}),t.stroke(),t.beginPath(),r.forEach(e=>{0!==e&&(t.moveTo(d,e),t.lineTo(h,e))}),t.stroke())}function Yt(t){return t?"arc"===t.type?Ot.isValidCoordinate(t.endX)&&Ot.isValidCoordinate(t.endY)?{x:t.endX,y:t.endY}:null:Ot.isValidCoordinate(t.x)&&Ot.isValidCoordinate(t.y)?{x:t.x,y:t.y}:null:null}function $t(t,e,i,s,n){if(!Ot.isValidPoint(i)||!Ot.isValidPoint(s))return;const o="rapid"===s.type?ft.RAPID:ft.CUT,a=t=>t/(n*e.zoom);t.strokeStyle=o.COLOR,t.lineWidth=a(o.LINE_WIDTH_PX);const r=o.LINE_DASH_PX??[];t.setLineDash(Array.isArray(r)&&r.length?r.map(a):[]),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke()}function Gt(t,e,i,s){if(!function(t){return t&&Ot.isValidCoordinate(t.startX)&&Ot.isValidCoordinate(t.startY)&&Ot.isValidCoordinate(t.endX)&&Ot.isValidCoordinate(t.endY)&&Ot.isValidCoordinate(t.centerX)&&Ot.isValidCoordinate(t.centerY)}(i))return;const n=t=>t/(s*e.zoom);t.strokeStyle=ft.ARC.COLOR,t.lineWidth=n(ft.ARC.LINE_WIDTH_PX);const o=ft.ARC.LINE_DASH_PX??[];t.setLineDash(Array.isArray(o)?o.map(n):[]);const a=Math.sqrt(Math.pow(i.startX-i.centerX,2)+Math.pow(i.startY-i.centerY,2)),r=Math.atan2(i.startY-i.centerY,i.startX-i.centerX);let l=Math.atan2(i.endY-i.centerY,i.endX-i.centerX)-r;i.clockwise?l>=0&&(l-=2*Math.PI):l<=0&&(l+=2*Math.PI);const d=r+l;t.beginPath(),t.arc(i.centerX,i.centerY,a,r,d,i.clockwise),t.stroke()}function Wt(t,e,i,s,n=1){const o=(s.RADIUS_PX??3)/((n||1)*e.zoom);if(t.fillStyle=s.COLOR,t.beginPath(),t.arc(i.x,i.y,o,0,2*Math.PI),t.fill(),s.LABEL){t.save(),t.setTransform(1,0,0,1,0,0),n>1&&t.scale(n,n);const o=e.worldToScreen(i.x,i.y),a=s.OFFSET?.X??0,r=s.OFFSET?.Y??0;t.fillStyle=s.COLOR,t.font=s.FONT||"10px Arial",t.textAlign="left",t.textBaseline="top",t.fillText(s.LABEL,o.x+a,o.y+r),t.restore()}}class qt{constructor(t,e={}){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas constructor requires a valid HTMLCanvasElement");this.canvas=t,this.ctx=t.getContext("2d"),this.options={...this._getDefaultOptions(),...e},this.viewport=new Ht(this.canvas),this.isInitialized=!1,this.isDestroyed=!1,this.renderRequestId=null,this.devicePixelRatio=1,this.enableHighDPI=this.options.enableHighDPI,this.physicalWidth=0,this.physicalHeight=0,this.logicalWidth=0,this.logicalHeight=0,this.gcodePath=[],this.clickedPoints=[],this.hoverHighlight=null,this.persistentHighlights=new Set,this.gridEnabled=this.options.showGrid,this.gridSize=this.options.gridSize,this._bindMethods()}_getDefaultOptions(){return{showGrid:!0,gridSize:nt,enableHighDPI:!1,autoResize:!0,throttleRedraw:!0}}_bindMethods(){this.redraw=this.redraw.bind(this),this._handleResize=this._handleResize.bind(this)}async init(){if(this.isInitialized)console.warn("Canvas already initialized");else try{this._setupCanvas(),this._setupEventListeners(),this.redraw(),this.isInitialized=!0}catch(t){throw new Error(`Failed to initialize Canvas: ${t.message}`)}}_setupCanvas(){this.canvas.style.cursor=mt,this._resizeCanvas()}_setupEventListeners(){this.options.autoResize&&window.addEventListener("resize",this._handleResize)}_handleResize(){this._resizeCanvas(),this.redraw()}_resizeCanvas(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect();this.logicalWidth=Math.round(e.width),this.logicalHeight=Math.round(e.height),this.enableHighDPI?(this.devicePixelRatio=window.devicePixelRatio||1,this.physicalWidth=Math.round(this.logicalWidth*this.devicePixelRatio),this.physicalHeight=Math.round(this.logicalHeight*this.devicePixelRatio),this.canvas.width=this.physicalWidth,this.canvas.height=this.physicalHeight,this.canvas.style.width=this.logicalWidth+"px",this.canvas.style.height=this.logicalHeight+"px",console.log(`High-DPI: Logical(${this.logicalWidth}x${this.logicalHeight}) Physical(${this.physicalWidth}x${this.physicalHeight}) DPR(${this.devicePixelRatio})`)):(this.devicePixelRatio=1,this.physicalWidth=this.logicalWidth,this.physicalHeight=this.logicalHeight,this.canvas.width=this.logicalWidth,this.canvas.height=this.logicalHeight),this.displayWidth=this.logicalWidth,this.displayHeight=this.logicalHeight,this._configureCanvasQuality(),this.viewport.displayWidth=this.logicalWidth,this.viewport.displayHeight=this.logicalHeight,this.viewport.onCanvasResize(),this._validateDimensionConsistency()}_configureCanvasQuality(){this.ctx.setTransform(1,0,0,1,0,0),this.enableHighDPI&&this.devicePixelRatio>1&&this.ctx.scale(this.devicePixelRatio,this.devicePixelRatio),this.ctx.imageSmoothingEnabled=!0,this.ctx.lineCap="round",this.ctx.lineJoin="round"}setGCodePath(t){if(!Array.isArray(t))throw new Error("Path data must be an array");this.gcodePath=t,this.redraw()}setClickedPoints(t){if(!Array.isArray(t))throw new Error("Points data must be an array");this.clickedPoints=t,this.redraw()}setGridEnabled(t){this.gridEnabled=!!t,this.redraw()}setGridSize(t){if(!Ot.isValidCoordinate(t)||t<=0)throw new Error("Grid size must be a positive number");this.gridSize=t,this.gridEnabled&&this.redraw()}redraw(){if(!this.isDestroyed)if(this.options.throttleRedraw){if(this.renderRequestId)return;this.renderRequestId=requestAnimationFrame(()=>{this._performRender(),this.renderRequestId=null})}else this._performRender()}_performRender(){try{t=this.ctx,e=this.physicalWidth,i=this.physicalHeight,t.clearRect(0,0,e,i),this.ctx.save(),function(t,e,i=1){const s=e.getState();t.setTransform(1,0,0,1,0,0),i>1&&t.scale(i,i),t.translate(s.offsetX,e.displayHeight-s.offsetY),t.scale(s.zoom,-s.zoom)}(this.ctx,this.viewport,this.devicePixelRatio),this.gridEnabled&&Nt(this.ctx,this.viewport,{gridSize:this.gridSize,displayWidth:this.displayWidth,displayHeight:this.displayHeight,devicePixelRatio:this.devicePixelRatio}),this.gcodePath.length>0&&(function(t,e,i,s={}){if(!Array.isArray(i)||0===i.length)return;const n=s.devicePixelRatio||1,o=s.hoverHighlight||null,a=s.persistentHighlights||new Set,r="function"==typeof s.markerRenderer?s.markerRenderer:null;for(let l=0;l<i.length;l++){if(0===l)continue;const s=i[l],d=i[l-1];if("arc"===s?.type)Gt(t,e,s,n);else{const i=Yt(d),o={x:s.x,y:s.y,type:s.type};i&&Ot.isValidPoint(i)&&Ot.isValidPoint(o)&&$t(t,e,i,o,n)}if((a.has(l)||o&&"point"===o.type&&o.index===l)&&r){const t="arc"===s.type?s.endX:s.x,e="arc"===s.type?s.endY:s.y;void 0!==t&&void 0!==e&&r({x:t,y:e},{...xt,COLOR:"#ffa500",RADIUS_PX:3,FONT:"bold 10px Arial",LABEL:`L${s.line||l}`})}}}(this.ctx,this.viewport,this.gcodePath,{devicePixelRatio:this.devicePixelRatio,hoverHighlight:this.hoverHighlight,persistentHighlights:this.persistentHighlights,markerRenderer:(t,e)=>Wt(this.ctx,this.viewport,t,e,this.devicePixelRatio)}),function(t,e,i,s={}){const n="function"==typeof s.markerRenderer?s.markerRenderer:null;if(!Array.isArray(i)||0===i.length||!n)return;const o=i[0];if(Ot.isValidPoint(o)&&n(o,yt),i.length>1){const t=i[i.length-1];Ot.isValidPoint(t)&&n(t,bt)}}(this.ctx,this.viewport,this.gcodePath,{markerRenderer:(t,e)=>Wt(this.ctx,this.viewport,t,e,this.devicePixelRatio)})),this.clickedPoints.length>0&&function(t,e,i,s={}){const n=s.devicePixelRatio||1;i.forEach((i,s)=>{if(!i||!isFinite(i.x)||!isFinite(i.y))return;const o={...xt,LABEL:`P${s+1}`};Wt(t,e,i,o,n)})}(this.ctx,this.viewport,this.clickedPoints,{devicePixelRatio:this.devicePixelRatio}),this.ctx.restore()}catch(s){console.error("Error during canvas render:",s)}var t,e,i}fitToContent(){if(0===this.gcodePath.length)return;const t=this._calculateContentBounds();t&&(this.viewport.fitToBounds(t),this.redraw())}_calculateContentBounds(){if(0===this.gcodePath.length)return null;let t=1/0,e=-1/0,i=1/0,s=-1/0;return this.gcodePath.forEach(n=>{Ot.isValidPoint(n)&&(t=Math.min(t,n.x),e=Math.max(e,n.x),i=Math.min(i,n.y),s=Math.max(s,n.y))}),this.clickedPoints.forEach(n=>{Ot.isValidPoint(n)&&(t=Math.min(t,n.x),e=Math.max(e,n.x),i=Math.min(i,n.y),s=Math.max(s,n.y))}),isFinite(t)?{minX:t,maxX:e,minY:i,maxY:s}:null}getViewportState(){return this.viewport.getState()}getViewport(){return this.viewport}clearClickedPoints(){this.clickedPoints=[],this.redraw()}addClickedPoint(t){if(!Ot.isValidPoint(t))throw new Error("Invalid point coordinates");this.clickedPoints.push({...t}),this.redraw()}setHoverHighlight(t){this.hoverHighlight="number"==typeof t?{type:"point",index:t}:null,this.redraw()}togglePersistentHighlight(t){this.persistentHighlights.has(t)?this.persistentHighlights.delete(t):this.persistentHighlights.add(t),this.redraw()}setHighDPIEnabled(t){this.enableHighDPI!==t&&(this.enableHighDPI=t,console.log("High-DPI "+(t?"enabled":"disabled")),this._resizeCanvas(),this.redraw())}getHighDPIStatus(){return{enabled:this.enableHighDPI,devicePixelRatio:this.devicePixelRatio,logicalSize:{width:this.logicalWidth,height:this.logicalHeight},physicalSize:{width:this.physicalWidth,height:this.physicalHeight}}}_validateDimensionConsistency(){const t=[];this.viewport.displayWidth!==this.logicalWidth&&t.push(`Width mismatch: viewport.displayWidth=${this.viewport.displayWidth}, canvas.logicalWidth=${this.logicalWidth}`),this.viewport.displayHeight!==this.logicalHeight&&t.push(`Height mismatch: viewport.displayHeight=${this.viewport.displayHeight}, canvas.logicalHeight=${this.logicalHeight}`),this.enableHighDPI?this.canvas.width===this.physicalWidth&&this.canvas.height===this.physicalHeight||t.push(`Canvas buffer mismatch (High-DPI): canvas=${this.canvas.width}x${this.canvas.height}, physical=${this.physicalWidth}x${this.physicalHeight}`):this.canvas.width===this.logicalWidth&&this.canvas.height===this.logicalHeight||t.push(`Canvas buffer mismatch (Standard): canvas=${this.canvas.width}x${this.canvas.height}, logical=${this.logicalWidth}x${this.logicalHeight}`),t.length>0&&(console.error("Canvas dimension consistency issues detected:"),t.forEach(t=>console.error("- "+t)),console.error("This will cause coordinate accuracy problems!"),this.viewport.displayHeight!==this.logicalHeight&&(console.error("❌ CRITICAL: Height mismatch detected! This causes ~4mm coordinate offset after G-code loading."),console.error("Canvas transformation uses this.logicalHeight:",this.logicalHeight),console.error("Coordinate conversion uses viewport.displayHeight:",this.viewport.displayHeight),console.error("These MUST match for accurate coordinates!")))}destroy(){this.isDestroyed||(this.renderRequestId&&(cancelAnimationFrame(this.renderRequestId),this.renderRequestId=null),this.options.autoResize&&window.removeEventListener("resize",this._handleResize),this.gcodePath=[],this.clickedPoints=[],this.isDestroyed=!0)}}class Ut{static VERSION="1.0.0";static SUPPORTED_COMMANDS={LINEAR:["G0","G1"],ARC:["G2","G3"]};static REGEX={COORDINATE:/([XYZ])(-?\d+\.?\d*)/g,ARC_CENTER:/([IJ])(-?\d+\.?\d*)/g,COMMENT:/[;(].*$/,LEADING_BLOCK_NUMBER:/^N\d+\s+/i};constructor(t={}){this.options={precision:Lt,strictMode:!1,ignoreErrors:!0,...t},this._reset()}_reset(){this.currentPosition={x:0,y:0},this.path=[],this.bounds=At.createEmptyBounds(),this.errors=[],this.warnings=[],this.g92Applied=!1,this.g92Line=null,this.g92AssumedZero=!1,this.ijAbsolute=!1,this.stats={totalLines:0,processedLines:0,linearMoves:0,arcMoves:0,comments:0,errors:0}}parse(t){if("string"!=typeof t)throw new Error("G-Code input must be a string");this._reset();const e=t.split(/\r?\n/);this.stats.totalLines=e.length;for(let s=0;s<e.length;s++)try{this._parseLine(e[s],s+1)}catch(i){if(this._handleError(i,s+1),this.options.strictMode)throw i}return this._validateResult(),{path:this.path,bounds:this.bounds,stats:this.stats,errors:this.errors,warnings:this.warnings}}_parseLine(t,e){if(t=t.trim().toUpperCase(),""===(t=this._normalizeMotionCodes(t)))return;if(this._isComment(t))return void this.stats.comments++;if(""===(t=(t=this._removeInlineComments(t)).replace(Ut.REGEX.LEADING_BLOCK_NUMBER,"")))return;if(this.stats.processedLines++,/\bG92\b/.test(t))return this._parseG92(t,e),void((this._isLinearMove(t)||this._isArcMove(t))&&this._addWarning(`Line ${e}: G92 must be alone on its line; ignoring additional commands.`,e));let i=!1;/\bG60\b/.test(t)&&(this.ijAbsolute=!0,i=!0),/\bG90\.1\b/.test(t)&&(this.ijAbsolute=!0,i=!0),/\bG91\.1\b/.test(t)&&(this.ijAbsolute=!1,i=!0),this._isLinearMove(t)?this._parseLinearMove(t,e):this._isArcMove(t)?this._parseArcMove(t,e):i||this._addWarning(`Unknown G-Code command: ${t}`,e)}_normalizeMotionCodes(t){return t.replace(/\bG0+([0-3])(?!\d)/g,"G$1")}_isComment(t){return Et.COMMENT_PREFIXES.some(e=>t.startsWith(e))}_removeInlineComments(t){return t.replace(Ut.REGEX.COMMENT,"").trim()}_isLinearMove(t){return Et.LINEAR_MOVES.some(e=>t.startsWith(e))}_isArcMove(t){return Et.ARC_MOVES.some(e=>t.startsWith(e))}_parseLinearMove(t,e){const i=t.startsWith("G0")?"rapid":"cut",s=this._extractCoordinates(t);if(void 0!==s.x&&(this.currentPosition.x=s.x),void 0!==s.y&&(this.currentPosition.y=s.y),!Ot.isValidPoint(this.currentPosition))throw new Error(`Invalid coordinates at line ${e}: ${JSON.stringify(this.currentPosition)}`);const n={type:i,x:this.currentPosition.x,y:this.currentPosition.y,line:e};this.path.push(n),this.bounds=At.updateBounds(this.bounds,this.currentPosition.x,this.currentPosition.y),this.stats.linearMoves++}_parseArcMove(t,e){const i=t.startsWith("G2"),s=this._extractCoordinates(t),n=this._extractArcCenter(t),o=this.currentPosition.x,a=this.currentPosition.y,r=void 0!==s.x?s.x:this.currentPosition.x,l=void 0!==s.y?s.y:this.currentPosition.y;let d,h;if(this.ijAbsolute?void 0===n.i||void 0===n.j?(this._addWarning(`Line ${e}: Arc center missing I or J in absolute I/J mode; falling back to relative I/J.`,e),d=o+(n.i||0),h=a+(n.j||0)):(d=n.i,h=n.j):(d=o+(n.i||0),h=a+(n.j||0)),!(Ot.isValidCoordinate(r)&&Ot.isValidCoordinate(l)&&Ot.isValidCoordinate(d)&&Ot.isValidCoordinate(h)))throw new Error(`Invalid arc coordinates at line ${e}`);const c={type:"arc",startX:o,startY:a,endX:r,endY:l,centerX:d,centerY:h,clockwise:i,line:e};this.path.push(c),this.currentPosition.x=r,this.currentPosition.y=l;const u=Rt.calculateArcBounds(o,a,r,l,d,h,i);this.bounds.minX=Math.min(this.bounds.minX,u.minX),this.bounds.maxX=Math.max(this.bounds.maxX,u.maxX),this.bounds.minY=Math.min(this.bounds.minY,u.minY),this.bounds.maxY=Math.max(this.bounds.maxY,u.maxY),this.stats.arcMoves++}_parseG92(t,e){const i=this._extractCoordinates(t);let s=this.currentPosition.x,n=this.currentPosition.y;const o="number"==typeof i.x&&isFinite(i.x),a="number"==typeof i.y&&isFinite(i.y);if(o||a?(o&&(s=i.x),a&&(n=i.y)):(s=0,n=0,this.g92AssumedZero=!0,this._addWarning(`Line ${e}: G92 without coordinates; assuming X0 Y0 for start position.`,e)),Ot.isValidCoordinate(s)&&Ot.isValidCoordinate(n))if(this.currentPosition.x=s,this.currentPosition.y=n,0!==this.path.length)this._addWarning(`Line ${e}: G92 after motion not fully supported; updated reference position for subsequent moves only.`,e);else{if(this.g92Applied){const t=this.path[0];t&&"position"===t.type&&(t.x=s,t.y=n,t.line=e),this.g92Line=e}else this.path.push({type:"position",x:s,y:n,line:e,meta:{source:"G92"}}),this.g92Applied=!0,this.g92Line=e;this.bounds=At.updateBounds(this.bounds,s,n)}else this._addWarning(`Line ${e}: Invalid G92 coordinates; ignoring.`,e)}_extractCoordinates(t){const e={};let i;for(Ut.REGEX.COORDINATE.lastIndex=0;null!==(i=Ut.REGEX.COORDINATE.exec(t));){const t=i[1].toLowerCase(),s=Ot.sanitizeCoordinate(i[2]);Ot.isValidCoordinate(s)&&(e[t]=zt.round(s,this.options.precision))}return e}_extractArcCenter(t){const e={};let i;for(Ut.REGEX.ARC_CENTER.lastIndex=0;null!==(i=Ut.REGEX.ARC_CENTER.exec(t));){const t=i[1].toLowerCase(),s=Ot.sanitizeCoordinate(i[2]);Ot.isValidCoordinate(s)&&(e[t]=zt.round(s,this.options.precision))}return e}_handleError(t,e){this.errors.push({line:e,message:t.message,type:"error"}),this.stats.errors++}_addWarning(t,e){this.warnings.push({line:e,message:t,type:"warning"})}_validateResult(){0===this.path.length&&this._addWarning("No valid G-Code commands found in input",0),At.isValidBounds(this.bounds)||(this._addWarning("No valid coordinate bounds found",0),this.bounds=At.createEmptyBounds())}getStats(){return{...this.stats}}getErrors(){return[...this.errors]}getWarnings(){return[...this.warnings]}hasErrors(){return this.errors.length>0}hasWarnings(){return this.warnings.length>0}}function Kt(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}class Vt{constructor(t={}){this.container=t.container,this.maxMessages=t.maxMessages??5,this.ANIMATION=t.ANIMATION,this.STATUS=t.STATUS,this.queue=[],this.active=new Map}enqueue(t){return this.queue.push(t),this._process(),t.id}update(t,e,i=null){const s=this.active.get(t);if(s){if("string"==typeof e&&e.length){s.message=e;const t=s.element?.querySelector(".status-message-text");t&&(t.textContent=e)}"number"==typeof i&&(s.progress=Math.max(0,Math.min(100,i)),this._updateProgress(s))}}hide(t){const e=this.active.get(t);e&&this._hideMessage(e)}hideAll(){this.active.forEach(t=>{t.timeoutId&&clearTimeout(t.timeoutId);try{t.element?.remove()}catch(e){}}),this.active.clear(),this.queue.length=0,this.container&&(this.container.innerHTML="")}getStats(){return{activeMessages:this.active.size,queuedMessages:this.queue.length}}destroy(){this.hideAll(),this.container=null}_process(){if(this.active.size>=this.maxMessages||0===this.queue.length)return;const t=this.queue.shift();this._createMessageElement(t),this.active.set(t.id,t),!t.persistent&&t.duration>0&&(t.timeoutId=setTimeout(()=>this.hide(t.id),t.duration)),setTimeout(()=>this._process(),100)}_createMessageElement(t){const e=document.createElement("div");e.className=`status-message status-message-${t.type}`,e.setAttribute("data-message-id",t.id),function(t,e,i,s){const n={display:"flex",alignItems:"center",padding:"15px 20px",borderRadius:"5px",color:"white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",transition:`all ${s.NORMAL}ms ${s.EASE}`,transform:"translateX(100%)",opacity:"0",marginBottom:"10px",maxWidth:"100%",wordWrap:"break-word",position:"relative"},o={success:i.COLORS.SUCCESS,error:i.COLORS.ERROR,warning:i.COLORS.WARNING,info:i.COLORS.INFO};n.backgroundColor=o[e]||i.COLORS.INFO,Object.assign(t.style,n)}(e,t.type,this.STATUS,this.ANIMATION),e.addEventListener("mouseenter",()=>{e.style.transform="translateX(0) scale(1.02)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateX(0) scale(1)"}),e.innerHTML=function(t,e){let i=`\n    <div class="status-message-content">\n      <div class="status-message-text">${e(t.message)}</div>\n  `;return null!==t.progress&&(i+=`\n      <div class="status-message-progress">\n        <div class="status-message-progress-bar" style="width: ${t.progress}%"></div>\n      </div>\n    `),t.persistent&&(i+='\n      <button class="status-message-dismiss" type="button" aria-label="Dismiss">×</button>\n    '),i+="</div>",i}(t,Kt),e.addEventListener("click",()=>this.hide(t.id)),t.element=e,this.container.appendChild(e),this._animateIn(e)}_updateProgress(t){const e=t.element?.querySelector(".status-message-progress-bar");if(e)e.style.width=`${t.progress}%`;else{const e=document.createElement("div");e.className="status-message-progress",e.style.cssText="width:100%;height:4px;background-color:rgba(255,255,255,0.3);border-radius:2px;margin-top:8px;overflow:hidden;";const i=document.createElement("div");i.className="status-message-progress-bar",i.style.cssText=`height:100%;background-color:rgba(255,255,255,0.8);border-radius:2px;transition:width ${this.ANIMATION.FAST}ms ease;width:${t.progress}%;`,e.appendChild(i),t.element?.querySelector(".status-message-content")?.appendChild(e)}}_animateIn(t){t.offsetHeight,t.style.transform="translateX(0)",t.style.opacity="1"}_hideMessage(t){t.timeoutId&&clearTimeout(t.timeoutId),t.element&&(t.element.style.transform="translateX(100%)",t.element.style.opacity="0",setTimeout(()=>{try{t.element?.remove()}catch(e){}this.active.delete(t.id),this._process()},this.ANIMATION.NORMAL))}}class Zt{constructor(t){this.status=t,this.cleanups=[]}init(){const t=et.on(X,t=>{this.status.show(t.message,t.type,t.duration,t.persistent)}),e=et.on(Y,()=>{this.status.hideAll()}),i=et.on($,t=>{this.status.update(t.id,t.message,t.progress)});this.cleanups.push(t,e,i)}destroy(){this.cleanups.forEach(t=>{try{"function"==typeof t&&t()}catch(e){}}),this.cleanups.length=0}}class jt{constructor(t={}){this.container=t.container||document.body,this.position=t.position||"top-right",this.defaultDuration=t.defaultDuration||_t.DURATION,this.maxMessages=t.maxMessages||5,this.queue=null,this.toastManager=null,this.messageIdCounter=0,this.messageContainer=null,this.isAnimating=!1,this.eventCleanup=[],this.init()}init(){this.createMessageContainer(),this.queue=new Vt({container:this.messageContainer,maxMessages:this.maxMessages,ANIMATION:It,STATUS:_t}),this.toastManager=new Zt(this),this.toastManager.init(),console.debug("StatusMessage component initialized")}createMessageContainer(){this.messageContainer=document.createElement("div"),this.messageContainer.id="statusMessageContainer",this.messageContainer.className="status-message-container",function(t,e,i){const s={position:"fixed",zIndex:"1000",pointerEvents:"none",display:"flex",flexDirection:"column",gap:"10px",maxWidth:"400px",fontFamily:"Arial, sans-serif",fontSize:"14px"};switch(e){case"top-right":s.top=i.POSITION.TOP,s.right=i.POSITION.RIGHT,s.alignItems="flex-end";break;case"top-left":s.top=i.POSITION.TOP,s.left=i.POSITION.LEFT,s.alignItems="flex-start";break;case"bottom-right":s.bottom=i.POSITION.BOTTOM,s.right=i.POSITION.RIGHT,s.alignItems="flex-end",s.flexDirection="column-reverse";break;case"bottom-left":s.bottom=i.POSITION.BOTTOM,s.left=i.POSITION.LEFT,s.alignItems="flex-start",s.flexDirection="column-reverse"}Object.assign(t.style,s)}(this.messageContainer,this.position,_t),this.container.appendChild(this.messageContainer)}show(t,e="info",i=null,s=!1){if(!t||"string"!=typeof t)return console.warn("StatusMessage: Invalid message provided"),null;["success","error","warning","info"].includes(e)||(console.warn(`StatusMessage: Invalid type '${e}', defaulting to 'info'`),e="info");const n=`status_${++this.messageIdCounter}_${Date.now()}`,o={id:n,message:t,type:e,duration:null!==i?i:this.defaultDuration,persistent:s,createdAt:Date.now(),element:null,timeoutId:null,progress:null};return this.queue.enqueue(o),n}update(t,e,i=null){t?this.queue.update(t,e,i):console.warn("StatusMessage: Invalid message ID for update")}hide(t){t?this.queue.hide(t):console.warn("StatusMessage: Invalid message ID for hide")}hideAll(){this.queue.hideAll()}success(t,e=null){return this.show(t,"success",e)}error(t,e=null){return this.show(t,"error",e||2*_t.DURATION)}warning(t,e=null){return this.show(t,"warning",e)}info(t,e=null){return this.show(t,"info",e)}progress(t,e=0){const i=this.show(t,"info",null,!0);return this.update(i,t,e),i}getStats(){return{...this.queue?.getStats()||{activeMessages:0,queuedMessages:0},totalMessagesSent:this.messageIdCounter,maxMessages:this.maxMessages,defaultDuration:this.defaultDuration,position:this.position}}destroy(){this.hideAll();try{this.toastManager?.destroy()}catch(t){}try{this.queue?.destroy()}catch(t){}this.messageContainer&&this.messageContainer.parentNode&&this.messageContainer.parentNode.removeChild(this.messageContainer),this.messageContainer=null,console.debug("StatusMessage component destroyed")}}function Jt(t,e={}){const{startN:i=10,step:s=10,addPercent:n=!0,ensureM02:o=!0,crlf:a=!0,stripSemicolon:r=!0}=e;"string"!=typeof t&&(t=String(t??""));const l=t.split(/\r?\n/),d=[];n&&(l.length&&"%"===l[0].trim()?(d.push("%"),l.shift()):d.push("%"));let h=i;for(let u=0;u<l.length;u++){let t=l[u];if(!t)continue;let e=t.trim();if(e&&"%"!==e){if(r){const t=e.indexOf(";");if(t>=0&&(e=e.slice(0,t).trimEnd(),!e))continue}e=e.replace(/\s+/g," ").trim(),e=Qt(e),/^N\d+\b/i.test(e)?d.push(e):(d.push(`N${h} ${e}`),h+=s)}}if(o){const t=[];for(const e of d)/\bM0?2\b/i.test(e)||t.push(e);d.length=0,d.push(...t),d.push(`N${h} M02`)}const c=a?"\r\n":"\n";return d.join(c)+c}function Qt(t){return"string"!=typeof t?""+t:t.replace(/\bG0+([0-3])(?!\d)/gi,"G$1")}class te{static VERSION="1.0.0";static SUPPORTED_EXTENSIONS=wt;static MAX_FILE_SIZE=St;constructor(t={}){this.statusMessage=t.statusMessage||null,this.gCodeParser=t.gCodeParser||new Ut,this.eventBus=et.getInstance(),this.isProcessing=!1,this.currentFile=null,this.loadedData=null,this._bindMethods()}_bindMethods(){this.loadFile=this.loadFile.bind(this),this.exportPoints=this.exportPoints.bind(this),this.exportISOFromPoints=this.exportISOFromPoints.bind(this),this.normalizeContentToISO=this.normalizeContentToISO.bind(this),this.exportNormalizedISOFromText=this.exportNormalizedISOFromText.bind(this),this.validateFile=this.validateFile.bind(this)}async loadFile(t){if(this.isProcessing)return this.statusMessage?.warning("File operation already in progress"),null;try{this.isProcessing=!0,this.currentFile=t;const n=this.validateFile(t);if(!n.valid)return this.statusMessage?.error(n.message),null;this.eventBus.emit(e,{file:t});const o=await this._readFileContent(t),a=this.gCodeParser.parse(o);if(!a||!a.path||0===a.path.length){const e=a&&a.errors&&a.errors.length>0?a.errors[0].message:"No valid G-code commands found";return this.statusMessage?.error(`Parse error: ${e}`),this.eventBus.emit(s,{file:t,error:e}),null}return this.loadedData={file:t,content:o,parseResult:a},this.statusMessage?.success("G-code loaded successfully!"),this.eventBus.emit(i,{file:t,path:a.path,bounds:a.bounds,stats:a.stats}),a}catch(n){return this.statusMessage?.error(`Failed to load file: ${n.message}`),this.eventBus.emit(s,{file:t,error:n}),null}finally{this.isProcessing=!1}}validateFile(t){if(!t)return{valid:!1,message:"No file provided"};if(t.size>te.MAX_FILE_SIZE)return{valid:!1,message:`File too large (${(t.size/1048576).toFixed(2)}MB). Maximum size is ${(te.MAX_FILE_SIZE/1048576).toFixed(0)}MB.`};const e=t.name.toLowerCase();return te.SUPPORTED_EXTENSIONS.some(t=>e.endsWith(t))?0===t.size?{valid:!1,message:"File is empty"}:{valid:!0,message:"File is valid"}:{valid:!1,message:`Unsupported file type. Supported formats: ${te.SUPPORTED_EXTENSIONS.join(", ")}`}}exportPoints(t,e={}){if(!t||0===t.length)return this.statusMessage?.warning("No points to export!"),!1;try{const i=e.filename||"wire_path_points.gcode",s=!1!==e.includeHeader;let n="";return s&&(n+=`${Ct.HEADER_COMMENT}\n`,n+=`; Generated on ${(new Date).toLocaleString()}\n`,n+=`; Total points: ${t.length}\n\n`),t.forEach((t,e)=>{n+=`; Point ${e+1}\n`,n+=`G0 X${t.x.toFixed(Et.DEFAULT_PRECISION)} Y${t.y.toFixed(Et.DEFAULT_PRECISION)}\n`}),s&&(n+="\n; End of exported points\n"),!!this._downloadFile(n,i,Ct.MIME_TYPE)&&(this.statusMessage?.success(`Points exported successfully! (${t.length} points)`),this.eventBus.emit(F,{pointCount:t.length,filename:i,format:"gcode",points:t}),!0)}catch(i){return this.statusMessage?.error(`Export failed: ${i.message}`),this.eventBus.emit(N,{error:i}),!1}}exportISOFromPoints(t,e={}){if(!t||0===t.length)return this.statusMessage?.warning("No points to export!"),!1;try{const i=function(t,e={}){const{startN:i=10,step:s=10,crlf:n=!0,precision:o=3,feed:a=1e3,headerCodes:r=["G92","G60","G38","G42 D0","G90"]}=e,l=["%"];let d=i;for(const p of r)l.push(`N${d} ${p}`),d+=s;if(!t||0===t.length){l.push(`N${d} M02`);const t=n?"\r\n":"\n";return l.join(t)+t}const h=t=>Number(t).toFixed(o),c=t[0];l.push(`N${d} G0 X${h(c.x)} Y${h(c.y)}`),d+=s;for(let p=1;p<t.length;p++){const e=t[p];1===p&&"number"==typeof a?l.push(`N${d} G1 X${h(e.x)} Y${h(e.y)} F${a}`):l.push(`N${d} G1 X${h(e.x)} Y${h(e.y)}`),d+=s}l.push(`N${d} M02`);const u=n?"\r\n":"\n";return l.join(u)+u}(t,{startN:e.startN??10,step:e.step??10,precision:e.precision??Et.DEFAULT_PRECISION,feed:e.feed??1e3,crlf:!0}),s=e.filename||"program.iso";return!!this._downloadFile(i,s,Tt.MIME_TYPE)&&(this.statusMessage?.success(`ISO exported successfully (${t.length} points)`),this.eventBus.emit(F,{pointCount:t.length,filename:s,format:"iso",points:t}),!0)}catch(i){return this.statusMessage?.error(`ISO export failed: ${i.message}`),this.eventBus.emit(N,{error:i}),!1}}normalizeContentToISO(t,e={}){return Jt(t,e)}exportNormalizedISOFromText(t,e={}){try{const i=Jt(t||"",{startN:e.startN??10,step:e.step??10,addPercent:!0,ensureM02:!0,crlf:!0,stripSemicolon:!0}),s=e.filename||"program.iso";return!!this._downloadFile(i,s,Tt.MIME_TYPE)&&(this.statusMessage?.success("ISO exported successfully"),this.eventBus.emit(F,{filename:s,format:"iso"}),!0)}catch(i){return this.statusMessage?.error(`ISO export failed: ${i.message}`),this.eventBus.emit(N,{error:i}),!1}}getFileInfo(){if(!this.loadedData)return null;const{file:t,parseResult:e}=this.loadedData;return{name:t.name,size:t.size,type:t.type,lastModified:new Date(t.lastModified),stats:e.stats,bounds:e.bounds}}clearLoadedFile(){this.loadedData=null,this.currentFile=null,this.eventBus.emit(o)}_readFileContent(t){return new Promise((e,i)=>{const s=new FileReader;s.onload=t=>{e(t.target.result)},s.onerror=()=>{i(new Error("Failed to read file"))},s.onprogress=t=>{if(t.lengthComputable){const e=t.loaded/t.total*100;this.eventBus.emit(n,{progress:Math.round(e)})}},s.readAsText(t)})}_downloadFile(t,e,i){try{const s=new Blob([t],{type:i}),n=URL.createObjectURL(s),o=document.createElement("a");return o.href=n,o.download=e,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),!0}catch(s){return console.error("Download failed:",s),!1}}destroy(){this.clearLoadedFile(),this.isProcessing=!1,this.currentFile=null,this.statusMessage=null,this.gCodeParser=null}}class ee{constructor(t={},e={}){this.elements=t,this.onChooseFile=e.onChooseFile||(()=>{}),this.isInitialized=!1,this._bound=null}init(){this.isInitialized||(this._bind(),this._attach(),this.isInitialized=!0)}destroy(){this._detach(),this._bound=null,this.isInitialized=!1}_bind(){this._bound={onChange:t=>{const e=t.target,i=e&&e.files&&e.files[0];i&&this.onChooseFile(i)},onDragOver:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.add("drag-over")},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.remove("drag-over")},onDrop:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.remove("drag-over");const e=t.dataTransfer;e&&e.files&&e.files.length>0&&this.onChooseFile(e.files[0])}}}_attach(){const{fileInput:t,fileInputLabel:e}=this.elements;t&&t.addEventListener("change",this._bound.onChange),e&&(e.addEventListener("dragover",this._bound.onDragOver),e.addEventListener("dragleave",this._bound.onDragLeave),e.addEventListener("drop",this._bound.onDrop))}_detach(){const{fileInput:t,fileInputLabel:e}=this.elements;t&&this._bound?.onChange&&t.removeEventListener("change",this._bound.onChange),e&&(this._bound?.onDragOver&&e.removeEventListener("dragover",this._bound.onDragOver),this._bound?.onDragLeave&&e.removeEventListener("dragleave",this._bound.onDragLeave),this._bound?.onDrop&&e.removeEventListener("drop",this._bound.onDrop))}}class ie{constructor(t={}){this.elements=t,this.isInitialized=!1,this._bound=null,this.bus=et.getInstance(),this._offZoom=null}init(){this.isInitialized||(this._bind(),this._attach(),this._subscribe(),this.isInitialized=!0)}destroy(){this._detach(),"function"==typeof this._offZoom&&this._offZoom(),this._offZoom=null,this._bound=null,this.isInitialized=!1}_bind(){this._bound={onZoomIn:()=>{this.bus.emit(h,{type:"in",source:"toolbar"},{skipValidation:!0})},onZoomOut:()=>{this.bus.emit(h,{type:"out",source:"toolbar"},{skipValidation:!0})},onFit:()=>{this.bus.emit(p,{source:"toolbar"})}}}_attach(){const{zoomInButton:t,zoomOutButton:e,fitToScreenButton:i}=this.elements;t&&t.addEventListener("click",this._bound.onZoomIn),e&&e.addEventListener("click",this._bound.onZoomOut),i&&i.addEventListener("click",this._bound.onFit)}_detach(){const{zoomInButton:t,zoomOutButton:e,fitToScreenButton:i}=this.elements;t&&this._bound?.onZoomIn&&t.removeEventListener("click",this._bound.onZoomIn),e&&this._bound?.onZoomOut&&e.removeEventListener("click",this._bound.onZoomOut),i&&this._bound?.onFit&&i.removeEventListener("click",this._bound.onFit)}_subscribe(){this._offZoom=this.bus.on(h,t=>{if(t&&"number"==typeof t.zoom){const e=Math.round(100*t.zoom);this.elements.zoomDisplay&&(this.elements.zoomDisplay.textContent=`${e}%`)}})}}class se{constructor(t={},e={}){this.elements=t,this.getTextForNormalization=e.getTextForNormalization||(()=>""),this.exportNormalizedISOFromText=e.exportNormalizedISOFromText||(()=>!1),this.isInitialized=!1,this._bound=null,this.bus=et.getInstance()}init(){this.isInitialized||(this._bind(),this._attach(),this.isInitialized=!0)}destroy(){this._detach(),this._bound=null,this.isInitialized=!1}_bind(){this._bound={onClear:()=>{this.bus.emit(E,{source:"toolbar"})},onExportISO:()=>{this.bus.emit(B,{source:"toolbar",format:"iso"})},onToggleDrawer:()=>{this.bus.emit("drawer:toggle")},onNormalizeISO:()=>{const t=this.getTextForNormalization()||"",e=`normalized_${(new Date).toISOString().slice(0,19).replace(/[:T]/g,"-")}.iso`;this.exportNormalizedISOFromText(t,{filename:e})&&this.bus.emit("status:show",{message:"Normalized to ISO",type:"success"},{skipValidation:!0})}}}_attach(){const{clearPointsButton:t,exportPointsButton:e,drawerToggleButton:i,normalizeButton:s}=this.elements;t&&t.addEventListener("click",this._bound.onClear),e&&e.addEventListener("click",this._bound.onExportISO),i&&i.addEventListener("click",this._bound.onToggleDrawer),s&&s.addEventListener("click",this._bound.onNormalizeISO)}_detach(){const{clearPointsButton:t,exportPointsButton:e,drawerToggleButton:i,normalizeButton:s}=this.elements;t&&this._bound?.onClear&&t.removeEventListener("click",this._bound.onClear),e&&this._bound?.onExportISO&&e.removeEventListener("click",this._bound.onExportISO),i&&this._bound?.onToggleDrawer&&i.removeEventListener("click",this._bound.onToggleDrawer),s&&this._bound?.onNormalizeISO&&s.removeEventListener("click",this._bound.onNormalizeISO)}}class ne{constructor(t,e={}){if(!t)throw new Error("Container element is required");this.container=t,this.options={enableFileInput:!0,enableZoomControls:!0,enableUtilityButtons:!0,...e},this.eventBus=et.getInstance(),this.fileHandler=new te,this.fileControls=null,this.viewControls=null,this.actionControls=null,this.state={currentFile:null,zoomLevel:rt,isFileLoading:!1,hasClickedPoints:!1},this.elements={fileInput:null,fileInputLabel:null,zoomInButton:null,zoomOutButton:null,fitToScreenButton:null,zoomDisplay:null,clearPointsButton:null,exportPointsButton:null},this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._onPointsChange=this._onPointsChange.bind(this),this._onFileLoadStart=this._onFileLoadStart.bind(this),this._onFileLoadSuccess=this._onFileLoadSuccess.bind(this),this._onFileLoadError=this._onFileLoadError.bind(this),this._onPointsExportResponse=this._onPointsExportResponse.bind(this)}init(){if(this.isInitialized)console.warn("Toolbar already initialized");else try{this._renderToolbar(),this._setupEventListeners(),this._subscribeToEvents(),this.isInitialized=!0,console.log("Toolbar initialized successfully")}catch(t){throw console.error("Failed to initialize Toolbar:",t),t}}_renderToolbar(){const t=`\n      ${this.options.enableFileInput?this._renderFileInput():""}\n      ${this.options.enableZoomControls?this._renderZoomControls():""}\n      ${this.options.enableUtilityButtons?this._renderUtilityButtons():""}\n    `;this.container.innerHTML=t,this._getElementReferences()}_renderFileInput(){return'\n      <div class="file-input-wrapper">\n        <input type="file" id="fileInput" accept=".gcode,.nc,.txt,.iso" data-toolbar="file-input">\n        <label for="fileInput" class="file-input-label" data-toolbar="file-input-label" title="Load G-Code files (.gcode, .nc, .txt) or drag and drop files here">\n          Load G-Code File\n        </label>\n      </div>\n    '}_renderZoomControls(){return'\n      <div class="zoom-controls">\n        <button data-toolbar="zoom-in" type="button" title="Zoom in (or use mouse wheel)">Zoom +</button>\n        <button data-toolbar="zoom-out" type="button" title="Zoom out (or use mouse wheel)">Zoom -</button>\n        <button data-toolbar="fit-to-screen" type="button" title="Fit G-Code to screen">Fit to Screen</button>\n        <span class="zoom-display" title="Current zoom level">Zoom: <span data-toolbar="zoom-level">100%</span></span>\n      </div>\n    '}_renderUtilityButtons(){return'\n      <button data-toolbar="clear-points" type="button" title="Clear all measurement points">Clear Points</button>\n      <button data-toolbar="export-points" type="button" title="Export clicked points as ISO file (.iso)">Export ISO</button>\n      <button data-toolbar="toggle-gcode-drawer" type="button" title="Show/Hide G-Code preview drawer">G-Code Drawer</button>\n      <button data-toolbar="normalize-to-iso" type="button" title="Normalize current drawer content to .iso (no points needed)">Normalize to ISO</button>\n    '}_getElementReferences(){this.elements.fileInput=this.container.querySelector('[data-toolbar="file-input"]'),this.elements.fileInputLabel=this.container.querySelector('[data-toolbar="file-input-label"]'),this.elements.zoomInButton=this.container.querySelector('[data-toolbar="zoom-in"]'),this.elements.zoomOutButton=this.container.querySelector('[data-toolbar="zoom-out"]'),this.elements.fitToScreenButton=this.container.querySelector('[data-toolbar="fit-to-screen"]'),this.elements.zoomDisplay=this.container.querySelector('[data-toolbar="zoom-level"]'),this.elements.clearPointsButton=this.container.querySelector('[data-toolbar="clear-points"]'),this.elements.exportPointsButton=this.container.querySelector('[data-toolbar="export-points"]'),this.elements.drawerToggleButton=this.container.querySelector('[data-toolbar="toggle-gcode-drawer"]'),this.elements.normalizeButton=this.container.querySelector('[data-toolbar="normalize-to-iso"]')}_setupEventListeners(){this.fileControls=new ee({fileInput:this.elements.fileInput,fileInputLabel:this.elements.fileInputLabel},{onChooseFile:t=>this._loadFile(t)}),this.fileControls.init(),this.viewControls=new ie({zoomInButton:this.elements.zoomInButton,zoomOutButton:this.elements.zoomOutButton,fitToScreenButton:this.elements.fitToScreenButton,zoomDisplay:this.elements.zoomDisplay}),this.viewControls.init(),this.actionControls=new se({clearPointsButton:this.elements.clearPointsButton,exportPointsButton:this.elements.exportPointsButton,drawerToggleButton:this.elements.drawerToggleButton,normalizeButton:this.elements.normalizeButton},{getTextForNormalization:()=>{const t=window.wireEDMViewer,e=t?.gcodeDrawer;return e?.getText?.()||this.fileHandler?.loadedData?.content||""},exportNormalizedISOFromText:(t,e)=>this.fileHandler?.exportNormalizedISOFromText?.(t,e)}),this.actionControls.init()}_subscribeToEvents(){this.eventBus.on(_,this._onPointsChange),this.eventBus.on(e,this._onFileLoadStart),this.eventBus.on(i,this._onFileLoadSuccess),this.eventBus.on(s,this._onFileLoadError),this.eventBus.on(F,this._onPointsExportResponse)}_exportPoints(t){t&&0!==t.length&&this.fileHandler.exportPoints(t)&&this._updateButtons()}async _loadFile(t){try{this.state.currentFile=t,this.state.isFileLoading=!0,await this.fileHandler.loadFile(t)?(this.state.isFileLoading=!1,this._updateFileInputDisplay(`${t.name} loaded`),this._updateButtons()):(this.state.isFileLoading=!1,this.state.currentFile=null,this._updateFileInputDisplay("Load G-Code File"),this._updateButtons())}catch(e){this.state.isFileLoading=!1,this.state.currentFile=null,this._updateFileInputDisplay("Load G-Code File"),this._updateButtons(),console.error("File loading error:",e)}}_onPointsChange(t){this.state.hasClickedPoints=t.pointCount>0,this._updateButtonStates()}_onFileLoadStart(t){this.state.isFileLoading=!0,this._updateFileInputLabel("Loading..."),this._updateButtonStates()}_onFileLoadSuccess(t){this.state.isFileLoading=!1,this._updateFileInputLabel("Load G-Code File"),this._updateButtonStates()}_onFileLoadError(t){this.state.isFileLoading=!1,this._updateFileInputLabel("Load G-Code File"),this._updateButtonStates(),this.elements.fileInput&&(this.elements.fileInput.value="")}_onPointsExportResponse(t){this._updateButtonStates()}_updateFileInputLabel(t){this.elements.fileInputLabel&&(this.elements.fileInputLabel.textContent=t)}_updateFileInputDisplay(t){this._updateFileInputLabel(t)}_updateButtons(){this._updateButtonStates()}_updateButtonStates(){this.elements.exportPointsButton&&(this.elements.exportPointsButton.disabled=!this.state.hasClickedPoints),this.elements.clearPointsButton&&(this.elements.clearPointsButton.disabled=!this.state.hasClickedPoints),this.elements.fileInput&&(this.elements.fileInput.disabled=this.state.isFileLoading)}getState(){return{...this.state,isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}updateOptions(t){this.options={...this.options,...t},this.isInitialized&&(this._renderToolbar(),this._setupEventListeners())}destroy(){this.isDestroyed||(this.eventBus.off(_,this._onPointsChange),this.eventBus.off(e,this._onFileLoadStart),this.eventBus.off(i,this._onFileLoadSuccess),this.eventBus.off(s,this._onFileLoadError),this.eventBus.off(F,this._onPointsExportResponse),this.container.innerHTML="",this.fileHandler&&(this.fileHandler.destroy(),this.fileHandler=null),this.fileControls&&(this.fileControls.destroy(),this.fileControls=null),this.viewControls&&(this.viewControls.destroy(),this.viewControls=null),this.actionControls&&(this.actionControls.destroy(),this.actionControls=null),this.elements={},this.state={currentFile:null,zoomLevel:rt,isFileLoading:!1,hasClickedPoints:!1},this.isDestroyed=!0)}}class oe{constructor(t,e={}){if(!t)throw new Error("Sidebar requires a container element");this.container=t,this.options={showCoordinates:!0,showPoints:!0,showPathInfo:!0,...e},this.currentMousePosition={x:0,y:0},this.gridSnapEnabled=!1,this.clickedPoints=[],this.pathInfo=null,this.init()}init(){try{this.createSidebarStructure(),this.bindEvents(),this.updateDisplay()}catch(t){throw console.error("Failed to initialize Sidebar:",t),t}}createSidebarStructure(){if(this.container.innerHTML='\n      <div class="sidebar">\n        <div class="coordinates-display">\n          <h3>Current Position</h3>\n          <div class="coordinate-item">Mouse X: <span id="mouseX">0.000</span> mm</div>\n          <div class="coordinate-item">Mouse Y: <span id="mouseY">0.000</span> mm</div>\n          <div class="coordinate-item">Grid Snap: <span id="gridSnap">OFF</span></div>\n        </div>\n        \n        <div class="clicked-points">\n          <h3>Clicked Points</h3>\n          <div class="point-list" id="pointList"></div>\n        </div>\n        \n        <div class="path-info">\n          <h3>Path Information</h3>\n          <div id="pathInfo">No G-Code loaded</div>\n        </div>\n        \n        <div class="usage-panel">\n          <h3>Usage & Controls</h3>\n          <div class="usage-content">\n            <div class="usage-section">\n              <h4>File Operations</h4>\n              <p>• Use "Load G-Code File" button to upload .gcode, .nc, or .txt files</p>\n              <p>• Drag and drop files onto the load button</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Navigation</h4>\n              <p>• <strong>Mouse wheel:</strong> Zoom in/out</p>\n              <p>• <strong>Shift + Click:</strong> Pan view</p>\n              <p>• <strong>Zoom buttons:</strong> +/- or Fit to Screen</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Measurement</h4>\n              <p>• <strong>Click:</strong> Add measurement point</p>\n              <p>• <strong>Clear Points:</strong> Remove all points</p>\n              <p>• <strong>Export Points:</strong> Save as G-Code</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Keyboard Shortcuts</h4>\n              <p>• <strong>G:</strong> Toggle grid snap ON/OFF</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',this.mouseXElement=this.container.querySelector("#mouseX"),this.mouseYElement=this.container.querySelector("#mouseY"),this.gridSnapElement=this.container.querySelector("#gridSnap"),this.pointListElement=this.container.querySelector("#pointList"),this.pathInfoElement=this.container.querySelector("#pathInfo"),!(this.mouseXElement&&this.mouseYElement&&this.gridSnapElement&&this.pointListElement&&this.pathInfoElement))throw new Error("Failed to create sidebar DOM elements")}bindEvents(){const t=et.getInstance();this._unsubscribes=[],this._handleMouseMove=this.handleMouseMove.bind(this),this._handleMouseLeave=this.handleMouseLeave.bind(this),this._handleGridSnapToggle=this.handleGridSnapToggle.bind(this),this._handlePointUpdate=this.handlePointUpdate.bind(this),this._handleParseSuccess=this.handlePathInfoUpdate.bind(this),this._handleFileLoad=this.handleFileLoad.bind(this),this._unsubscribes.push(t.on(g,this._handleMouseMove)),this._unsubscribes.push(t.on(x,this._handleMouseLeave)),this._unsubscribes.push(t.on(M,this._handleGridSnapToggle)),this._unsubscribes.push(t.on(_,this._handlePointUpdate)),this._unsubscribes.push(t.on(r,this._handleParseSuccess)),this._unsubscribes.push(t.on(i,this._handleFileLoad))}handleMouseMove(t){t&&"number"==typeof t.worldX&&"number"==typeof t.worldY&&(this.currentMousePosition={x:t.worldX,y:t.worldY},this.updateCoordinateDisplay())}handleMouseLeave(){this.currentMousePosition={x:0,y:0},this.updateCoordinateDisplay()}handleGridSnapToggle(t){this.gridSnapEnabled=t?.enabled||!1,this.updateGridSnapDisplay()}handlePointUpdate(t){t&&"number"==typeof t.pointCount?(this.clickedPoints=t.points||[],this.updatePointList()):console.warn("Invalid point update event data:",t)}handlePathInfoUpdate(t){t&&(this.pathInfo={totalMoves:t.totalMoves||0,rapidMoves:t.rapidMoves||0,cuttingMoves:t.cuttingMoves||0,arcMoves:t.arcMoves||0,bounds:t.bounds||null,parseTime:t.parseTime||0},this.updatePathInfoDisplay())}handleFileLoad(t){t&&(this.pathInfo&&(this.pathInfo.fileName=t.file?.name||"Unknown",this.pathInfo.fileSize=t.file?.size||0),this.updatePathInfoDisplay())}updateCoordinateDisplay(){if(!this.mouseXElement||!this.mouseYElement)return;const t=this.currentMousePosition.x.toFixed(Lt),e=this.currentMousePosition.y.toFixed(Lt);this.mouseXElement.textContent=t,this.mouseYElement.textContent=e}updateGridSnapDisplay(){this.gridSnapElement&&(this.gridSnapElement.textContent=this.gridSnapEnabled?"ON":"OFF",this.gridSnapElement.classList.toggle("enabled",this.gridSnapEnabled))}updatePointList(){if(!this.pointListElement)return;if(0===this.clickedPoints.length)return void(this.pointListElement.innerHTML='<div class="no-points">No points selected</div>');const t=this.clickedPoints.map(t=>{const e=t.x.toFixed(Lt),i=t.y.toFixed(Lt);return`\n        <div class="point-item" data-point-id="${t.id}">\n          <span class="point-label">P${(t.index??0)+1}</span>\n          <span class="point-coords">(${e}, ${i})</span>\n          <button class="delete-point-btn" data-point-id="${t.id}" title="Delete point">×</button>\n        </div>\n      `}).join("");this.pointListElement.innerHTML=t}updatePathInfoDisplay(){if(!this.pathInfoElement)return;if(!this.pathInfo)return void(this.pathInfoElement.innerHTML="No G-Code loaded");const t=this.pathInfo.bounds,e=t?`${t.minX.toFixed(1)}, ${t.minY.toFixed(1)} to ${t.maxX.toFixed(1)}, ${t.maxY.toFixed(1)}`:"Unknown";this.pathInfoElement.innerHTML=`\n      <div class="path-stat">\n        <span class="stat-label">Total Moves:</span> \n        <span class="stat-value">${this.pathInfo.totalMoves}</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Rapid Moves:</span> \n        <span class="stat-value">${this.pathInfo.rapidMoves}</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Cutting Moves:</span> \n        <span class="stat-value">${this.pathInfo.cuttingMoves}</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Arc Moves:</span> \n        <span class="stat-value">${this.pathInfo.arcMoves}</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Bounds:</span> \n        <span class="stat-value">${e}</span>\n      </div>\n      ${this.pathInfo.fileName?`\n        <div class="path-stat">\n          <span class="stat-label">File:</span> \n          <span class="stat-value">${this.pathInfo.fileName}</span>\n        </div>\n      `:""}\n    `}reindexPoints(){this.clickedPoints.forEach((t,e)=>{t.index=e+1})}updateDisplay(){this.updateCoordinateDisplay(),this.updateGridSnapDisplay(),this.updatePointList(),this.updatePathInfoDisplay()}getState(){return{mousePosition:{...this.currentMousePosition},gridSnapEnabled:this.gridSnapEnabled,clickedPoints:[...this.clickedPoints],pathInfo:this.pathInfo?{...this.pathInfo}:null}}destroy(){et.getInstance(),Array.isArray(this._unsubscribes)&&(this._unsubscribes.forEach(t=>{try{t&&t()}catch(e){}}),this._unsubscribes.length=0),this.container.innerHTML="",this.mouseXElement=null,this.mouseYElement=null,this.gridSnapElement=null,this.pointListElement=null,this.pathInfoElement=null,this.clickedPoints=[],this.pathInfo=null}}function ae(t){if(!t||"string"!=typeof t)return"";const e=document.createElement("div");e.textContent=t;let i=e.innerHTML;const s={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#x27;":"'","&#x2F;":"/"};return i=i.replace(/&(lt|gt|amp|quot|#x27|#x2F);/g,(t,e)=>s[`&${e};`]||t),i=i.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim(),i}function re(t){if(!t)return;const e=t.textContent||"",i=ae(e);if(e!==i){const e=window.getSelection(),n=e.rangeCount>0?e.getRangeAt(0):null,o=n?n.startOffset:0;t.textContent=i;try{n&&i.length>=o&&(n.setStart(t.childNodes[0]||t,Math.min(o,i.length)),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}catch(s){}}}class le{constructor(t={}){this.undoStack=[],this.redoStack=[],this.maxHistorySize="number"==typeof t.max?t.max:50,this._onChange="function"==typeof t.onChange?t.onChange:null}setMax(t){if("number"==typeof t&&t>0){for(this.maxHistorySize=t;this.undoStack.length>this.maxHistorySize;)this.undoStack.shift();this._notify()}}onChange(t){this._onChange="function"==typeof t?t:null}push(t){this.undoStack.push(t),this.redoStack=[],this.undoStack.length>this.maxHistorySize&&this.undoStack.shift(),this._notify()}undo(){if(0===this.undoStack.length)return null;const t=this.undoStack.pop();return t.undo(),this.redoStack.push(t),this._notify(),t}redo(){if(0===this.redoStack.length)return null;const t=this.redoStack.pop();return t.execute(),this.undoStack.push(t),this._notify(),t}clear(){this.undoStack=[],this.redoStack=[],this._notify()}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoCount(){return this.undoStack.length}getRedoCount(){return this.redoStack.length}_notify(){if(this._onChange)try{this._onChange({canUndo:this.canUndo(),canRedo:this.canRedo(),undoCount:this.getUndoCount(),redoCount:this.getRedoCount()})}catch(t){}}}class de{constructor(t=null){this._set=new Set,t&&this.setSelection(t)}clear(){return this._set.clear(),this}selectSingle(t){return this._set.clear(),Number.isFinite(t)&&this._set.add(t),this}toggle(t){return Number.isFinite(t)?(this._set.has(t)?this._set.delete(t):this._set.add(t),this):this}selectRange(t,e){const i=Math.min(t,e),s=Math.max(t,e);this._set.clear();for(let n=i;n<=s;n++)this._set.add(n);return this}setSelection(t){if(this._set.clear(),!t)return this;const e=t instanceof Set||Array.isArray(t)?t.values():null;if(!e)return this;for(const i of e)Number.isFinite(i)&&this._set.add(i);return this}getSelection(){return new Set(this._set)}has(t){return this._set.has(t)}size(){return this._set.size}}class he{constructor(t,e={}){this.container=t,this.handlers=e,this.headerEl=null,this.contextToolbarEl=null,this._render(),this._bindEvents()}_render(){const t=document.createElement("div");t.className="gcode-drawer-header",t.innerHTML='\n      <div class="gcode-drawer-title">\n        <strong>G-Code</strong>\n        <span class="gcode-line-count">0 lines</span>\n      </div>\n      <div class="gcode-mode-toggle">\n        <button class="gcode-mode-btn gcode-mode-btn--select active" data-mode="select" title="Select mode - Click lines to select" aria-pressed="true">Select</button>\n        <button class="gcode-mode-btn gcode-mode-btn--edit" data-mode="edit" title="Edit mode - Click text to edit" aria-pressed="false">Edit</button>\n      </div>\n      <div class="gcode-drawer-actions">\n        <button class="gcode-action-btn" data-action="undo" title="Undo (Ctrl+Z)" disabled>↶</button>\n        <button class="gcode-action-btn" data-action="redo" title="Redo (Ctrl+Y)" disabled>↷</button>\n        <button class="gcode-action-btn" data-action="close" title="Close drawer">×</button>\n      </div>\n    ';const e=document.createElement("div");e.className="gcode-context-toolbar",e.style.display="none",e.innerHTML='\n      <div class="gcode-selection-info">\n        <span class="gcode-selection-counter"></span>\n      </div>\n      <div class="gcode-selection-actions">\n        <button class="gcode-toolbar-btn" data-action="move-up" title="Move selected lines up" disabled>↑</button>\n        <button class="gcode-toolbar-btn" data-action="move-down" title="Move selected lines down" disabled>↓</button>\n        <button class="gcode-toolbar-btn" data-action="insert-points" title="Insert clicked points">+ Points</button>\n        <button class="gcode-toolbar-btn" data-action="delete-selected" title="Delete selected lines">🗑</button>\n      </div>\n    ',this.container.prepend(e),this.container.prepend(t),this.headerEl=t,this.contextToolbarEl=e}_bindEvents(){const t=(t,e,i)=>{const s=this.container.querySelector(t);s&&i&&s.addEventListener(e,i)};t('[data-action="close"]',"click",()=>this.handlers.onClose?.()),t('[data-action="undo"]',"click",()=>this.handlers.onUndo?.()),t('[data-action="redo"]',"click",()=>this.handlers.onRedo?.()),t('[data-action="move-up"]',"click",()=>this.handlers.onMoveUp?.()),t('[data-action="move-down"]',"click",()=>this.handlers.onMoveDown?.()),t('[data-action="insert-points"]',"click",()=>this.handlers.onInsertPoints?.()),t('[data-action="delete-selected"]',"click",()=>this.handlers.onDeleteSelected?.()),t('[data-mode="select"]',"click",()=>this.handlers.onModeToggle?.("select")),t('[data-mode="edit"]',"click",()=>this.handlers.onModeToggle?.("edit"))}updateLineCount(t){const e=this.container.querySelector(".gcode-line-count");e&&(e.textContent=`${t} line${1!==t?"s":""}`)}setUndoRedoState(t,e){const i=this.container.querySelector('[data-action="undo"]'),s=this.container.querySelector('[data-action="redo"]');i&&(i.disabled=!(t>0),i.title=t>0?`Undo (Ctrl+Z) - ${t} action${1!==t?"s":""}`:"Undo (Ctrl+Z)"),s&&(s.disabled=!(e>0),s.title=e>0?`Redo (Ctrl+Y) - ${e} action${1!==e?"s":""}`:"Redo (Ctrl+Y)")}updateSelectionUI(t,e){const i=this.container.querySelector(".gcode-context-toolbar");i&&(i.style.display=t?"flex":"none");const s=this.container.querySelector(".gcode-selection-counter");s&&t&&(s.textContent=`${e} line${1!==e?"s":""} selected`);const n=this.container.querySelector('[data-action="move-up"]'),o=this.container.querySelector('[data-action="move-down"]'),a=this.container.querySelector('[data-action="delete-selected"]'),r=this.container.querySelector('[data-action="insert-points"]');n&&(n.disabled=!t),o&&(o.disabled=!t),a&&(a.disabled=!t),r&&(r.disabled=!t)}updateModeUI(t){const e=this.container.querySelector('[data-mode="select"]'),i=this.container.querySelector('[data-mode="edit"]'),s=this.container.querySelector(".gcode-context-toolbar");e&&i&&(t?(e.classList.remove("active"),i.classList.add("active"),e.setAttribute("aria-pressed","false"),i.setAttribute("aria-pressed","true")):(e.classList.add("active"),i.classList.remove("active"),e.setAttribute("aria-pressed","true"),i.setAttribute("aria-pressed","false"))),s&&t&&(s.style.display="none")}}class ce{constructor(t,{undoSystem:e,editMode:i=!1,onLineEdited:s,onHover:n,onLeave:o,onClick:a,onDeleteLine:r,onBulkDelete:l,getSelection:d,applySelection:h,updateLineCount:c}){this.bodyEl=t,this.undoSystem=e,this.editMode=i,this.onLineEdited=s,this.onHover=n,this.onLeave=o,this.onClick=a,this.onDeleteLine=r,this.onBulkDelete=l,this.getSelection=d,this.applySelection=h,this.updateLineCount=c,this.currentlyEditingLine=null,this.editingOriginalText=new Map}updateSelectionClasses(t){const e=t instanceof Set?t:new Set(t||[]);this.bodyEl.querySelectorAll(".gcode-line").forEach(t=>t.classList.remove("selected")),e.forEach(t=>{const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);e&&e.classList.add("selected")})}setLines(t){this.bodyEl.innerHTML="",(t||[]).forEach((t,e)=>{const i=e+1,s=this._createLineElement(i,t||"");this.bodyEl.appendChild(s)}),this.updateLineCount?.()}rebindLineEvents(){try{this.bodyEl.querySelectorAll(".gcode-line").forEach(t=>{const e=parseInt(t.dataset.line);if(!isNaN(e)){const i=t.cloneNode(!0);t.parentNode.replaceChild(i,t),this._bindLineEvents(i,e)}})}catch(t){console.error("Error rebinding line events:",t)}}getText(){const t=[];return this.bodyEl.querySelectorAll(".gcode-line").forEach(e=>{t.push(e.querySelector(".gcode-line-text").textContent||"")}),t.join("\n")}setEditMode(t){this.editMode=t,this.bodyEl.querySelectorAll(".gcode-line-text").forEach(e=>{e.contentEditable=t}),this.rebindLineEvents()}createDeleteCommand(t,e){return{type:"delete",execute:()=>{t.forEach(t=>{const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);e&&e.remove()}),this.applySelection(new Set),this._renumberLines(),this.updateLineCount?.()},undo:()=>{e.forEach(({lineNum:t,text:e,originalIndex:i})=>{const s=this._createLineElement(t,e),n=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));i<n.length?this.bodyEl.insertBefore(s,n[i]):this.bodyEl.appendChild(s)}),this._renumberLines(),this.updateLineCount?.()}}}createInsertCommand(t,e){const i=t+1;return{type:"insert",startLine:i,lineCount:e.length,execute:()=>{const s=document.createDocumentFragment();e.forEach((t,e)=>{const n=this._createLineElement(i+e,t);s.appendChild(n)});const n=Array.from(this.bodyEl.querySelectorAll(".gcode-line"))[t]||null;n?this.bodyEl.insertBefore(s,n):this.bodyEl.appendChild(s),this._renumberLines(),this.updateLineCount?.();const o=[];for(let t=0;t<e.length;t++)o.push(i+t);this.applySelection(o)},undo:()=>{for(let t=e.length-1;t>=0;t--){const e=this.bodyEl.querySelector(`.gcode-line[data-line="${i+t}"]`);e&&e.remove()}this._renumberLines(),this.updateLineCount?.(),this.applySelection(new Set)}}}createMoveCommand(t,e){const i=[...t];return{type:"move",fromIndices:i,direction:e,execute:()=>{this.applySelection(i.map(t=>t+e)),this._moveSelectedLinesInternal(e)},undo:()=>{this.applySelection(i.map(t=>t+e)),this._moveSelectedLinesInternal(-e),this.applySelection(i)}}}createEditCommand(t,e,i){return{type:"edit",lineNum:t,oldText:e,newText:i,execute:()=>{const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);if(!e)return;const s=e.querySelector(".gcode-line-text");s&&(s.textContent=i,this._markLineAsChanged(t))},undo:()=>{const i=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);if(!i)return;const s=i.querySelector(".gcode-line-text");s&&(s.textContent=e,this._markLineAsChanged(t))}}}_renumberLines(){this.bodyEl.querySelectorAll(".gcode-line").forEach((t,e)=>{const i=e+1;t.dataset.line=String(i);const s=t.querySelector(".gcode-line-num");s&&(s.textContent=String(i))})}_moveSelectedLinesInternal(t){const e=Array.from(this.getSelection?.()||[]).sort((t,e)=>t-e);if(0!==e.length)try{const i=Array.from(this.bodyEl.querySelectorAll(".gcode-line")).length;if(-1===t&&e[0]<=1)return;if(1===t&&e[e.length-1]>=i)return;const s=e.map(t=>this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`)).filter(Boolean);if(0===s.length)return;const n=document.createDocumentFragment(),o=s.map(t=>({content:t.querySelector(".gcode-line-text").textContent,lineNum:parseInt(t.dataset.line)}));let a;a=-1===t?Math.max(0,e[0]-2):Math.min(i-s.length,e[e.length-1]),s.forEach(t=>t.remove());const r=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));o.forEach(e=>{const i=this._createLineElement(e.lineNum+t,e.content);n.appendChild(i)});const l=r[a];l?this.bodyEl.insertBefore(n,l):this.bodyEl.appendChild(n);const d=e.map(e=>e+t);this.applySelection(d),this._renumberLines()}catch(i){console.error("Error moving selected lines:",i)}}_markLineAsChanged(t){const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);e&&e.classList.add("has-changes")}_setCurrentlyEditing(t){if(null!==this.currentlyEditingLine){const t=this.bodyEl.querySelector(`.gcode-line[data-line="${this.currentlyEditingLine}"]`);t&&t.classList.remove("editing")}if(this.currentlyEditingLine=t,null!==t){const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);e&&e.classList.add("editing")}}_clearChangeIndicators(){this.bodyEl.querySelectorAll(".gcode-line.has-changes").forEach(t=>t.classList.remove("has-changes"))}_createLineElement(t,e){const i=document.createElement("div");i.className="gcode-line",i.dataset.line=String(t);const s=document.createElement("span");s.className="gcode-line-num",s.textContent=String(t);const n=document.createElement("span");n.className="gcode-line-text",n.contentEditable=this.editMode,n.textContent=e||"";const o=document.createElement("button");return o.className="gcode-del",o.title="Delete line",o.setAttribute("aria-label","Delete line"),o.textContent="×",i.appendChild(s),i.appendChild(n),i.appendChild(o),this._bindLineEvents(i,t),i}_bindLineEvents(t,e){try{t.addEventListener("mouseenter",()=>this.onHover?.(e)),t.addEventListener("mouseleave",()=>this.onLeave?.(e)),t.addEventListener("click",i=>{i.target&&i.target.classList?.contains("gcode-del")||this.editMode||this.onClick?.(e,t,i)});const i=t.querySelector(".gcode-line-text");i&&this.editMode&&(i.addEventListener("input",t=>{re(t.target),this._markLineAsChanged(e),this.onLineEdited?.(!1)}),i.addEventListener("focus",t=>{const i=t.target.textContent||"";this.editingOriginalText.set(e,i),this._setCurrentlyEditing(e)}),i.addEventListener("blur",t=>{re(t.target);const i=t.target.textContent||"",s=this.editingOriginalText.get(e);if(void 0!==s&&s!==i){const t=this.createEditCommand(e,s,i);this.undoSystem.push(t)}this.editingOriginalText.delete(e),this._setCurrentlyEditing(null),this.onLineEdited?.(!0)}),i.addEventListener("paste",t=>{t.preventDefault();const i=ae((t.clipboardData||window.clipboardData).getData("text/plain"));document.execCommand("insertText",!1,i),this._markLineAsChanged(e)}));const s=t.querySelector(".gcode-del");s&&s.addEventListener("click",t=>{t.stopPropagation();const i=this.getSelection?.()||new Set;i.has(e)&&i.size>1?this.onBulkDelete?.():this.onDeleteLine?.(e)})}catch(i){console.error("Error binding events for line",e,":",i)}}}class ue{constructor(t=document.body,e={}){this.eventBus=et.getInstance(),this.options={anchor:"right",debug:!1,...e},this.container=document.createElement("div"),this.container.className="gcode-drawer",this.headerEl=null,this.bodyEl=null,this.footerEl=null,this.toolbar=null,this.editor=null,this.lines=[],this.lineIndexToPathIndex=new Map,this.pathIndexToLineIndex=new Map,this.selectedLines=new Set,this.selection=new de,this.lastClickedLine=null,this._debounceTimer=null,this.maxHistorySize=50,this.undoSystem=new le({max:this.maxHistorySize,onChange:()=>this._updateUndoRedoButtons()}),this.editMode="edit"===localStorage.getItem("gcodeDrawerMode")||!1,this._pendingSelectionRestore=null,t.appendChild(this.container),this._applyAnchorClass(),this._render(),this._bindGlobalEvents()}_applyAnchorClass(){const t="left"===this.options.anchor?"left":"right";this.container.classList.remove("gcode-drawer--left","gcode-drawer--right"),this.container.classList.add(`gcode-drawer--${t}`)}_debug(...t){this.options.debug&&console.log("[GCodeDrawer]",...t)}_render(){this.container.innerHTML='\n      <div class="gcode-drawer-body" tabindex="0"></div>\n      <div class="gcode-drawer-footer">\n        <div class="gcode-help-text">Hover to preview • Click to select • Ctrl+click for multi-select</div>\n      </div>\n    ',this.toolbar=new he(this.container,{onClose:()=>this.toggle(!1),onUndo:()=>this._undo(),onRedo:()=>this._redo(),onMoveUp:()=>this._moveSelectedLines(-1),onMoveDown:()=>this._moveSelectedLines(1),onInsertPoints:async()=>{try{const t=this.selectedLines.size>0?Math.min(...this.selectedLines):null,e=null!=t?this.lineIndexToPathIndex.get(t)??null:null,i=await this._getClickedPointsFromApp();this.eventBus.emit("drawer:insert:points",{atIndex:e,points:i},{skipValidation:!0})}catch(t){console.error("Error inserting points:",t)}},onDeleteSelected:()=>this._onBulkDelete(),onModeToggle:t=>this._onModeToggle(t)}),this.headerEl=this.container.querySelector(".gcode-drawer-header"),this.bodyEl=this.container.querySelector(".gcode-drawer-body"),this.footerEl=this.container.querySelector(".gcode-drawer-footer"),this.bodyEl.addEventListener("keydown",t=>this._onKeyDown(t)),this.editor=new ce(this.bodyEl,{undoSystem:this.undoSystem,editMode:this.editMode,onLineEdited:t=>this._onLineEdited(t),onHover:t=>this._onHover(t),onLeave:t=>this._onLeave(t),onClick:(t,e,i)=>this._onClick(t,e,i),onDeleteLine:t=>this._onDelete(t),onBulkDelete:()=>this._onBulkDelete(),getSelection:()=>this.selectedLines,applySelection:t=>{const e=t instanceof Set?t:new Set(t||[]);this.selection.setSelection(e),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals()},updateLineCount:()=>this._updateLineCount()}),this.toolbar?.updateModeUI(this.editMode),this._applyModeClass(),this._updateHelpText()}_bindGlobalEvents(){this.eventBus.on("drawer:toggle",()=>this.toggle())}_applyModeClass(){this.container.classList.toggle("gcode-drawer--mode-edit",!!this.editMode),this.container.classList.toggle("gcode-drawer--mode-select",!this.editMode)}_updateHelpText(){const t=this.container.querySelector(".gcode-help-text");t&&(this.editMode?t.textContent="Edit mode: Click text to edit • Blur commits change • Undo/Redo while typing uses browser shortcuts":t.textContent="Select mode: Hover to preview • Click to select • Ctrl/Cmd+click for multi-select • Shift+click for range")}toggle(t){const e=this.container.classList.contains("open"),i="boolean"==typeof t?t:!e;this.container.classList.toggle("open",i)}setContent({text:t,mapping:e,preserveHistory:i=!1}){this.bodyEl.innerHTML="",this.lines=[],this.lineIndexToPathIndex.clear(),this.pathIndexToLineIndex.clear(),this.selection.clear(),this.selectedLines=this.selection.getSelection(),this.lastClickedLine=null,i?console.log("GCodeDrawer: Preserving undo/redo history, stack sizes:",this.undoSystem.getUndoCount(),this.undoSystem.getRedoCount()):(console.log("GCodeDrawer: Clearing undo/redo history"),this.undoSystem.clear());const s=(t||"").split(/\r?\n/);if(this.editor.setLines(s),this.lines=s.map((t,e)=>({num:e+1,text:t})),e?.forEach(t=>{"number"==typeof t?.line&&"number"==typeof t?.index&&(this.lineIndexToPathIndex.has(t.line)||this.lineIndexToPathIndex.set(t.line,t.index),this.pathIndexToLineIndex.has(t.index)||this.pathIndexToLineIndex.set(t.index,t.line))}),this._updateLineCount(),this._updateUndoRedoButtons(),this._pendingSelectionRestore&&(this._pendingSelectionRestore.size||this._pendingSelectionRestore.length)){const t=Array.from(this._pendingSelectionRestore);this._pendingSelectionRestore=null,this._restoreSelection(t)}}_onHover(t){const e=this.lineIndexToPathIndex.get(t);null!=e&&this.eventBus.emit("drawer:line:hover",{index:e},{skipValidation:!0})}_onLeave(t){this.eventBus.emit("drawer:line:leave",{},{skipValidation:!0})}_onClick(t,e,i){i.shiftKey&&null!=this.lastClickedLine?this._selectRange(Math.min(this.lastClickedLine,t),Math.max(this.lastClickedLine,t)):i.ctrlKey||i.metaKey?this._toggleSelection(t,e):this._selectSingle(t,e),this.lastClickedLine=t,this._updateSelectionVisuals();const s=Math.min(...this.selectedLines),n=this.lineIndexToPathIndex.get(s);null!=n&&this.eventBus.emit("drawer:line:click",{index:n},{skipValidation:!0})}_selectSingle(t,e){this.selection.selectSingle(t),this.selectedLines=this.selection.getSelection()}_toggleSelection(t,e){this.selection.setSelection(this.selectedLines).toggle(t),this.selectedLines=this.selection.getSelection()}_selectRange(t,e){this.selection.selectRange(t,e),this.selectedLines=this.selection.getSelection()}_updateSelectionVisuals(){this.editor&&this.editor.updateSelectionClasses(this.selectedLines);const t=this.selectedLines.size,e=t>0;this.toolbar&&this.toolbar.updateSelectionUI(e,t)}_restoreSelection(t){console.log("GCodeDrawer: Restoring selection to lines:",t);const e=[];t.forEach(t=>{this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`)&&e.push(t)}),this.selection.setSelection(e),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals()}_updateLineCount(){const t=this.bodyEl?this.bodyEl.querySelectorAll(".gcode-line").length:this.lines.length;this.toolbar&&this.toolbar.updateLineCount(t)}_undo(){if(!this.undoSystem.canUndo())return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.undoSystem.undo();if(t)if(this._debug("Executed undo for command:",t.type),"move"===t.type){const t=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(t)},0)}else this._pendingSelectionRestore=new Set(this.selectedLines),this._emitContentChanged(this.getText())}_redo(){if(!this.undoSystem.canRedo())return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.undoSystem.redo();if(t)if(this._debug("Executed redo for command:",t.type),"move"===t.type){const t=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(t)},0)}else this._pendingSelectionRestore=new Set(this.selectedLines),this._emitContentChanged(this.getText())}_updateUndoRedoButtons(){const t=this.undoSystem.getUndoCount(),e=this.undoSystem.getRedoCount();this._debug("Updating undo/redo buttons. Undo stack:",t,"Redo stack:",e),this.toolbar&&this.toolbar.setUndoRedoState(t,e)}insertPointsAt(t,e){if(!Array.isArray(e)||0===e.length)return;this.getText();let i=null;"number"==typeof t&&this.pathIndexToLineIndex.has(t)&&(i=this.pathIndexToLineIndex.get(t)),null==i&&(i=this.selectedLines.size>0?Math.min(...this.selectedLines):1);const s=e.flatMap((t,e)=>[`; inserted G0 P${e+1}`,`G0 X${t.x.toFixed(3)} Y${t.y.toFixed(3)}`]),n=this.editor.createInsertCommand(i,s);this.undoSystem.push(n),n.execute();const o=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(o)},0)}getText(){return this.editor?this.editor.getText():""}async _getClickedPointsFromApp(){return new Promise(t=>{const e=({points:i})=>{this.eventBus.off(L,e),t(i||[])};this.eventBus.on(L,e),this.eventBus.emit(I,{},{skipValidation:!0}),setTimeout(()=>{this.eventBus.off(L,e),t([])},1e3)})}_onLineEdited(t=!1){this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const e=()=>this._emitContentChanged(this.getText());t?(this._pendingSelectionRestore=new Set(this.selectedLines),e()):(this._pendingSelectionRestore=new Set(this.selectedLines),this._debounceTimer=setTimeout(e,3e3))}_onDelete(t){const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`);if(!e)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const i=Array.from(this.bodyEl.querySelectorAll(".gcode-line")),s=[{lineNum:t,text:e.querySelector(".gcode-line-text").textContent,originalIndex:i.indexOf(e)}],n=this.editor.createDeleteCommand([t],s);this.undoSystem.push(n),n.execute(),this.lines=this.lines.filter(e=>e.num!==t);const o=new Set(this.selectedLines);o.delete(t),this.selection.setSelection(o),this.selectedLines=this.selection.getSelection(),this.lastClickedLine===t&&(this.lastClickedLine=null),this._emitContentChanged(this.getText())}_onKeyDown(t){if(!t.target||!t.target.isContentEditable&&!t.target.closest?.(".gcode-line-text")){if((t.ctrlKey||t.metaKey)&&!t.shiftKey)switch(t.key.toLowerCase()){case"z":return t.preventDefault(),void this._undo();case"y":return t.preventDefault(),void this._redo()}if((t.ctrlKey||t.metaKey)&&t.shiftKey&&"z"===t.key.toLowerCase())return t.preventDefault(),void this._redo();"Delete"!==t.key&&"Backspace"!==t.key||this.selectedLines.size>0&&(t.preventDefault(),this._onBulkDelete()),"Escape"===t.key&&this.selectedLines.size>0&&(this.selection.clear(),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals())}}_onBulkDelete(){if(0===this.selectedLines.size)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.selectedLines.size;if(t>3&&!confirm(`Delete ${t} selected lines? Use Ctrl+Z to undo if needed.`))return;const e=Array.from(this.selectedLines).sort((t,e)=>t-e),i=e.map(t=>{const e=this.bodyEl.querySelector(`.gcode-line[data-line="${t}"]`),i=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));return{lineNum:t,text:e?e.querySelector(".gcode-line-text").textContent:"",originalIndex:i.indexOf(e)}}),s=this.editor.createDeleteCommand(e,i);this.undoSystem.push(s),s.execute(),this._emitContentChanged(this.getText())}_moveSelectedLines(t){if(0===this.selectedLines.size)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const e=Array.from(this.selectedLines).sort((t,e)=>t-e),i=this.editor.createMoveCommand(e,t);this.undoSystem.push(i),this.editor._moveSelectedLinesInternal(t);const s=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(s)},0)}_onModeToggle(t){if(this.editMode="edit"===t,localStorage.setItem("gcodeDrawerMode",t),this.editor?.setEditMode(this.editMode),this.toolbar?.updateModeUI(this.editMode),!this.editMode){const t=this.selectedLines.size;this.toolbar?.updateSelectionUI(t>0,t)}this._applyModeClass(),this._updateHelpText(),this._debug("Mode toggled to:",t,"editMode:",this.editMode)}_emitContentChanged(t){const e=ae(t);this.eventBus.emit("drawer:content:changed",{text:e},{skipValidation:!0})}}class pe{constructor(t,e){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas element is required");if(!e)throw new Error("Viewport instance is required");this.canvas=t,this.viewport=e,this.eventBus=et.getInstance(),this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.lastWheelTime=0,this.wheelThrottleDelay=16,this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this._handleClick=this._handleClick.bind(this),this._handleWheel=this._handleWheel.bind(this),this._handleContextMenu=this._handleContextMenu.bind(this),this._handleMouseEnter=this._handleMouseEnter.bind(this),this._handleMouseLeave=this._handleMouseLeave.bind(this)}init(){this.isInitialized?console.warn("MouseEventHandler already initialized"):(this.canvas.addEventListener("mousemove",this._handleMouseMove),this.canvas.addEventListener("mousedown",this._handleMouseDown),this.canvas.addEventListener("mouseup",this._handleMouseUp),this.canvas.addEventListener("click",this._handleClick),this.canvas.addEventListener("wheel",this._handleWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",this._handleContextMenu),this.canvas.addEventListener("mouseenter",this._handleMouseEnter),this.canvas.addEventListener("mouseleave",this._handleMouseLeave),this.canvas.style.cursor=mt,this.isInitialized=!0)}_handleMouseMove(t){if(this.isDestroyed)return;const e=st.createMouseEventData(t,this.viewport);this.isDragging&&(this.viewport.updateDrag(e.screenX,e.screenY),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height})),this.eventBus.emit(g,e)}_handleMouseDown(t){if(this.isDestroyed)return;const e=st.createMouseEventData(t,this.viewport);(1===t.button||0===t.button&&t.shiftKey)&&(this.isDragging=!0,this.dragStartX=e.screenX,this.dragStartY=e.screenY,this.viewport.startDrag(e.screenX,e.screenY),t.preventDefault()),this.eventBus.emit(v,e)}_handleMouseUp(t){if(this.isDestroyed)return;const e=st.createMouseEventData(t,this.viewport);this.isDragging&&(this.isDragging=!1,this.viewport.endDrag(),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height})),this.eventBus.emit(f,e)}_handleClick(t){if(this.isDestroyed)return;if(t.shiftKey)return void console.log("Click ignored - shift key held for panning");const e=st.createMouseEventData(t,this.viewport),i=this.viewport.debugCoordinateConversion(t);console.log("Click handler - mouse data:",e),console.log("Coordinate conversion accuracy:",i),this.viewport.isValidCoordinate(e.worldX)&&this.viewport.isValidCoordinate(e.worldY)?(console.log("Emitting MOUSE_CLICK event with valid coordinates"),this.eventBus.emit(m,e)):console.log("Click ignored - invalid coordinates:",e.worldX,e.worldY)}_handleWheel(t){if(this.isDestroyed)return;t.preventDefault();const e=Date.now();if(e-this.lastWheelTime<this.wheelThrottleDelay)return;this.lastWheelTime=e;const i=st.createMouseEventData(t,this.viewport),s=t.deltaY>0?-1:1,n=this.canvas.width/2,o=this.canvas.height/2;this.viewport.zoomAtPoint(n,o,s),this.eventBus.emit(h,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height}),this.eventBus.emit(y,{...i,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ||0,deltaMode:t.deltaMode})}_handleContextMenu(t){t.preventDefault()}_handleMouseEnter(t){if(this.isDestroyed)return;const e=st.createMouseEventData(t,this.viewport);this.eventBus.emit(b,e)}_handleMouseLeave(t){if(this.isDestroyed)return;const e=st.createMouseEventData(t,this.viewport);this.eventBus.emit(x,e),this.isDragging&&(this.isDragging=!1,this.viewport.endDrag())}getState(){return{isDragging:this.isDragging,dragStartX:this.dragStartX,dragStartY:this.dragStartY,isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}setEnabled(t){this.canvas.style.pointerEvents=t?"auto":"none"}setCursor(t){this.canvas.style.cursor=t}destroy(){this.isDestroyed||(this.canvas.removeEventListener("mousemove",this._handleMouseMove),this.canvas.removeEventListener("mousedown",this._handleMouseDown),this.canvas.removeEventListener("mouseup",this._handleMouseUp),this.canvas.removeEventListener("click",this._handleClick),this.canvas.removeEventListener("wheel",this._handleWheel),this.canvas.removeEventListener("contextmenu",this._handleContextMenu),this.canvas.removeEventListener("mouseenter",this._handleMouseEnter),this.canvas.removeEventListener("mouseleave",this._handleMouseLeave),this.isDragging=!1,this.canvas.style.cursor=mt,this.isDestroyed=!0)}}class ge{constructor(t=document,e=null){this.targetElement=t,this.viewport=e,this.eventBus=et.getInstance(),this.shortcuts=new Map,this.isInitialized=!1,this.isDestroyed=!1,this.pressedKeys=new Set,this.lastKeyTime=0,this.keyThrottleDelay=50,this._bindMethods(),this._registerDefaultShortcuts()}_bindMethods(){this._handleKeyDown=this._handleKeyDown.bind(this),this._handleKeyUp=this._handleKeyUp.bind(this),this._handleKeyPress=this._handleKeyPress.bind(this)}init(){this.isInitialized?console.warn("KeyboardHandler already initialized"):(this.targetElement.addEventListener("keydown",this._handleKeyDown),this.targetElement.addEventListener("keyup",this._handleKeyUp),this.targetElement.addEventListener("keypress",this._handleKeyPress),this.isInitialized=!0)}_registerDefaultShortcuts(){this.registerShortcut("KeyG",{description:"Toggle grid visibility",action:()=>{this.eventBus.emit(D)}}),this.registerShortcut("Equal",{description:"Zoom in",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.zoomIn(),this.eventBus.emit(h,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("Minus",{description:"Zoom out",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.zoomOut(),this.eventBus.emit(h,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("Digit0",{description:"Reset zoom to 100%",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.setZoom(rt),this.eventBus.emit(h,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("KeyF",{description:"Fit to screen",action:()=>{this.eventBus.emit(p)}}),this.registerShortcut("KeyR",{description:"Reset viewport",action:()=>{this.viewport&&(this.viewport.reset(),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("KeyC",{description:"Clear all points",requiresCtrl:!0,action:()=>{this.eventBus.emit(E)}}),this.registerShortcut("ArrowLeft",{description:"Pan left",action:()=>{this.viewport&&(this.viewport.pan(pt,0),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowRight",{description:"Pan right",action:()=>{this.viewport&&(this.viewport.pan(-50,0),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowUp",{description:"Pan up",action:()=>{this.viewport&&(this.viewport.pan(0,-50),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowDown",{description:"Pan down",action:()=>{this.viewport&&(this.viewport.pan(0,pt),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}})}_handleKeyDown(t){if(this.isDestroyed)return;if(this._isInputFocused())return;const e=st.createKeyboardEventData(t);this.pressedKeys.add(t.code);const i=this._findMatchingShortcut(t);if(i){t.preventDefault();const n=Date.now();if(n-this.lastKeyTime<this.keyThrottleDelay)return;this.lastKeyTime=n;try{i.action(),this.eventBus.emit(H,{...e,shortcut:i.description})}catch(s){console.error("Error executing keyboard shortcut:",s)}}this.eventBus.emit(A,e)}_handleKeyUp(t){if(this.isDestroyed)return;const e=st.createKeyboardEventData(t);this.pressedKeys.delete(t.code),this.eventBus.emit(R,e)}_handleKeyPress(t){if(this.isDestroyed)return;if(this._isInputFocused())return;const e=st.createKeyboardEventData(t);console.debug("KeyPress event:",e)}_isInputFocused(){const t=document.activeElement;return t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||"true"===t.contentEditable)}_findMatchingShortcut(t){for(const[e,i]of this.shortcuts)if(t.code===e){if(i.requiresCtrl&&!t.ctrlKey)continue;if(i.requiresShift&&!t.shiftKey)continue;if(i.requiresAlt&&!t.altKey)continue;if(i.requiresMeta&&!t.metaKey)continue;if(i.forbidCtrl&&t.ctrlKey)continue;if(i.forbidShift&&t.shiftKey)continue;if(i.forbidAlt&&t.altKey)continue;if(i.forbidMeta&&t.metaKey)continue;return i}return null}registerShortcut(t,e){if("string"!=typeof t)throw new Error("Key code must be a string");if(!e||"function"!=typeof e.action)throw new Error("Shortcut must have an action function");this.shortcuts.set(t,{description:e.description||"Custom shortcut",action:e.action,requiresCtrl:e.requiresCtrl||!1,requiresShift:e.requiresShift||!1,requiresAlt:e.requiresAlt||!1,requiresMeta:e.requiresMeta||!1,forbidCtrl:e.forbidCtrl||!1,forbidShift:e.forbidShift||!1,forbidAlt:e.forbidAlt||!1,forbidMeta:e.forbidMeta||!1})}unregisterShortcut(t){this.shortcuts.delete(t)}getShortcuts(){return new Map(this.shortcuts)}getPressedKeys(){return new Set(this.pressedKeys)}isKeyPressed(t){return this.pressedKeys.has(t)}clearPressedKeys(){this.pressedKeys.clear()}getHelpText(){return Array.from(this.shortcuts.entries()).map(([t,e])=>{let i=t.replace(/^Key/,"").replace(/^Digit/,"");const s=[];return e.requiresCtrl&&s.push("Ctrl"),e.requiresShift&&s.push("Shift"),e.requiresAlt&&s.push("Alt"),e.requiresMeta&&s.push("Meta"),s.length>0&&(i=s.join("+")+"+"+i),`${i}: ${e.description}`}).join("\n")}destroy(){this.isDestroyed||(this.targetElement.removeEventListener("keydown",this._handleKeyDown),this.targetElement.removeEventListener("keyup",this._handleKeyUp),this.targetElement.removeEventListener("keypress",this._handleKeyPress),this.shortcuts.clear(),this.pressedKeys.clear(),this.isDestroyed=!0)}}class me{constructor(t={}){this.config={tapThreshold:10,tapTimeout:300,doubleTapTimeout:500,longPressTimeout:800,pinchThreshold:50,preventContextMenu:!0,...t},this.touches=new Map,this.lastTouchTime=0,this.touchThrottleDelay=16,this.gestureState={type:null,startTime:0,lastDistance:0,lastCenter:{x:0,y:0},tapCount:0,tapTimeout:null}}detectGestureStart(t){const e=t.length;return this.updateTouchTracking(t,"start"),1===e?this._handleSingleTouchStart(t[0]):2===e?this._handlePinchStart(t[0],t[1]):(this.resetGestureState(),{type:"unknown",touchCount:e})}detectGestureMove(t){const e=t.length;return Date.now()-this.lastTouchTime<this.touchThrottleDelay?{type:this.gestureState.type,throttled:!0}:(this.updateTouchTracking(t,"move"),1===e?this._handleSingleTouchMove(t[0]):2===e?this._handlePinchMove(t[0],t[1]):{type:this.gestureState.type,touchCount:e})}detectGestureEnd(t,e){return t.forEach(t=>{this.touches.delete(t.identifier)}),0===e.length?this._handleGestureEnd(t[0]):1===e.length&&"zoom"===this.gestureState.type?this._handleSingleTouchStart(e[0]):{type:this.gestureState.type,remainingTouches:e.length}}updateTouchTracking(t,e="move"){const i=Date.now();t.forEach(t=>{if("start"===e)this.touches.set(t.identifier,{id:t.identifier,startX:t.clientX,startY:t.clientY,currentX:t.clientX,currentY:t.clientY,startTime:i});else if("move"===e){const e=this.touches.get(t.identifier);e&&(e.currentX=t.clientX,e.currentY=t.clientY)}}),this.lastTouchTime=i}_handleSingleTouchStart(t){const e=Date.now();return e-this.lastTouchTime<this.config.doubleTapTimeout?this.gestureState.tapCount++:this.gestureState.tapCount=1,this.gestureState.type="potential-tap",this.gestureState.startTime=e,this.gestureState.lastCenter={x:t.clientX,y:t.clientY},this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),{type:"potential-tap",tapCount:this.gestureState.tapCount,center:this.gestureState.lastCenter}}_handlePinchStart(t,e){const i=this.calculateDistance(t,e),s=this.calculateCenter(t,e);return this.gestureState.type="zoom",this.gestureState.startTime=Date.now(),this.gestureState.lastDistance=i,this.gestureState.lastCenter=s,this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),{type:"zoom",distance:i,center:s,startDistance:i}}_handleSingleTouchMove(t){const e=this.touches.get(t.identifier);if(!e)return{type:"unknown",error:"Touch not tracked"};const i=t.clientX-e.startX,s=t.clientY-e.startY,n=Math.sqrt(i*i+s*s);if(n>this.config.tapThreshold&&("potential-tap"===this.gestureState.type&&(this.gestureState.type="pan",this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null)),"pan"===this.gestureState.type)){const e=t.clientX-this.gestureState.lastCenter.x,i=t.clientY-this.gestureState.lastCenter.y;return this.gestureState.lastCenter={x:t.clientX,y:t.clientY},{type:"pan",deltaX:e,deltaY:i,totalDistance:n}}return{type:this.gestureState.type,distance:n}}_handlePinchMove(t,e){const i=this.calculateDistance(t,e),s=this.calculateCenter(t,e);if("zoom"===this.gestureState.type){const t=i-this.gestureState.lastDistance;if(Math.abs(t)>this.config.pinchThreshold)return this.gestureState.lastDistance=i,{type:"zoom",distance:i,center:s,distanceDelta:t,zoomDirection:t>0?"out":"in"}}return{type:"zoom",distance:i,center:s,distanceDelta:0}}_handleGestureEnd(t){const e=this.gestureState.type;let i={type:e,completed:!0};return"potential-tap"===e?i={type:"tap",tapCount:this.gestureState.tapCount,touch:t,completed:!0}:"pan"===e?i={type:"pan-end",completed:!0}:"zoom"===e&&(i={type:"zoom-end",completed:!0}),this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),this.resetGestureState(),i}calculateDistance(t,e){const i=t.clientX-e.clientX,s=t.clientY-e.clientY;return Math.sqrt(i*i+s*s)}calculateCenter(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}resetGestureState(){this.gestureState.type=null,this.gestureState.startTime=0,this.gestureState.lastDistance=0,this.gestureState.lastCenter={x:0,y:0}}handleTouchCancel(){this.touches.clear(),this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),this.resetGestureState()}getGestureState(){return{...this.gestureState}}updateConfig(t){this.config={...this.config,...t}}getTouchState(){return{touchCount:this.touches.size,lastTouchTime:this.lastTouchTime,gestureType:this.gestureState.type,tapCount:this.gestureState.tapCount}}}class ve{constructor(t,e){if(!t)throw new Error("Viewport instance is required");if(!e)throw new Error("EventBus instance is required");this.viewport=t,this.eventBus=e}handleTap(t,e=1){1===e?this.eventBus.emit(m,t):2===e&&this.eventBus.emit(p,{gesture:"double-tap",touch:t})}handleLongPress(t){this.eventBus.emit(m,{...t,button:2,gesture:"long-press"})}handlePan(t,e){(t.deltaX||t.deltaY)&&(this.viewport.pan(t.deltaX,-t.deltaY),this.eventBus.emit(c,{...this.viewport.getState(),canvasWidth:e.width,canvasHeight:e.height,gesture:"touch-pan"}))}handleZoom(t,e){if(!t.distanceDelta||0===t.distanceDelta)return;const i=e.getBoundingClientRect(),s=t.center.x-i.left,n=t.center.y-i.top,o=t.distanceDelta>0?1:-1;this.viewport.zoomAtPoint(s,n,o),this.eventBus.emit(h,{...this.viewport.getState(),canvasWidth:e.width,canvasHeight:e.height,gesture:"touch-zoom"})}createTouchEventData(t){const e={clientX:t.clientX,clientY:t.clientY,button:0,ctrlKey:!1,shiftKey:!1,altKey:!1,target:t.target,type:"touch",preventDefault:()=>{},stopPropagation:()=>{}};return st.createMouseEventData(e,this.viewport)}handlePanStart(t){return{type:"pan-start",startCenter:t.center}}handlePanEnd(t){return{type:"pan-end",completed:!0}}handleZoomStart(t){return{type:"zoom-start",startDistance:t.distance,startCenter:t.center}}handleZoomEnd(t){return{type:"zoom-end",completed:!0}}processGesture(t,e,i=null){switch(t.type){case"tap":const s=this.createTouchEventData(i||t.touch);this.handleTap(s,t.tapCount);break;case"long-press":const n=this.createTouchEventData(i);this.handleLongPress(n);break;case"pan":this.handlePan(t,e);break;case"pan-start":return this.handlePanStart(t);case"pan-end":return this.handlePanEnd(t);case"zoom":this.handleZoom(t,e);break;case"zoom-start":return this.handleZoomStart(t);case"zoom-end":return this.handleZoomEnd(t)}return{processed:!0,type:t.type}}getState(){return{viewport:this.viewport.getState(),hasEventBus:!!this.eventBus,hasViewport:!!this.viewport}}}class fe{constructor(t,e){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas element is required");if(!e)throw new Error("Viewport instance is required");this.canvas=t,this.viewport=e,this.eventBus=et.getInstance(),this.config={tapThreshold:10,tapTimeout:300,doubleTapTimeout:500,longPressTimeout:800,pinchThreshold:50,preventContextMenu:!0},this.touchGestures=new me(this.config),this.touchInteractions=new ve(this.viewport,this.eventBus),this._currentLongPressTimeout=null,this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),this._handleTouchCancel=this._handleTouchCancel.bind(this),this._handleContextMenu=this._handleContextMenu.bind(this)}init(){this.isInitialized?console.warn("TouchEventHandler already initialized"):(this.canvas.addEventListener("touchstart",this._handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this._handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this._handleTouchEnd,{passive:!1}),this.canvas.addEventListener("touchcancel",this._handleTouchCancel,{passive:!1}),this.config.preventContextMenu&&this.canvas.addEventListener("contextmenu",this._handleContextMenu),this.isInitialized=!0)}_handleTouchStart(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.touches),i=this.touchGestures.detectGestureStart(e);this._setupLongPressDetection(i,e[0])}_handleTouchMove(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.touches),i=this.touchGestures.detectGestureMove(e);!i.throttled&&i.type&&"unknown"!==i.type&&this.touchInteractions.processGesture(i,this.canvas)}_handleTouchEnd(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.changedTouches),i=Array.from(t.touches),s=this.touchGestures.detectGestureEnd(e,i);s.completed&&this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),(s.completed||"tap"===s.type)&&this.touchInteractions.processGesture(s,this.canvas,e[0])}_setupLongPressDetection(t,e){"potential-tap"===t.type&&(this._currentLongPressTimeout&&clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=setTimeout(()=>{if("potential-tap"===this.touchGestures.getGestureState().type){const t=this.touchInteractions.createTouchEventData(e);this.touchInteractions.handleLongPress(t)}this._currentLongPressTimeout=null},this.config.longPressTimeout))}_handleTouchCancel(t){this.isDestroyed||(this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),this.touchGestures.handleTouchCancel())}_handleContextMenu(t){t.preventDefault()}getState(){return{...this.touchGestures.getTouchState(),...this.touchInteractions.getState(),isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}setEnabled(t){this.canvas.style.touchAction=t?"none":"auto"}updateConfig(t){this.config={...this.config,...t},this.touchGestures.updateConfig(t)}destroy(){this.isDestroyed||(this.canvas.removeEventListener("touchstart",this._handleTouchStart),this.canvas.removeEventListener("touchmove",this._handleTouchMove),this.canvas.removeEventListener("touchend",this._handleTouchEnd),this.canvas.removeEventListener("touchcancel",this._handleTouchCancel),this.config.preventContextMenu&&this.canvas.removeEventListener("contextmenu",this._handleContextMenu),this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),this.touchGestures.handleTouchCancel(),this.isDestroyed=!0)}}class ye{constructor(t=document){this.rootElement=t,this.eventBus=et.getInstance(),this.delegations=new Map,this.isInitialized=!1,this.isDestroyed=!1,this.dragOverlay=null,this.dragOverlayTimer=null,this._bindMethods()}_bindMethods(){this._handleDelegatedEvent=this._handleDelegatedEvent.bind(this)}init(){this.isInitialized?console.warn("EventDelegator already initialized"):(this._registerDefaultDelegations(),this._addGlobalDragHandlers(),this.isInitialized=!0)}_registerDefaultDelegations(){this.addDelegation("click","button",(t,e)=>{const i=e.dataset.action||e.onclick?.toString()||"button-click";this.eventBus.emit(P,{action:i,element:e,event:t})}),this.addDelegation("click",".delete-point-btn",(t,e)=>{const i=e.dataset.pointId;this.eventBus.emit(S,{id:i,element:e,event:t})}),this.addDelegation("change",'input[type="file"]',(t,i)=>{Array.from(i.files||[]).forEach(s=>{this.eventBus.emit(e,{name:s.name,size:s.size,type:s.type,file:s,element:i,event:t})})}),this.addDelegation("click",".zoom-in",(t,e)=>{this.eventBus.emit(h,{action:"zoom-in",element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".zoom-out",(t,e)=>{this.eventBus.emit(h,{action:"zoom-out",element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".fit-to-screen",(t,e)=>{this.eventBus.emit(p,{element:e,event:t})}),this.addDelegation("click",".clear-points",(t,e)=>{this.eventBus.emit(E,{element:e,event:t})}),this.addDelegation("click",".export-points",(t,e)=>{this.eventBus.emit(B,{type:"points",element:e,event:t})}),this.addDelegation("click",".grid-toggle",(t,e)=>{this.eventBus.emit(M,{element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".theme-toggle",(t,e)=>{this.eventBus.emit(z,{element:e,event:t})}),this.addDelegation("click",".sidebar-toggle",(t,e)=>{this.eventBus.emit(k,{element:e,event:t})}),this.addDelegation("click","[data-nav]",(t,e)=>{const i=e.dataset.nav;this.eventBus.emit(P,{action:"navigate",target:i,element:e,event:t})}),this.addDelegation("submit","form",(t,i)=>{t.preventDefault();const s=new FormData(i),n=Object.fromEntries(s.entries());this.eventBus.emit(e,{type:"form-submit",data:n,element:i,event:t})}),this.addDelegation("dragover",".file-drop-area, canvas, .file-input-label",(t,e)=>{t.preventDefault(),t.dataTransfer.dropEffect="copy",e.classList.add("drag-over"),this._showDragOverlay()}),this.addDelegation("dragleave",".file-drop-area, canvas, .file-input-label",(t,e)=>{t.preventDefault(),e.contains(t.relatedTarget)||e.classList.remove("drag-over")}),this.addDelegation("drop",".file-drop-area, canvas, .file-input-label",(t,i)=>{t.preventDefault(),i.classList.remove("drag-over"),this._hideDragOverlay();const s=Array.from(t.dataTransfer.files||[]);if(0===s.length)return void this.eventBus.emit(X,{type:"warning",message:"No files were dropped"});s.length>1&&this.eventBus.emit(X,{type:"warning",message:`Multiple files dropped. Using first file: ${s[0].name}`});const n=s[0];this.eventBus.emit(e,{name:n.name,size:n.size,type:n.type,file:n,element:i,event:t,isDrop:!0,source:"drag-drop"})})}addDelegation(t,e,i,s={}){if("string"!=typeof t)throw new Error("Event type must be a string");if("string"!=typeof e)throw new Error("Selector must be a string");if("function"!=typeof i)throw new Error("Handler must be a function");const n=`${t}:${e}`;this.delegations.has(n)||this.delegations.set(n,{eventType:t,selector:e,handlers:[],listener:null});const o=this.delegations.get(n);return o.handlers.push(i),1===o.handlers.length&&(o.listener=t=>{this._handleDelegatedEvent(t,e,n)},this.rootElement.addEventListener(t,o.listener,{capture:!0,...s})),()=>{this.removeDelegation(t,e,i)}}removeDelegation(t,e,i=null){const s=`${t}:${e}`,n=this.delegations.get(s);n&&(n.handlers=i?n.handlers.filter(t=>t!==i):[],0===n.handlers.length&&(n.listener&&this.rootElement.removeEventListener(t,n.listener,!0),this.delegations.delete(s)))}_handleDelegatedEvent(t,e,i){if(this.isDestroyed)return;const s=t.target.closest(e);if(!s)return;const n=this.delegations.get(i);n&&n.handlers.forEach(e=>{try{e(t,s)}catch(n){console.error(`Error in delegated event handler for ${i}:`,n)}})}getDelegations(){return new Map(this.delegations)}getStats(){const t={totalDelegations:this.delegations.size,totalHandlers:0,eventTypes:new Set,selectors:new Set};return this.delegations.forEach((e,i)=>{t.totalHandlers+=e.handlers.length,t.eventTypes.add(e.eventType),t.selectors.add(e.selector)}),{...t,eventTypes:Array.from(t.eventTypes),selectors:Array.from(t.selectors)}}clearDelegations(){this.delegations.forEach((t,e)=>{const[i]=e.split(":");t.listener&&this.rootElement.removeEventListener(i,t.listener,!0)}),this.delegations.clear()}_addGlobalDragHandlers(){document.addEventListener("dragleave",t=>{0===t.clientX&&0===t.clientY&&this._hideDragOverlay()}),window.addEventListener("blur",()=>{this._hideDragOverlay()})}_showDragOverlay(){this.dragOverlayTimer&&(clearTimeout(this.dragOverlayTimer),this.dragOverlayTimer=null),this.dragOverlay||(this.dragOverlay=document.createElement("div"),this.dragOverlay.className="drag-overlay",this.dragOverlay.innerHTML='\n        <div class="drag-overlay-content">\n          <div class="drag-overlay-icon">📁</div>\n          <div class="drag-overlay-text">Drop G-code file here</div>\n        </div>\n      ',document.body.appendChild(this.dragOverlay)),this.dragOverlay.style.display="flex",requestAnimationFrame(()=>{this.dragOverlay.classList.add("visible")})}_hideDragOverlay(){this.dragOverlay&&(this.dragOverlay.classList.remove("visible"),this.dragOverlayTimer=setTimeout(()=>{this.dragOverlay&&(this.dragOverlay.style.display="none")},300))}destroy(){this.isDestroyed||(this.clearDelegations(),this.dragOverlay&&(this.dragOverlay.remove(),this.dragOverlay=null),this.dragOverlayTimer&&(clearTimeout(this.dragOverlayTimer),this.dragOverlayTimer=null),this.isDestroyed=!0)}}class be{constructor(t,e,i={}){this.canvas=t,this.viewport=e,this.options={enableMouse:!0,enableKeyboard:!0,enableTouch:!0,enableDelegation:!0,...i},this.eventBus=et.getInstance(),this.mouseHandler=null,this.keyboardHandler=null,this.touchHandler=null,this.delegator=null,this.isInitialized=!1,this.isDestroyed=!1}async init(){if(this.isInitialized)console.warn("EventIntegration already initialized");else try{this.options.enableMouse&&(this.mouseHandler=new pe(this.canvas,this.viewport),this.mouseHandler.init()),this.options.enableKeyboard&&(this.keyboardHandler=new ge(document,this.viewport),this.keyboardHandler.init()),this.options.enableTouch&&(this.touchHandler=new fe(this.canvas,this.viewport),this.touchHandler.init()),this.options.enableDelegation&&(this.delegator=new ye(document),this.delegator.init()),this.isInitialized=!0,console.log("EventIntegration initialized successfully")}catch(t){throw console.error("Failed to initialize EventIntegration:",t),t}}getStats(){return{mouse:this.mouseHandler?.getState()||null,keyboard:this.keyboardHandler?.getPressedKeys()||null,touch:this.touchHandler?.getState()||null,delegation:this.delegator?.getStats()||null,eventBus:this.eventBus.getStats()}}setEventTypeEnabled(t,e){switch(t){case"mouse":this.mouseHandler&&this.mouseHandler.setEnabled(e);break;case"keyboard":case"delegation":break;case"touch":this.touchHandler&&this.touchHandler.setEnabled(e);break;default:console.warn(`Unknown event type: ${t}`)}}registerKeyboardShortcut(t,e){this.keyboardHandler&&this.keyboardHandler.registerShortcut(t,e)}registerDelegation(t,e,i){return this.delegator?this.delegator.addDelegation(t,e,i):()=>{}}updateTouchConfig(t){this.touchHandler&&this.touchHandler.updateConfig(t)}getKeyboardHelp(){return this.keyboardHandler?.getHelpText()||"Keyboard handler not available"}clearPressedKeys(){this.keyboardHandler&&this.keyboardHandler.clearPressedKeys()}isKeyPressed(t){return this.keyboardHandler?.isKeyPressed(t)||!1}getMouseState(){return this.mouseHandler?.getState()||null}getTouchState(){return this.touchHandler?.getState()||null}destroy(){this.isDestroyed||(this.mouseHandler&&(this.mouseHandler.destroy(),this.mouseHandler=null),this.keyboardHandler&&(this.keyboardHandler.destroy(),this.keyboardHandler=null),this.touchHandler&&(this.touchHandler.destroy(),this.touchHandler=null),this.delegator&&(this.delegator.destroy(),this.delegator=null),this.isDestroyed=!0)}}function xe(t){const n=et.getInstance(),o=[],a=(t,e,i)=>{const s=n.on(t,e,i);return o.push(s),s};a(e,()=>{t.statusMessage?.show("Loading G-Code file...","info")}),a(i,async e=>{try{if(t.currentGCode={path:e.path,bounds:e.bounds,stats:e.stats},t.canvas?.setGCodePath(e.path),t.canvas?.viewport.fitToBounds(e.bounds),t.canvas?.redraw(),t.gcodeDrawer&&t.toolbar?.fileHandler?.loadedData){const n=t.toolbar.fileHandler.loadedData.content;try{const i=function(t){if("string"!=typeof t)return"";const e=t.split(/\r?\n/),i=[];let s=0;for(e.length&&"%"===e[0].trim()&&(s=1);s<e.length;s++){let t=e[s];if(!t){i.push("");continue}let n=t.trim();if("%"!==n){if(n=n.replace(/^N\d+\s+/i,""),n=Qt(n),/\bG92\b/i.test(n)){const t=/\bX-?\d+(?:\.\d+)?\b/i.test(n),e=/\bY-?\d+(?:\.\d+)?\b/i.test(n);if(!t&&!e){const t=(0).toFixed(Et.DEFAULT_PRECISION);n=`${n} X${t} Y${t}`.trim()}}i.push(n)}}for(let n=i.length-1;n>=0;n--)if(""!==i[n].trim()){/\bM0?2\b/i.test(i[n])&&i.slice(n+1).every(t=>""===t.trim())&&i.splice(n,1);break}return i.join("\n")}(n);t.gcodeDrawer.setContent({text:i,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}catch(i){try{const i=Qt(n);t.gcodeDrawer.setContent({text:i,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}catch(s){t.gcodeDrawer.setContent({text:n,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}}}t.statusMessage?.show(`G-Code loaded: ${e.file.name}`,"success")}catch(n){console.error("File display failed:",n),t.statusMessage?.show(`Failed to display file: ${n.message}`,"error")}}),a(s,e=>{console.error("File loading failed:",e.error),t.statusMessage?.show(`Failed to load file: ${e.error.message||e.error}`,"error")}),a(m,e=>{"canvas"===e.target&&t.addMeasurementPoint?.(e.worldX,e.worldY)}),a(c,()=>{t.canvas?.redraw()}),a(O,()=>{t.canvas?._handleResize()}),t.gcodeDrawer&&(a("drawer:line:hover",({index:e})=>{t.canvas?.setHoverHighlight(e)}),a("drawer:line:leave",()=>{t.canvas?.setHoverHighlight(null)}),a("drawer:line:click",({index:e})=>{t.canvas?.togglePersistentHighlight(e)}),a("drawer:insert:points",({atIndex:e,points:i})=>{i&&0!==i.length&&t.gcodeDrawer.insertPointsAt(e,i)}),a("drawer:content:changed",async({text:e})=>{try{const i=Qt(e||""),s=t.parser.parse(i);t.currentGCode={path:s.path,bounds:s.bounds,stats:s.stats},t.canvas?.setGCodePath(s.path),t.canvas?.redraw(),t.gcodeDrawer.setContent({text:i,mapping:s.path.map((t,e)=>({index:e,line:t.line||null,point:t})),preserveHistory:!0})}catch(i){console.error("Re-parse failed:",i)}})),a(w,e=>{const i={id:e.id||Date.now(),x:e.x,y:e.y,index:t.clickedPoints.length};t.clickedPoints.push(i),t.canvas?.setClickedPoints(t.clickedPoints),t.canvas?.redraw(),n.emit(_,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),a(S,e=>{t.clickedPoints=t.clickedPoints.filter(t=>t.id!==e.id),t.clickedPoints.forEach((t,e)=>{t.index=e}),t.canvas?.setClickedPoints(t.clickedPoints),t.canvas?.redraw(),n.emit(_,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),a(E,()=>{t.clickedPoints=[],t.canvas?.setClickedPoints(t.clickedPoints),t.canvas?.redraw(),n.emit(_,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),a(I,()=>{n.emit(L,{points:[...t.clickedPoints]},{skipValidation:!0})}),a(h,e=>{if(e&&"string"==typeof e.type){"in"===e.type?t.canvas?.viewport.zoomIn():"out"===e.type&&t.canvas?.viewport.zoomOut(),t.canvas?.redraw();const i={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};return void n.emit(h,i)}t.canvas?.redraw()}),a(p,()=>{if(t.currentGCode){t.canvas?.viewport.fitToBounds(t.currentGCode.bounds),t.canvas?.redraw();const e={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};n.emit(h,e)}}),a(u,()=>{t.canvas?.viewport.reset(),t.canvas?.redraw();const e={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};n.emit(h,e)}),a(M,e=>{const i=e&&"boolean"==typeof e.enabled;i?t.gridSnapEnabled=e.enabled:(t.gridSnapEnabled=!t.gridSnapEnabled,n.emit(M,{enabled:t.gridSnapEnabled},{skipValidation:!0})),t.canvas?.viewport.setGridSnap(t.gridSnapEnabled,t.canvas.gridSize),i||t.statusMessage?.show("Grid snap "+(t.gridSnapEnabled?"enabled":"disabled"),"info")}),a(D,()=>{const e=t.canvas?.gridEnabled;t.canvas?.setGridEnabled(!e),t.statusMessage?.show("Grid "+(e?"disabled":"enabled"),"info")}),a(X,e=>{t.statusMessage?.show(e.message,e.type,e.options)}),a(B,e=>{const i=e&&"string"==typeof e.format?e.format.toLowerCase():"iso";if("iso"===i){const e=t.gcodeDrawer?.getText?.();if(!e||""===e.trim())return void t.statusMessage?.show("Nothing to export. Load a file or add content.","warning");const i=t.toolbar?.fileHandler?.exportNormalizedISOFromText(e,{filename:`program_${(new Date).toISOString().slice(0,19).replace(/[:T]/g,"-")}.iso`});return void(i||t.statusMessage?.show("ISO export failed","error"))}if("csv"===i){if(0===t.clickedPoints.length)return void t.statusMessage?.show("No points to export","warning");const e={points:t.clickedPoints,format:"csv",timestamp:(new Date).toISOString()};if("function"==typeof t._exportPointsAsCSV)t._exportPointsAsCSV(e);else{const t=["Point,X,Y",...e.points.map((t,e)=>`P${e+1},${t.x.toFixed(3)},${t.y.toFixed(3)}`)].join("\n"),i=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download="measurement_points.csv",n.click(),URL.revokeObjectURL(s)}return}const s=t.gcodeDrawer?.getText?.();if(!s||""===s.trim())return void t.statusMessage?.show("Nothing to export. Load a file or add content.","warning");const n=t.toolbar?.fileHandler?.exportNormalizedISOFromText(s,{filename:`program_${(new Date).toISOString().slice(0,19).replace(/[:T]/g,"-")}.iso`});n||t.statusMessage?.show("Export failed","error")});const r=()=>{n.emit(O,{width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",r),t.eventIntegration?.init(),function(){o.forEach(t=>{try{"function"==typeof t&&t()}catch(e){}}),o.length=0;try{window.removeEventListener("resize",r)}catch(e){}try{t.eventIntegration?.destroy()}catch(e){}}}class we{constructor(t={}){this.options=t,this.eventBus=et.getInstance(),this.isInitialized=!1,this.isDestroyed=!1,this.currentGCode=null,this.clickedPoints=[],this.gridSnapEnabled=!1,this.domRefs=null,this.canvas=null,this.toolbar=null,this.sidebar=null,this.gcodeDrawer=null,this.statusMessage=null,this.eventIntegration=null,this.parser=null,this._detachWiring=null}async init(){"loading"===document.readyState&&await new Promise(t=>{document.addEventListener("DOMContentLoaded",t)}),this.eventBus.emit(U,{timestamp:Date.now()},{skipValidation:!0}),this.domRefs=function(){const t=document.getElementById("app");if(!t)throw new Error("App container element not found");t.innerHTML="";const e=document.createElement("div");e.className="wire-edm-viewer",e.innerHTML='\n    <header class="header">\n      <div id="toolbar-container" class="controls"></div>\n    </header>\n    \n    <main class="main-container">\n      <div class="canvas-container">\n        <canvas id="main-canvas" class="main-canvas"></canvas>\n        <div id="canvas-overlay" class="canvas-overlay"></div>\n      </div>\n      \n      <aside id="sidebar-container" class="sidebar"></aside>\n    </main>\n    \n    <div id="status-container" class="status-container"></div>\n  ',t.appendChild(e);const i=document.getElementById("main-canvas");if(!i)throw new Error("Canvas element not found");return{appContainer:t,canvasElement:i,toolbarContainer:document.getElementById("toolbar-container"),sidebarContainer:document.getElementById("sidebar-container"),statusContainer:document.getElementById("status-container"),canvasOverlay:document.getElementById("canvas-overlay")}}();const t=await async function(t){if(!t||!t.canvasElement)throw new Error("initAppComponents requires valid domRefs");const{canvasElement:e,toolbarContainer:i,sidebarContainer:s,statusContainer:n}=t,o=new qt(e,{showGrid:!0,gridSize:nt,enableHighDPI:!1});await o.init();const a=new ne(i,{enableFileInput:!0,enableZoomControls:!0,enableUtilityButtons:!0});return a.init(),{canvas:o,toolbar:a,sidebar:new oe(s,{showCoordinates:!0,showPoints:!0,showPathInfo:!0}),gcodeDrawer:new ue(document.body,{anchor:"right"}),statusMessage:new jt({container:n,position:"top-right",maxMessages:3,defaultDuration:3e3}),eventIntegration:new be(e,o.viewport,{enableMouse:!0,enableKeyboard:!0,enableTouch:!0,enableDelegation:!0}),parser:new Ut}}(this.domRefs);this.canvas=t.canvas,this.toolbar=t.toolbar,this.sidebar=t.sidebar,this.gcodeDrawer=t.gcodeDrawer,this.statusMessage=t.statusMessage,this.eventIntegration=t.eventIntegration,this.parser=t.parser,this._detachWiring=xe(this),this.hideLoadingIndicator(),this.isInitialized=!0,this.eventBus.emit(K,{timestamp:Date.now(),version:"2.0.0",components:["Canvas","Toolbar","Sidebar","StatusMessage"]})}addMeasurementPoint(t,e){const i={id:Date.now().toString(),x:t,y:e};this.eventBus.emit(w,i)}_exportPointsAsCSV(t){const e=["Point,X,Y",...t.points.map((t,e)=>`P${e+1},${t.x.toFixed(3)},${t.y.toFixed(3)}`)].join("\n"),i=new Blob([e],{type:"text/csv"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=`measurement_points_${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),this.statusMessage?.show(`Exported ${t.points.length} points to CSV`,"success"),this.eventBus.emit(F,{pointCount:t.points.length,format:"csv",points:t.points})}hideLoadingIndicator(){const t=document.getElementById("loading");t&&(t.style.display="none")}showError(t){this.statusMessage?this.statusMessage.show(t,"error"):alert("Error: "+t)}destroy(){if(!this.isDestroyed)try{if(this._detachWiring){try{this._detachWiring()}catch(t){}this._detachWiring=null}this.eventIntegration&&this.eventIntegration.destroy(),this.canvas&&this.canvas.destroy(),this.toolbar&&this.toolbar.destroy(),this.sidebar&&this.sidebar.destroy(),this.statusMessage&&this.statusMessage.destroy(),this.eventBus&&this.eventBus.removeAllListeners(),this.domRefs?.appContainer&&(this.domRefs.appContainer.innerHTML=""),this.isDestroyed=!0,this.eventBus.emit(V,{timestamp:Date.now()},{skipValidation:!0})}catch(e){console.error("AppOrchestrator cleanup failed:",e)}}}!async function(){try{const t=new we;await t.init(),window.wireEDMViewer=t,window.addEventListener("beforeunload",()=>{try{t.destroy()}catch(e){}})}catch(t){console.error("❌ Application startup failed:",t);const e=document.getElementById("app");e&&(e.innerHTML=`\n        <div style="padding: 20px; text-align: center; color: #ff6b6b;">\n          <h2>❌ Application Failed to Start</h2>\n          <p>${t.message}</p>\n          <p>Please refresh the page to try again.</p>\n        </div>\n      `)}}()}}});
