var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);function i(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const s="file:load:start",n="file:load:success",o="file:load:error",a="file:load:progress",r="file:cleared",l="gcode:parse:start",h="gcode:parse:success",c="gcode:parse:error",d="gcode:parse:progress",u="viewport:zoom:change",p="viewport:pan:change",g="viewport:reset",m="viewport:fit:screen",v="mouse:move",y="mouse:click",f="mouse:down",b="mouse:up",S="mouse:wheel",_="mouse:enter:canvas",w="mouse:leave:canvas",E="point:add",C="point:delete",x="point:update",T="point:clear:all",L="point:select",I="point:deselect",M="point:get:clicked",D="point:clicked:response",P="grid:snap:toggle",O="grid:visibility:toggle",k="ui:toolbar:toggle",A="ui:sidebar:toggle",z="ui:theme:change",R="ui:resize",H="key:down",B="key:up",F="key:shortcut",N="export:start",X="export:success",Y="export:error",G="status:show",W="status:hide",q="status:update",U="canvas:redraw",K="canvas:clear",V="canvas:resize",Z="app:init",j="app:ready",J="app:destroy",$={MOUSE:{screenX:"number",screenY:"number",worldX:"number",worldY:"number",button:"number",ctrlKey:"boolean",shiftKey:"boolean",altKey:"boolean",originalEvent:"Event"},VIEWPORT:{zoom:"number",offsetX:"number",offsetY:"number",bounds:"Object",canvasWidth:"number",canvasHeight:"number"},POINT:{id:"string",x:"number",y:"number",index:"number",metadata:"Object"},FILE:{name:"string",size:"number",type:"string",content:"string",progress:"number"},GCODE:{path:"Array",bounds:"Object",moveCount:"number",rapidCount:"number",cutCount:"number",arcCount:"number"},KEYBOARD:{key:"string",code:"string",ctrlKey:"boolean",shiftKey:"boolean",altKey:"boolean",metaKey:"boolean",originalEvent:"KeyboardEvent"},STATUS:{message:"string",type:"string",duration:"number",persistent:"boolean"},ERROR:{message:"string",error:"Error",context:"string",stack:"string"}};class Q{static validate(t,e){const i=Q.getSchema(t);if(!i)return{valid:!0,errors:[]};const s=[];if(null==e)return!1!==i.required&&s.push("Event data is required for ".concat(t)),{valid:0===s.length,errors:s};for(const[n,o]of Object.entries(i)){if("required"===n)continue;const t=e[n],i=typeof t;void 0!==t&&("Array"!==o||Array.isArray(t)?"Object"!==o||"object"==typeof t&&null!==t&&!Array.isArray(t)?"Event"===o?t instanceof Event||"object"==typeof t&&null!==t&&(void 0!==t.type||void 0!==t.target||void 0!==t.currentTarget||void 0!==t.clientX||void 0!==t.clientY||void 0!==t.button||"function"==typeof t.preventDefault||"function"==typeof t.stopPropagation)||s.push("Field '".concat(n,"' must be of type Event, got ").concat(typeof t)):"KeyboardEvent"===o?t instanceof KeyboardEvent||"object"==typeof t&&null!==t&&(void 0!==t.type||void 0!==t.target||void 0!==t.currentTarget||void 0!==t.key||void 0!==t.code||void 0!==t.keyCode||"function"==typeof t.preventDefault||"function"==typeof t.stopPropagation)||s.push("Field '".concat(n,"' must be a KeyboardEvent object")):"Error"!==o||t instanceof Error?"string"==typeof o&&i!==o&&s.push("Field '".concat(n,"' must be of type ").concat(o,", got ").concat(i)):s.push("Field '".concat(n,"' must be an Error object")):("bounds"===n&&console.debug("Bounds validation failed:",{field:n,expectedType:o,actualType:typeof t,isNull:null===t,isArray:Array.isArray(t),value:t}),s.push("Field '".concat(n,"' must be an object, got ").concat(Array.isArray(t)?"array":typeof t))):s.push("Field '".concat(n,"' must be an array, got ").concat(i)),"number"!==o||isFinite(t)||s.push("Field '".concat(n,"' must be a finite number")))}return{valid:0===s.length,errors:s}}static getSchema(t){return{[v]:$.MOUSE,[y]:$.MOUSE,[f]:$.MOUSE,[b]:$.MOUSE,[S]:$.MOUSE,[_]:$.MOUSE,[w]:$.MOUSE,[u]:$.VIEWPORT,[p]:$.VIEWPORT,[g]:$.VIEWPORT,[m]:$.VIEWPORT,[E]:$.POINT,[C]:$.POINT,[x]:$.POINT,[L]:$.POINT,[I]:$.POINT,[s]:$.FILE,[n]:$.FILE,[o]:$.ERROR,[a]:$.FILE,[l]:{required:!1},[h]:$.GCODE,[c]:$.ERROR,[d]:{progress:"number"},[H]:$.KEYBOARD,[B]:$.KEYBOARD,[F]:$.KEYBOARD,[G]:$.STATUS,[W]:{required:!1},[q]:$.STATUS,[U]:{required:!1},[K]:{required:!1},[V]:{width:"number",height:"number"}}[t]||null}}class tt{constructor(t=document,e=()=>{}){this.root=t,this.emit=e,this._delegations=new Map}add(t,e,i,s){if("string"!=typeof t)throw new Error("Selector must be a string");if("string"!=typeof e)throw new Error("DOM event type must be a string");if("function"!=typeof s)throw new Error("Data extractor must be a function");const n="".concat(t,":").concat(e);if(!this._delegations.has(n)){const i=e=>{var i,s;const o=null==(s=null==(i=e.target)?void 0:i.closest)?void 0:s.call(i,t);if(!o)return;const a=this._delegations.get(n);a&&a.handlers.forEach((t,i)=>{try{const s=t(e,o);this.emit(i,s)}catch(s){console.error("DOMDelegation: Error in delegated handler:",s)}})};this._delegations.set(n,{selector:t,eventType:e,listener:i,handlers:new Map}),this.root.addEventListener(e,i,!0)}return this._delegations.get(n).handlers.set(i,s),()=>{const t=this._delegations.get(n);t&&(t.handlers.delete(i),0===t.handlers.size&&(t.listener&&this.root.removeEventListener(t.eventType,t.listener,!0),this._delegations.delete(n)))}}size(){return this._delegations.size}clear(){this._delegations.forEach(t=>{t.listener&&this.root.removeEventListener(t.eventType,t.listener,!0)}),this._delegations.clear()}}class et{constructor(t=100){this.maxHistorySize=t,this._events=[]}record(t,e,i){this._events.push({type:t,data:e,timestamp:Date.now(),listeners:i}),this._events.length>this.maxHistorySize&&this._events.shift()}getEvents(){return[...this._events]}clear(){this._events.length=0}}let it=null;class st{static getInstance(){return it||(it=new nt),it}static setImplementation(t){it&&"function"==typeof it.destroy&&it.destroy(),it=t}static reset(){it&&"function"==typeof it.destroy&&it.destroy(),it=null}static on(t,e,i){return st.getInstance().on(t,e,i)}static once(t,e){return st.getInstance().once(t,e)}static off(t,e){return st.getInstance().off(t,e)}static emit(t,e,i){return st.getInstance().emit(t,e,i)}static delegate(t,e,i,s){return st.getInstance().delegate(t,e,i,s)}}class nt{constructor(){this.listeners=new Map,this.onceListeners=new Map,this.isDestroyed=!1,this._history=new et(100),this._domDelegation=new tt(document,(t,e)=>{this.emit(t,e,{skipValidation:!0})}),this.listenerCount=0,this.eventCount=0}on(t,e,i={}){if(this._validateEventType(t),this._validateCallback(e),this.isDestroyed)return console.warn("EventManager: Cannot add listener to destroyed instance"),()=>{};const{once:s=!1,priority:n=0}=i,o=s?this.onceListeners:this.listeners;o.has(t)||o.set(t,new Set);const a={callback:e,priority:n,id:this._generateListenerId(),createdAt:Date.now()};return o.get(t).add(a),this.listenerCount++,()=>{var e,i;null==(e=o.get(t))||e.delete(a),this.listenerCount--,0===(null==(i=o.get(t))?void 0:i.size)&&o.delete(t)}}once(t,e){return this.on(t,e,{once:!0})}off(t,e){this._validateEventType(t),this._validateCallback(e),[this.listeners,this.onceListeners].forEach(i=>{const s=i.get(t);if(s){for(const t of s)t.callback===e&&(s.delete(t),this.listenerCount--);0===s.size&&i.delete(t)}})}emit(t,e=null,i={}){if(this._validateEventType(t),this.isDestroyed)return void console.warn("EventManager: Cannot emit events from destroyed instance");const{async:s=!1,skipValidation:n=!1}=i;if(!n){const i=Q.validate(t,e);i.valid||console.warn("EventManager: Invalid event data for ".concat(t,":"),i.errors)}this._recordEvent(t,e),this.eventCount++,s?setTimeout(()=>this._executeListeners(t,e),0):this._executeListeners(t,e)}delegate(t,e,i,s){return this._validateEventType(i),this._domDelegation.add(t,e,i,s)}getListeners(t){this._validateEventType(t);return[...Array.from(this.listeners.get(t)||[]),...Array.from(this.onceListeners.get(t)||[])].sort((t,e)=>e.priority-t.priority).map(t=>t.callback)}removeAllListeners(t){var e,i;if(t){this._validateEventType(t);const s=(null==(e=this.listeners.get(t))?void 0:e.size)||0,n=(null==(i=this.onceListeners.get(t))?void 0:i.size)||0;this.listeners.delete(t),this.onceListeners.delete(t),this.listenerCount-=s+n}else this.listeners.clear(),this.onceListeners.clear(),this.listenerCount=0}destroy(){this.isDestroyed||(this.removeAllListeners(),this._domDelegation.clear(),this._history.clear(),this.isDestroyed=!0,console.debug("EventManager destroyed"))}getEventHistory(){return this._history.getEvents()}getStats(){return{listenerCount:this.listenerCount,eventCount:this.eventCount,eventTypes:{regular:this.listeners.size,once:this.onceListeners.size},delegations:this._domDelegation.size(),historySize:this._history.getEvents().length,isDestroyed:this.isDestroyed}}_executeListeners(t,e){const i=[],s=this.listeners.get(t);s&&i.push(...s);const n=this.onceListeners.get(t);n&&i.push(...n),i.sort((t,e)=>e.priority-t.priority),i.forEach(i=>{try{i.callback(e,t)}catch(s){console.error("EventManager: Error in listener for ".concat(t,":"),s)}}),n&&n.size>0&&(this.onceListeners.delete(t),this.listenerCount-=n.size)}_recordEvent(t,e){this._history.record(t,e,this.getListeners(t).length)}_validateEventType(t){if("string"!=typeof t)throw new Error("Event type must be a string");if(0===t.length)throw new Error("Event type cannot be empty")}_validateCallback(t){if("function"!=typeof t)throw new Error("Callback must be a function")}_generateListenerId(){return"listener_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}}class ot{static createMouseEventData(t,e){if(!t)throw new Error("DOM event is required");let i={x:0,y:0},s={x:0,y:0};if(e)if("function"==typeof e.getMouseCoordinates){const n=e.getMouseCoordinates(t);n&&(i=n.screen,s=n.world)}else console.warn("EventManager: Received viewport state instead of Viewport instance. Coordinate accuracy may be affected."),i.x=t.clientX,i.y=t.clientY,s.x=t.clientX,s.y=t.clientY;else i.x=t.clientX,i.y=t.clientY,s.x=t.clientX,s.y=t.clientY;return{screenX:i.x,screenY:i.y,worldX:s.x,worldY:s.y,button:t.button||0,ctrlKey:t.ctrlKey||!1,shiftKey:t.shiftKey||!1,altKey:t.altKey||!1,target:"canvas",originalEvent:t}}static createKeyboardEventData(t){if(!t)throw new Error("DOM event is required");return{key:t.key,code:t.code,ctrlKey:t.ctrlKey||!1,shiftKey:t.shiftKey||!1,altKey:t.altKey||!1,metaKey:t.metaKey||!1,originalEvent:t}}static throttle(t,e){return function(t,e){if("function"!=typeof t)throw new Error("First argument must be a function");if("number"!=typeof e||e<0)throw new Error("Delay must be a non-negative number");let i=!1,s=null;return function(...n){i?s=n:(t.apply(this,n),i=!0,setTimeout(()=>{i=!1,s&&(t.apply(this,s),s=null)},e))}}(t,e)}static debounce(t,e){return function(t,e){if("function"!=typeof t)throw new Error("First argument must be a function");if("number"!=typeof e||e<0)throw new Error("Delay must be a non-negative number");let i=null;return function(...s){i&&clearTimeout(i),i=setTimeout(()=>{t.apply(this,s),i=null},e)}}(t,e)}static rateLimit(t,e,i){return function(t,e,i){if("function"!=typeof t)throw new Error("First argument must be a function");const s=[];return function(...n){const o=Date.now();for(;s.length>0&&s[0]<=o-i;)s.shift();if(s.length<e)return s.push(o),t.apply(this,n);console.debug("Rate limit exceeded: ".concat(e," calls per ").concat(i,"ms"))}}(t,e,i)}static deduplicate(t,e=50,i=null){return function(t,e=50,i=null){if("function"!=typeof t)throw new Error("First argument must be a function");const s=new Map;return function(...n){const o=Date.now(),a=i?i(...n):JSON.stringify(n),r=s.get(a);if(!r||o-r>e){if(s.set(a,o),s.size>100)for(const[t,i]of s.entries())o-i>2*e&&s.delete(t);return t.apply(this,n)}}}(t,e,i)}}const at=5,rt={MINOR:"#2a2a2a",MAJOR:"#555",LABELS:"#666"},lt={MINOR:.25,MAJOR:1},ht=1,ct=1e-6,dt=1e6,ut=1.2,pt=.1,gt=50,mt=50,vt={MIN_FACTOR:.001,MAX_FACTOR:1e3},yt="crosshair",ft="move",bt={RAPID:{COLOR:"#ffff00",LINE_WIDTH_PX:1,LINE_DASH_PX:[4,3]},CUT:{COLOR:"#00ff00",LINE_WIDTH_PX:1.6,LINE_DASH_PX:[]},ARC:{COLOR:"#00ff00",LINE_WIDTH_PX:1.6,LINE_DASH_PX:[]}},St={COLOR:"#ff0000",RADIUS_PX:4,LABEL:"START",FONT:"bold 10px Arial",OFFSET:{X:6,Y:-6}},_t={COLOR:"#0000ff",RADIUS_PX:3,LABEL:"END",FONT:"bold 4px Arial",OFFSET:{X:5,Y:-5}},wt={COLOR:"#ff00ff",RADIUS_PX:3,FONT:"4px Arial",OFFSET:{X:4,Y:-4}},Et=[".gcode",".nc",".txt",".iso"],Ct=52428800,xt={DURATION:3e3,COLORS:{SUCCESS:"#4CAF50",ERROR:"#f44336",WARNING:"#ff9800",INFO:"#2196F3"},POSITION:{TOP:"20px",RIGHT:"20px",LEFT:"20px",BOTTOM:"20px"}},Tt={COMMENT_PREFIXES:[";","(","%"],LINEAR_MOVES:["G0","G1"],ARC_MOVES:["G2","G3"],COORDINATE_PARAMS:["X","Y","Z","I","J","K"],DEFAULT_PRECISION:3},Lt={EXTENSION:".gcode",MIME_TYPE:"text/plain",HEADER_COMMENT:"; Exported points from Wire EDM G-Code Viewer",DATE_FORMAT:"YYYY-MM-DD HH:mm:ss"},It={EXTENSION:".iso",MIME_TYPE:"text/plain"},Mt={FAST:150,NORMAL:300,SLOW:500,EASE:"cubic-bezier(0.4, 0.0, 0.2, 1)"},Dt=3,Pt={STEPS:[1,2,5],TARGET_MINOR_PX:12,MINOR_VISIBILITY_PX:3,TARGET_LABEL_PX:80,LABEL_VISIBILITY_PX:50,HYSTERESIS:{GRID_PX:.5,LABEL_PX:10}};class Ot{static screenToWorld(t,e,i,s,n,o){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const a=(t-s)/i,r=(o-e-n)/i;return{x:zt.round(a,Dt),y:zt.round(r,Dt)}}static worldToScreen(t,e,i,s,n,o){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const a=t*i+s,r=o-(e*i+n);return{x:Math.round(100*a)/100,y:Math.round(100*r)/100}}static applyTransform(t,e,i,s,n){t.setTransform(1,0,0,1,0,0),t.translate(i,n-s),t.scale(e,-e)}static worldToScreenTextSpace(t,e,i,s,n){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const o=t*i+s,a=e*i+n;return{x:Math.round(100*o)/100,y:Math.round(100*a)/100}}static screenToWorldTextSpace(t,e,i,s,n){if(!isFinite(t)||!isFinite(e)||!isFinite(i)||0===i)return{x:0,y:0};const o=(t-s)/i,a=(e-n)/i;return{x:zt.round(o,Dt),y:zt.round(a,Dt)}}}class kt{static distance(t,e,i,s){const n=i-t,o=s-e;return Math.sqrt(n*n+o*o)}static angleRadians(t,e,i,s){return Math.atan2(s-e,i-t)}static angleDegrees(t,e,i,s){return kt.angleRadians(t,e,i,s)*(180/Math.PI)}static midpoint(t,e,i,s){return{x:(t+i)/2,y:(e+s)/2}}}class At{static snapToGrid(t,e){return Math.round(t/e)*e}static snapPointToGrid(t,e,i){return{x:At.snapToGrid(t,i),y:At.snapToGrid(e,i)}}static pickGridSpacing(t,e=Pt.TARGET_MINOR_PX){const i=e/t,s=Math.pow(10,Math.floor(Math.log10(i)));for(const n of Pt.STEPS){const t=n*s;if(t>=i)return t}return 10*s}static pickLabelSpacing(t,e,i=Pt.TARGET_LABEL_PX){const s=i/e,n=Math.ceil(s/t),o=Math.pow(10,Math.floor(Math.log10(n))),a=[1,2,5];for(const r of a){const e=r*o;if(e>=n)return e*t}return 10*o*t}static calculateGridLines(t,e,i,s,n,o){const a=-e/t,r=(s-e)/t,l=-i/t,h=(n-i)/t,c=Math.ceil(a/o),d=Math.floor(r/o),u=Math.ceil(l/o),p=Math.floor(h/o),g=[],m=[],v=[],y=[];for(let f=c;f<=d;f++)g.push(f*o),v.push(f);for(let f=u;f<=p;f++)m.push(f*o),y.push(f);return{vertical:g,horizontal:m,verticalIndices:v,horizontalIndices:y}}}class zt{static round(t,e=Dt){const i=Math.pow(10,e);return Math.round(t*i)/i}static format(t,e=Dt){return zt.round(t,e).toFixed(e)}static approximately(t,e,i=1e-10){return Math.abs(t-e)<i}}class Rt{static isValidCoordinate(t){return"number"==typeof t&&isFinite(t)&&!isNaN(t)}static isValidPoint(t){return t&&Rt.isValidCoordinate(t.x)&&Rt.isValidCoordinate(t.y)}static sanitizeCoordinate(t,e=0){const i=parseFloat(t);return Rt.isValidCoordinate(i)?i:e}}class Ht{static createEmptyBounds(){return{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}}static updateBounds(t,e,i){return{minX:Math.min(t.minX,e),maxX:Math.max(t.maxX,e),minY:Math.min(t.minY,i),maxY:Math.max(t.maxY,i)}}static isValidBounds(t){return isFinite(t.minX)&&isFinite(t.maxX)&&isFinite(t.minY)&&isFinite(t.maxY)}static getBoundsDimensions(t){if(!Ht.isValidBounds(t))return{width:0,height:0,centerX:0,centerY:0};return{width:t.maxX-t.minX,height:t.maxY-t.minY,centerX:(t.minX+t.maxX)/2,centerY:(t.minY+t.maxY)/2}}static expandBounds(t,e){return{minX:t.minX-e,maxX:t.maxX+e,minY:t.minY-e,maxY:t.maxY+e}}}class Bt{static calculateArcParameters(t,e,i,s,n,o,a){const r=kt.distance(t,e,n,o),l=Math.atan2(e-o,t-n),h=Math.atan2(s-o,i-n);let c=h-l;return a?c>0&&(c-=2*Math.PI):c<0&&(c+=2*Math.PI),{radius:r,startAngle:l,endAngle:h,angleSpan:Math.abs(c)}}static pointOnArc(t,e,i,s){return{x:t+i*Math.cos(s),y:e+i*Math.sin(s)}}static calculateArcBounds(t,e,i,s,n,o,a){const{radius:r,startAngle:l,endAngle:h}=Bt.calculateArcParameters(t,e,i,s,n,o,a);let c=Ht.createEmptyBounds();c=Ht.updateBounds(c,t,e),c=Ht.updateBounds(c,i,s);const d=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(const u of d)if(Bt.angleInArcSpan(u,l,h,a)){const t=Bt.pointOnArc(n,o,r,u);c=Ht.updateBounds(c,t.x,t.y)}return c}static angleInArcSpan(t,e,i,s){const n=t=>{for(;t<0;)t+=2*Math.PI;for(;t>=2*Math.PI;)t-=2*Math.PI;return t},o=n(e),a=n(i),r=n(t);return s?o>=a?r<=o&&r>=a:r<=o||r>=a:o<=a?r>=o&&r<=a:r>=o||r<=a}}class Ft{constructor(t){this.canvas=t,this.displayWidth=800,this.displayHeight=600,this.gridSnapEnabled=!1,this.gridSnapSize=1,this.minZoom=ct,this.maxZoom=dt,this.reset()}_updateDisplayDimensions(){this.displayWidth=this.canvas.clientWidth||this.canvas.width,this.displayHeight=this.canvas.clientHeight||this.canvas.height,(this.displayWidth<=0||this.displayHeight<=0)&&(console.warn("Viewport: Invalid canvas dimensions detected, using fallback values"),this.displayWidth=this.displayWidth||800,this.displayHeight=this.displayHeight||600)}reset(){this.zoom=ht,this._updateDisplayDimensions(),this.offsetX=this.displayWidth/2,this.offsetY=this.displayHeight/2,this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.minZoom=ct,this.maxZoom=dt}getState(){return{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY,isDragging:this.isDragging,bounds:this.getBounds()}}setState(t){void 0!==t.zoom&&(this.zoom=this.clampZoom(t.zoom)),void 0!==t.offsetX&&(this.offsetX=t.offsetX),void 0!==t.offsetY&&(this.offsetY=t.offsetY),void 0!==t.isDragging&&(this.isDragging=t.isDragging)}getBounds(){const t=this.screenToWorld(0,0),e=this.screenToWorld(this.displayWidth,this.displayHeight);return{minX:t.x,maxX:e.x,minY:e.y,maxY:t.y}}clampZoom(t){var e,i;const s=null!=(e=this.minZoom)?e:ct,n=null!=(i=this.maxZoom)?i:dt;return Math.max(s,Math.min(n,t))}screenToWorld(t,e){return Ot.screenToWorld(t,e,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}worldToScreen(t,e){return Ot.worldToScreen(t,e,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}applyTransform(t){Ot.applyTransform(t,this.zoom,this.offsetX,this.offsetY,this.displayHeight)}getMouseCoordinates(t,e=!1,i=1){const s=this.canvas.getBoundingClientRect();let n=t.clientX-s.left,o=t.clientY-s.top;if(this.canvas.width!==s.width||this.canvas.height!==s.height){n*=this.canvas.width/s.width,o*=this.canvas.height/s.height}let a=this.screenToWorld(n,o);if(!this.isValidCoordinate(a.x)||!this.isValidCoordinate(a.y))return null;const r=e||this.gridSnapEnabled,l=i||this.gridSnapSize||1;return r&&(a=At.snapPointToGrid(a.x,a.y,l)),{screen:{x:n,y:o},world:a}}setGridSnap(t,e=null){this.gridSnapEnabled=!!t,"number"==typeof e&&isFinite(e)&&e>0&&(this.gridSnapSize=e)}isValidCoordinate(t){return!isNaN(t)&&isFinite(t)}debugCoordinateConversion(t){const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,n=this.screenToWorld(i,s),o=this.worldToScreen(n.x,n.y),a=Math.abs(i-o.x),r=Math.abs(s-o.y);return{originalScreen:{x:i,y:s},worldCoords:n,backToScreen:o,coordinateError:{x:a,y:r},accuracy:a<.1&&r<.1?"GOOD":"POOR",dimensionConsistency:this.displayWidth===this.canvas.clientWidth&&this.displayHeight===this.canvas.clientHeight,coordinateSystemInfo:{usingDisplayHeight:this.displayHeight,canvasClientHeight:this.canvas.clientHeight,canvasHeight:this.canvas.height,heightConsistency:this.displayHeight===this.canvas.clientHeight,transformParameters:{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY}},coordinateSystemValidation:this.validateCoordinateSystem(),mouseCoordinateScaling:{scaleX:this.canvas.width/e.width,scaleY:this.canvas.height/e.height,isScaled:this.canvas.width!==e.width||this.canvas.height!==e.height},dimensions:{displayWidth:this.displayWidth,displayHeight:this.displayHeight,canvasWidth:this.canvas.width,canvasHeight:this.canvas.height,clientWidth:this.canvas.clientWidth,clientHeight:this.canvas.clientHeight,cssWidth:e.width,cssHeight:e.height},validation:{heightSync:this.displayHeight===this.canvas.height,widthSync:this.displayWidth===this.canvas.width,canvasToDisplaySync:this.displayHeight===this.canvas.height&&this.displayWidth===this.canvas.width?"SYNCED":"MISMATCHED",canvasToCssSync:this.canvas.width===e.width&&this.canvas.height===e.height?"SYNCED":"SCALED"}}}validateCoordinateSystem(){const t=[],e=[];return this.displayHeight!==this.canvas.clientHeight&&t.push("Height mismatch: displayHeight=".concat(this.displayHeight,", clientHeight=").concat(this.canvas.clientHeight)),this.displayWidth!==this.canvas.clientWidth&&t.push("Width mismatch: displayWidth=".concat(this.displayWidth,", clientWidth=").concat(this.canvas.clientWidth)),(this.displayWidth<=0||this.displayHeight<=0)&&t.push("Invalid dimensions: ".concat(this.displayWidth,"x").concat(this.displayHeight)),this.canvas.width===this.canvas.clientWidth&&this.canvas.height===this.canvas.clientHeight||e.push("Canvas buffer size differs from display size - High-DPI or scaling detected"),{isValid:0===t.length,issues:t,warnings:e,dimensions:{display:{width:this.displayWidth,height:this.displayHeight},client:{width:this.canvas.clientWidth,height:this.canvas.clientHeight},buffer:{width:this.canvas.width,height:this.canvas.height}}}}logCoordinateSystemStatus(){const t=this.validateCoordinateSystem(),e=this.canvas.getBoundingClientRect();console.group("üéØ Coordinate System Status"),console.log("Validation Result:",t.isValid?"‚úÖ VALID":"‚ùå INVALID"),t.issues.length>0&&(console.warn("Issues found:"),t.issues.forEach(t=>console.warn("- "+t))),t.warnings.length>0&&(console.info("Warnings:"),t.warnings.forEach(t=>console.info("- "+t))),console.table({"Display Dimensions":{width:this.displayWidth,height:this.displayHeight},"Canvas Buffer":{width:this.canvas.width,height:this.canvas.height},"Canvas CSS":{width:this.canvas.clientWidth,height:this.canvas.clientHeight},"Actual CSS":{width:e.width,height:e.height}});const i=this.canvas.width/e.width,s=this.canvas.height/e.height;console.log("Mouse Coordinate Scaling:",{scaleX:i,scaleY:s,isScaled:1!==i||1!==s}),console.log("Viewport State:",{zoom:this.zoom,offsetX:this.offsetX,offsetY:this.offsetY}),console.groupEnd()}zoomIn(){this.zoom=this.clampZoom(this.zoom*ut)}zoomOut(){this.zoom=this.clampZoom(this.zoom/ut)}setZoom(t){this.zoom=this.clampZoom(t)}zoomAtPoint(t,e,i){const s=this.screenToWorld(t,e),n=i>0?1+pt:1-pt;this.zoom=this.clampZoom(this.zoom*n),this.offsetX=t-s.x*this.zoom,this.offsetY=e-s.y*this.zoom}startDrag(t,e){this.isDragging=!0,this.dragStartX=t-this.offsetX,this.dragStartY=e+this.offsetY,this.canvas.style.cursor=ft}updateDrag(t,e){this.isDragging&&(this.offsetX=t-this.dragStartX,this.offsetY=this.dragStartY-e)}endDrag(){this.isDragging=!1,this.canvas.style.cursor=yt}fitToBounds(t,e=gt){var i,s;const{minX:n,maxX:o,minY:a,maxY:r}=t;if(!(this.isValidCoordinate(n)&&this.isValidCoordinate(o)&&this.isValidCoordinate(a)&&this.isValidCoordinate(r)))return void console.error("Invalid bounds for fitToBounds:",t);const l=o-n,h=r-a;if(0===l||0===h)return this.zoom=ht,this.offsetX=this.displayWidth/2,void(this.offsetY=this.displayHeight/2);const c=this.displayWidth,d=this.displayHeight,u=(c-2*e)/l,p=(d-2*e)/h,g=Math.min(u,p),m=null==(i=vt)?void 0:i.MIN_FACTOR,v=null==(s=vt)?void 0:s.MAX_FACTOR;this.minZoom=Math.max(ct,g*m),this.maxZoom=Math.min(dt,g*v),this.zoom=this.clampZoom(g);const y=(n+o)/2,f=(a+r)/2;this.offsetX=c/2-y*this.zoom,this.offsetY=d/2+f*this.zoom}onCanvasResize(){0===this.offsetX&&(this.offsetX=this.displayWidth/2),0===this.offsetY&&(this.offsetY=this.displayHeight/2)}getZoomPercentage(){return Math.round(100*this.zoom)+"%"}isPointVisible(t,e){const i=this.worldToScreen(t,e);return i.x>=0&&i.x<=this.displayWidth&&i.y>=0&&i.y<=this.displayHeight}pan(t,e){this.offsetX+=t,this.offsetY+=e}}let Nt,Xt;function Yt(t,e,i={}){const s=i.displayWidth,n=i.displayHeight,o=i.devicePixelRatio||1,a=e.getState(),r=At.pickGridSpacing(a.zoom,Pt.TARGET_MINOR_PX),l=At.pickLabelSpacing(r,a.zoom,Pt.TARGET_LABEL_PX),h=r*a.zoom,c=l*a.zoom,d=Pt.HYSTERESIS&&Pt.HYSTERESIS.GRID_PX||0,u=Pt.HYSTERESIS&&Pt.HYSTERESIS.LABEL_PX||0;let p,g;if("boolean"==typeof Nt){const t=Pt.MINOR_VISIBILITY_PX;p=Nt?h>=t-d:h>=t+d}else p=h>=Pt.MINOR_VISIBILITY_PX;if("boolean"==typeof Xt){const t=Pt.LABEL_VISIBILITY_PX;g=Xt?c>=t-u:c>=t+u}else g=c>=Pt.LABEL_VISIBILITY_PX;Nt=p,Xt=g;const m=At.calculateGridLines(a.zoom,a.offsetX,a.offsetY,s,n,r);p&&Gt(t,e,m,!1,o),Gt(t,e,m,!0,o),g&&function(t,e,i,s={}){const{vertical:n,horizontal:o,verticalIndices:a,horizontalIndices:r}=i,l=s.displayHeight,h=s.labelSpacing,c=s.minorSpacing,d=Math.max(0,-Math.floor(Math.log10(h))),u=Math.round(h/c);t.save(),t.setTransform(1,0,0,1,0,0);const p=s.devicePixelRatio||1;p>1&&t.scale(p,p);t.fillStyle=rt.LABELS,t.font="9px Arial",t.textAlign="left",t.textBaseline="top",n.forEach((i,s)=>{if(a[s]%u===0&&0!==i){const s=e.worldToScreen(i,0);t.fillText(zt.format(i,d),s.x+2,l-15)}}),o.forEach((i,s)=>{if(r[s]%u===0&&0!==i){const s=e.worldToScreen(0,i);t.fillText(zt.format(i,d),5,s.y-2)}}),t.restore()}(t,e,m,{displayHeight:n,devicePixelRatio:o,labelSpacing:l,minorSpacing:r})}function Gt(t,e,i,s,n,o){const{vertical:a,horizontal:r}=i,l=e.getBounds(),{minX:h,maxX:c,minY:d,maxY:u}=l,p=t=>t/(n*e.zoom);s?(t.strokeStyle=rt.MAJOR,t.lineWidth=p(lt.MAJOR)):(t.strokeStyle=rt.MINOR,t.lineWidth=p(lt.MINOR)),t.setLineDash([]),s?(t.beginPath(),t.moveTo(h,0),t.lineTo(c,0),t.moveTo(0,d),t.lineTo(0,u),t.stroke()):(t.beginPath(),a.forEach(e=>{0!==e&&(t.moveTo(e,d),t.lineTo(e,u))}),t.stroke(),t.beginPath(),r.forEach(e=>{0!==e&&(t.moveTo(h,e),t.lineTo(c,e))}),t.stroke())}function Wt(t){return t?"arc"===t.type?Rt.isValidCoordinate(t.endX)&&Rt.isValidCoordinate(t.endY)?{x:t.endX,y:t.endY}:null:Rt.isValidCoordinate(t.x)&&Rt.isValidCoordinate(t.y)?{x:t.x,y:t.y}:null:null}function qt(t,e,i,s,n){var o;if(!Rt.isValidPoint(i)||!Rt.isValidPoint(s))return;const a="rapid"===s.type?bt.RAPID:bt.CUT,r=t=>t/(n*e.zoom);t.strokeStyle=a.COLOR,t.lineWidth=r(a.LINE_WIDTH_PX);const l=null!=(o=a.LINE_DASH_PX)?o:[];t.setLineDash(Array.isArray(l)&&l.length?l.map(r):[]),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke()}function Ut(t,e,i,s){var n;if(!function(t){return t&&Rt.isValidCoordinate(t.startX)&&Rt.isValidCoordinate(t.startY)&&Rt.isValidCoordinate(t.endX)&&Rt.isValidCoordinate(t.endY)&&Rt.isValidCoordinate(t.centerX)&&Rt.isValidCoordinate(t.centerY)}(i))return;const o=t=>t/(s*e.zoom);t.strokeStyle=bt.ARC.COLOR,t.lineWidth=o(bt.ARC.LINE_WIDTH_PX);const a=null!=(n=bt.ARC.LINE_DASH_PX)?n:[];t.setLineDash(Array.isArray(a)?a.map(o):[]);const r=Math.sqrt(Math.pow(i.startX-i.centerX,2)+Math.pow(i.startY-i.centerY,2)),l=Math.atan2(i.startY-i.centerY,i.startX-i.centerX);let h=Math.atan2(i.endY-i.centerY,i.endX-i.centerX)-l;i.clockwise?h>=0&&(h-=2*Math.PI):h<=0&&(h+=2*Math.PI);const c=l+h;t.beginPath(),t.arc(i.centerX,i.centerY,r,l,c,i.clockwise),t.stroke()}function Kt(t,e,i,s,n=1){var o,a,r,l,h;const c=(null!=(o=s.RADIUS_PX)?o:3)/((n||1)*e.zoom);if(t.fillStyle=s.COLOR,t.beginPath(),t.arc(i.x,i.y,c,0,2*Math.PI),t.fill(),s.LABEL){t.save(),t.setTransform(1,0,0,1,0,0),n>1&&t.scale(n,n);const o=e.worldToScreen(i.x,i.y),c=null!=(r=null==(a=s.OFFSET)?void 0:a.X)?r:0,d=null!=(h=null==(l=s.OFFSET)?void 0:l.Y)?h:0;t.fillStyle=s.COLOR,t.font=s.FONT||"10px Arial",t.textAlign="left",t.textBaseline="top",t.fillText(s.LABEL,o.x+c,o.y+d),t.restore()}}class Vt{constructor(t,e={}){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas constructor requires a valid HTMLCanvasElement");this.canvas=t,this.ctx=t.getContext("2d"),this.options={...this._getDefaultOptions(),...e},this.viewport=new Ft(this.canvas),this.isInitialized=!1,this.isDestroyed=!1,this.renderRequestId=null,this.devicePixelRatio=1,this.enableHighDPI=this.options.enableHighDPI,this.physicalWidth=0,this.physicalHeight=0,this.logicalWidth=0,this.logicalHeight=0,this.gcodePath=[],this.clickedPoints=[],this.hoverHighlight=null,this.persistentHighlights=new Set,this.gridEnabled=this.options.showGrid,this.gridSize=this.options.gridSize,this._bindMethods()}_getDefaultOptions(){return{showGrid:!0,gridSize:at,enableHighDPI:!1,autoResize:!0,throttleRedraw:!0}}_bindMethods(){this.redraw=this.redraw.bind(this),this._handleResize=this._handleResize.bind(this)}async init(){if(this.isInitialized)console.warn("Canvas already initialized");else try{this._setupCanvas(),this._setupEventListeners(),this.redraw(),this.isInitialized=!0}catch(t){throw new Error("Failed to initialize Canvas: ".concat(t.message))}}_setupCanvas(){this.canvas.style.cursor=yt,this._resizeCanvas()}_setupEventListeners(){this.options.autoResize&&window.addEventListener("resize",this._handleResize)}_handleResize(){this._resizeCanvas(),this.redraw()}_resizeCanvas(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect();this.logicalWidth=Math.round(e.width),this.logicalHeight=Math.round(e.height),this.enableHighDPI?(this.devicePixelRatio=window.devicePixelRatio||1,this.physicalWidth=Math.round(this.logicalWidth*this.devicePixelRatio),this.physicalHeight=Math.round(this.logicalHeight*this.devicePixelRatio),this.canvas.width=this.physicalWidth,this.canvas.height=this.physicalHeight,this.canvas.style.width=this.logicalWidth+"px",this.canvas.style.height=this.logicalHeight+"px",console.log("High-DPI: Logical(".concat(this.logicalWidth,"x").concat(this.logicalHeight,") Physical(").concat(this.physicalWidth,"x").concat(this.physicalHeight,") DPR(").concat(this.devicePixelRatio,")"))):(this.devicePixelRatio=1,this.physicalWidth=this.logicalWidth,this.physicalHeight=this.logicalHeight,this.canvas.width=this.logicalWidth,this.canvas.height=this.logicalHeight),this.displayWidth=this.logicalWidth,this.displayHeight=this.logicalHeight,this._configureCanvasQuality(),this.viewport.displayWidth=this.logicalWidth,this.viewport.displayHeight=this.logicalHeight,this.viewport.onCanvasResize(),this._validateDimensionConsistency()}_configureCanvasQuality(){this.ctx.setTransform(1,0,0,1,0,0),this.enableHighDPI&&this.devicePixelRatio>1&&this.ctx.scale(this.devicePixelRatio,this.devicePixelRatio),this.ctx.imageSmoothingEnabled=!0,this.ctx.lineCap="round",this.ctx.lineJoin="round"}setGCodePath(t){if(!Array.isArray(t))throw new Error("Path data must be an array");this.gcodePath=t,this.redraw()}setClickedPoints(t){if(!Array.isArray(t))throw new Error("Points data must be an array");this.clickedPoints=t,this.redraw()}setGridEnabled(t){this.gridEnabled=!!t,this.redraw()}setGridSize(t){if(!Rt.isValidCoordinate(t)||t<=0)throw new Error("Grid size must be a positive number");this.gridSize=t,this.gridEnabled&&this.redraw()}redraw(){if(!this.isDestroyed)if(this.options.throttleRedraw){if(this.renderRequestId)return;this.renderRequestId=requestAnimationFrame(()=>{this._performRender(),this.renderRequestId=null})}else this._performRender()}_performRender(){try{t=this.ctx,e=this.physicalWidth,i=this.physicalHeight,t.clearRect(0,0,e,i),this.ctx.save(),function(t,e,i=1){const s=e.getState();t.setTransform(1,0,0,1,0,0),i>1&&t.scale(i,i),t.translate(s.offsetX,e.displayHeight-s.offsetY),t.scale(s.zoom,-s.zoom)}(this.ctx,this.viewport,this.devicePixelRatio),this.gridEnabled&&Yt(this.ctx,this.viewport,{gridSize:this.gridSize,displayWidth:this.displayWidth,displayHeight:this.displayHeight,devicePixelRatio:this.devicePixelRatio}),this.gcodePath.length>0&&(function(t,e,i,s={}){if(!Array.isArray(i)||0===i.length)return;const n=s.devicePixelRatio||1,o=s.hoverHighlight||null,a=s.persistentHighlights||new Set,r="function"==typeof s.markerRenderer?s.markerRenderer:null;for(let l=0;l<i.length;l++){if(0===l)continue;const s=i[l],h=i[l-1];if("arc"===(null==s?void 0:s.type))Ut(t,e,s,n);else{const i=Wt(h),o={x:s.x,y:s.y,type:s.type};i&&Rt.isValidPoint(i)&&Rt.isValidPoint(o)&&qt(t,e,i,o,n)}if((a.has(l)||o&&"point"===o.type&&o.index===l)&&r){const t="arc"===s.type?s.endX:s.x,e="arc"===s.type?s.endY:s.y;void 0!==t&&void 0!==e&&r({x:t,y:e},{...wt,COLOR:"#ffa500",RADIUS_PX:3,FONT:"bold 10px Arial",LABEL:"L".concat(s.line||l)})}}}(this.ctx,this.viewport,this.gcodePath,{devicePixelRatio:this.devicePixelRatio,hoverHighlight:this.hoverHighlight,persistentHighlights:this.persistentHighlights,markerRenderer:(t,e)=>Kt(this.ctx,this.viewport,t,e,this.devicePixelRatio)}),function(t,e,i,s={}){const n="function"==typeof s.markerRenderer?s.markerRenderer:null;if(!Array.isArray(i)||0===i.length||!n)return;const o=i[0];if(Rt.isValidPoint(o)&&n(o,St),i.length>1){const t=i[i.length-1];Rt.isValidPoint(t)&&n(t,_t)}}(this.ctx,this.viewport,this.gcodePath,{markerRenderer:(t,e)=>Kt(this.ctx,this.viewport,t,e,this.devicePixelRatio)})),this.clickedPoints.length>0&&function(t,e,i,s={}){const n=s.devicePixelRatio||1;i.forEach((i,s)=>{if(!i||!isFinite(i.x)||!isFinite(i.y))return;const o={...wt,LABEL:"P".concat(s+1)};Kt(t,e,i,o,n)})}(this.ctx,this.viewport,this.clickedPoints,{devicePixelRatio:this.devicePixelRatio}),this.ctx.restore()}catch(s){console.error("Error during canvas render:",s)}var t,e,i}fitToContent(){if(0===this.gcodePath.length)return;const t=this._calculateContentBounds();t&&(this.viewport.fitToBounds(t),this.redraw())}_calculateContentBounds(){if(0===this.gcodePath.length)return null;let t=1/0,e=-1/0,i=1/0,s=-1/0;return this.gcodePath.forEach(n=>{Rt.isValidPoint(n)&&(t=Math.min(t,n.x),e=Math.max(e,n.x),i=Math.min(i,n.y),s=Math.max(s,n.y))}),this.clickedPoints.forEach(n=>{Rt.isValidPoint(n)&&(t=Math.min(t,n.x),e=Math.max(e,n.x),i=Math.min(i,n.y),s=Math.max(s,n.y))}),isFinite(t)?{minX:t,maxX:e,minY:i,maxY:s}:null}getViewportState(){return this.viewport.getState()}getViewport(){return this.viewport}clearClickedPoints(){this.clickedPoints=[],this.redraw()}addClickedPoint(t){if(!Rt.isValidPoint(t))throw new Error("Invalid point coordinates");this.clickedPoints.push({...t}),this.redraw()}setHoverHighlight(t){this.hoverHighlight="number"==typeof t?{type:"point",index:t}:null,this.redraw()}togglePersistentHighlight(t){this.persistentHighlights.has(t)?this.persistentHighlights.delete(t):this.persistentHighlights.add(t),this.redraw()}setHighDPIEnabled(t){this.enableHighDPI!==t&&(this.enableHighDPI=t,console.log("High-DPI ".concat(t?"enabled":"disabled")),this._resizeCanvas(),this.redraw())}getHighDPIStatus(){return{enabled:this.enableHighDPI,devicePixelRatio:this.devicePixelRatio,logicalSize:{width:this.logicalWidth,height:this.logicalHeight},physicalSize:{width:this.physicalWidth,height:this.physicalHeight}}}_validateDimensionConsistency(){const t=[];this.viewport.displayWidth!==this.logicalWidth&&t.push("Width mismatch: viewport.displayWidth=".concat(this.viewport.displayWidth,", canvas.logicalWidth=").concat(this.logicalWidth)),this.viewport.displayHeight!==this.logicalHeight&&t.push("Height mismatch: viewport.displayHeight=".concat(this.viewport.displayHeight,", canvas.logicalHeight=").concat(this.logicalHeight)),this.enableHighDPI?this.canvas.width===this.physicalWidth&&this.canvas.height===this.physicalHeight||t.push("Canvas buffer mismatch (High-DPI): canvas=".concat(this.canvas.width,"x").concat(this.canvas.height,", physical=").concat(this.physicalWidth,"x").concat(this.physicalHeight)):this.canvas.width===this.logicalWidth&&this.canvas.height===this.logicalHeight||t.push("Canvas buffer mismatch (Standard): canvas=".concat(this.canvas.width,"x").concat(this.canvas.height,", logical=").concat(this.logicalWidth,"x").concat(this.logicalHeight)),t.length>0&&(console.error("Canvas dimension consistency issues detected:"),t.forEach(t=>console.error("- "+t)),console.error("This will cause coordinate accuracy problems!"),this.viewport.displayHeight!==this.logicalHeight&&(console.error("‚ùå CRITICAL: Height mismatch detected! This causes ~4mm coordinate offset after G-code loading."),console.error("Canvas transformation uses this.logicalHeight:",this.logicalHeight),console.error("Coordinate conversion uses viewport.displayHeight:",this.viewport.displayHeight),console.error("These MUST match for accurate coordinates!")))}destroy(){this.isDestroyed||(this.renderRequestId&&(cancelAnimationFrame(this.renderRequestId),this.renderRequestId=null),this.options.autoResize&&window.removeEventListener("resize",this._handleResize),this.gcodePath=[],this.clickedPoints=[],this.isDestroyed=!0)}}const Zt=class t{constructor(t={}){this.options={precision:Dt,strictMode:!1,ignoreErrors:!0,...t},this._reset()}_reset(){this.currentPosition={x:0,y:0},this.path=[],this.bounds=Ht.createEmptyBounds(),this.errors=[],this.warnings=[],this.g92Applied=!1,this.g92Line=null,this.g92AssumedZero=!1,this.ijAbsolute=!1,this.stats={totalLines:0,processedLines:0,linearMoves:0,arcMoves:0,comments:0,errors:0}}parse(t){if("string"!=typeof t)throw new Error("G-Code input must be a string");this._reset();const e=t.split(/\r?\n/);this.stats.totalLines=e.length;for(let s=0;s<e.length;s++)try{this._parseLine(e[s],s+1)}catch(i){if(this._handleError(i,s+1),this.options.strictMode)throw i}return this._validateResult(),{path:this.path,bounds:this.bounds,stats:this.stats,errors:this.errors,warnings:this.warnings}}_parseLine(e,i){if(e=e.trim().toUpperCase(),""===(e=this._normalizeMotionCodes(e)))return;if(this._isComment(e))return void this.stats.comments++;if(""===(e=(e=this._removeInlineComments(e)).replace(t.REGEX.LEADING_BLOCK_NUMBER,"")))return;if(this.stats.processedLines++,/\bG92\b/.test(e))return this._parseG92(e,i),void((this._isLinearMove(e)||this._isArcMove(e))&&this._addWarning("Line ".concat(i,": G92 must be alone on its line; ignoring additional commands."),i));let s=!1;/\bG60\b/.test(e)&&(this.ijAbsolute=!0,s=!0),/\bG90\.1\b/.test(e)&&(this.ijAbsolute=!0,s=!0),/\bG91\.1\b/.test(e)&&(this.ijAbsolute=!1,s=!0),this._isLinearMove(e)?this._parseLinearMove(e,i):this._isArcMove(e)?this._parseArcMove(e,i):s||this._addWarning("Unknown G-Code command: ".concat(e),i)}_normalizeMotionCodes(t){return t.replace(/\bG0+([0-3])(?!\d)/g,"G$1")}_isComment(t){return Tt.COMMENT_PREFIXES.some(e=>t.startsWith(e))}_removeInlineComments(e){return e.replace(t.REGEX.COMMENT,"").trim()}_isLinearMove(t){return Tt.LINEAR_MOVES.some(e=>t.startsWith(e))}_isArcMove(t){return Tt.ARC_MOVES.some(e=>t.startsWith(e))}_parseLinearMove(t,e){const i=t.startsWith("G0")?"rapid":"cut",s=this._extractCoordinates(t);if(void 0!==s.x&&(this.currentPosition.x=s.x),void 0!==s.y&&(this.currentPosition.y=s.y),!Rt.isValidPoint(this.currentPosition))throw new Error("Invalid coordinates at line ".concat(e,": ").concat(JSON.stringify(this.currentPosition)));const n={type:i,x:this.currentPosition.x,y:this.currentPosition.y,line:e};this.path.push(n),this.bounds=Ht.updateBounds(this.bounds,this.currentPosition.x,this.currentPosition.y),this.stats.linearMoves++}_parseArcMove(t,e){const i=t.startsWith("G2"),s=this._extractCoordinates(t),n=this._extractArcCenter(t),o=this.currentPosition.x,a=this.currentPosition.y,r=void 0!==s.x?s.x:this.currentPosition.x,l=void 0!==s.y?s.y:this.currentPosition.y;let h,c;if(this.ijAbsolute?void 0===n.i||void 0===n.j?(this._addWarning("Line ".concat(e,": Arc center missing I or J in absolute I/J mode; falling back to relative I/J."),e),h=o+(n.i||0),c=a+(n.j||0)):(h=n.i,c=n.j):(h=o+(n.i||0),c=a+(n.j||0)),!(Rt.isValidCoordinate(r)&&Rt.isValidCoordinate(l)&&Rt.isValidCoordinate(h)&&Rt.isValidCoordinate(c)))throw new Error("Invalid arc coordinates at line ".concat(e));const d={type:"arc",startX:o,startY:a,endX:r,endY:l,centerX:h,centerY:c,clockwise:i,line:e};this.path.push(d),this.currentPosition.x=r,this.currentPosition.y=l;const u=Bt.calculateArcBounds(o,a,r,l,h,c,i);this.bounds.minX=Math.min(this.bounds.minX,u.minX),this.bounds.maxX=Math.max(this.bounds.maxX,u.maxX),this.bounds.minY=Math.min(this.bounds.minY,u.minY),this.bounds.maxY=Math.max(this.bounds.maxY,u.maxY),this.stats.arcMoves++}_parseG92(t,e){const i=this._extractCoordinates(t);let s=this.currentPosition.x,n=this.currentPosition.y;const o="number"==typeof i.x&&isFinite(i.x),a="number"==typeof i.y&&isFinite(i.y);if(o||a?(o&&(s=i.x),a&&(n=i.y)):(s=0,n=0,this.g92AssumedZero=!0,this._addWarning("Line ".concat(e,": G92 without coordinates; assuming X0 Y0 for start position."),e)),Rt.isValidCoordinate(s)&&Rt.isValidCoordinate(n))if(this.currentPosition.x=s,this.currentPosition.y=n,0!==this.path.length)this._addWarning("Line ".concat(e,": G92 after motion not fully supported; updated reference position for subsequent moves only."),e);else{if(this.g92Applied){const t=this.path[0];t&&"position"===t.type&&(t.x=s,t.y=n,t.line=e),this.g92Line=e}else this.path.push({type:"position",x:s,y:n,line:e,meta:{source:"G92"}}),this.g92Applied=!0,this.g92Line=e;this.bounds=Ht.updateBounds(this.bounds,s,n)}else this._addWarning("Line ".concat(e,": Invalid G92 coordinates; ignoring."),e)}_extractCoordinates(e){const i={};let s;for(t.REGEX.COORDINATE.lastIndex=0;null!==(s=t.REGEX.COORDINATE.exec(e));){const t=s[1].toLowerCase(),e=Rt.sanitizeCoordinate(s[2]);Rt.isValidCoordinate(e)&&(i[t]=zt.round(e,this.options.precision))}return i}_extractArcCenter(e){const i={};let s;for(t.REGEX.ARC_CENTER.lastIndex=0;null!==(s=t.REGEX.ARC_CENTER.exec(e));){const t=s[1].toLowerCase(),e=Rt.sanitizeCoordinate(s[2]);Rt.isValidCoordinate(e)&&(i[t]=zt.round(e,this.options.precision))}return i}_handleError(t,e){this.errors.push({line:e,message:t.message,type:"error"}),this.stats.errors++}_addWarning(t,e){this.warnings.push({line:e,message:t,type:"warning"})}_validateResult(){0===this.path.length&&this._addWarning("No valid G-Code commands found in input",0),Ht.isValidBounds(this.bounds)||(this._addWarning("No valid coordinate bounds found",0),this.bounds=Ht.createEmptyBounds())}getStats(){return{...this.stats}}getErrors(){return[...this.errors]}getWarnings(){return[...this.warnings]}hasErrors(){return this.errors.length>0}hasWarnings(){return this.warnings.length>0}};e(Zt,"VERSION","1.0.0"),e(Zt,"SUPPORTED_COMMANDS",{LINEAR:["G0","G1"],ARC:["G2","G3"]}),e(Zt,"REGEX",{COORDINATE:/([XYZ])(-?\d+\.?\d*)/g,ARC_CENTER:/([IJ])(-?\d+\.?\d*)/g,COMMENT:/[;(].*$/,LEADING_BLOCK_NUMBER:/^N\d+\s+/i});let jt=Zt;function Jt(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}class $t{constructor(t={}){var e;this.container=t.container,this.maxMessages=null!=(e=t.maxMessages)?e:5,this.ANIMATION=t.ANIMATION,this.STATUS=t.STATUS,this.queue=[],this.active=new Map}enqueue(t){return this.queue.push(t),this._process(),t.id}update(t,e,i=null){var s;const n=this.active.get(t);if(n){if("string"==typeof e&&e.length){n.message=e;const t=null==(s=n.element)?void 0:s.querySelector(".status-message-text");t&&(t.textContent=e)}"number"==typeof i&&(n.progress=Math.max(0,Math.min(100,i)),this._updateProgress(n))}}hide(t){const e=this.active.get(t);e&&this._hideMessage(e)}hideAll(){this.active.forEach(t=>{var e;t.timeoutId&&clearTimeout(t.timeoutId);try{null==(e=t.element)||e.remove()}catch(i){}}),this.active.clear(),this.queue.length=0,this.container&&(this.container.innerHTML="")}getStats(){return{activeMessages:this.active.size,queuedMessages:this.queue.length}}destroy(){this.hideAll(),this.container=null}_process(){if(this.active.size>=this.maxMessages||0===this.queue.length)return;const t=this.queue.shift();this._createMessageElement(t),this.active.set(t.id,t),!t.persistent&&t.duration>0&&(t.timeoutId=setTimeout(()=>this.hide(t.id),t.duration)),setTimeout(()=>this._process(),100)}_createMessageElement(t){const e=document.createElement("div");e.className="status-message status-message-".concat(t.type),e.setAttribute("data-message-id",t.id),function(t,e,i,s){const n={display:"flex",alignItems:"center",padding:"15px 20px",borderRadius:"5px",color:"white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 2px 10px rgba(0,0,0,0.3)",transition:"all ".concat(s.NORMAL,"ms ").concat(s.EASE),transform:"translateX(100%)",opacity:"0",marginBottom:"10px",maxWidth:"100%",wordWrap:"break-word",position:"relative"},o={success:i.COLORS.SUCCESS,error:i.COLORS.ERROR,warning:i.COLORS.WARNING,info:i.COLORS.INFO};n.backgroundColor=o[e]||i.COLORS.INFO,Object.assign(t.style,n)}(e,t.type,this.STATUS,this.ANIMATION),e.addEventListener("mouseenter",()=>{e.style.transform="translateX(0) scale(1.02)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateX(0) scale(1)"}),e.innerHTML=function(t,e){let i='\n    <div class="status-message-content">\n      <div class="status-message-text">'.concat(e(t.message),"</div>\n  ");return null!==t.progress&&(i+='\n      <div class="status-message-progress">\n        <div class="status-message-progress-bar" style="width: '.concat(t.progress,'%"></div>\n      </div>\n    ')),t.persistent&&(i+='\n      <button class="status-message-dismiss" type="button" aria-label="Dismiss">√ó</button>\n    '),i+="</div>",i}(t,Jt),e.addEventListener("click",()=>this.hide(t.id)),t.element=e,this.container.appendChild(e),this._animateIn(e)}_updateProgress(t){var e,i,s;const n=null==(e=t.element)?void 0:e.querySelector(".status-message-progress-bar");if(n)n.style.width="".concat(t.progress,"%");else{const e=document.createElement("div");e.className="status-message-progress",e.style.cssText="width:100%;height:4px;background-color:rgba(255,255,255,0.3);border-radius:2px;margin-top:8px;overflow:hidden;";const n=document.createElement("div");n.className="status-message-progress-bar",n.style.cssText="height:100%;background-color:rgba(255,255,255,0.8);border-radius:2px;transition:width ".concat(this.ANIMATION.FAST,"ms ease;width:").concat(t.progress,"%;"),e.appendChild(n),null==(s=null==(i=t.element)?void 0:i.querySelector(".status-message-content"))||s.appendChild(e)}}_animateIn(t){t.offsetHeight,t.style.transform="translateX(0)",t.style.opacity="1"}_hideMessage(t){t.timeoutId&&clearTimeout(t.timeoutId),t.element&&(t.element.style.transform="translateX(100%)",t.element.style.opacity="0",setTimeout(()=>{var e;try{null==(e=t.element)||e.remove()}catch(i){}this.active.delete(t.id),this._process()},this.ANIMATION.NORMAL))}}class Qt{constructor(t){this.status=t,this.cleanups=[]}init(){const t=st.on(G,t=>{this.status.show(t.message,t.type,t.duration,t.persistent)}),e=st.on(W,()=>{this.status.hideAll()}),i=st.on(q,t=>{this.status.update(t.id,t.message,t.progress)});this.cleanups.push(t,e,i)}destroy(){this.cleanups.forEach(t=>{try{"function"==typeof t&&t()}catch(e){}}),this.cleanups.length=0}}class te{constructor(t={}){this.container=t.container||document.body,this.position=t.position||"top-right",this.defaultDuration=t.defaultDuration||xt.DURATION,this.maxMessages=t.maxMessages||5,this.queue=null,this.toastManager=null,this.messageIdCounter=0,this.messageContainer=null,this.isAnimating=!1,this.eventCleanup=[],this.init()}init(){this.createMessageContainer(),this.queue=new $t({container:this.messageContainer,maxMessages:this.maxMessages,ANIMATION:Mt,STATUS:xt}),this.toastManager=new Qt(this),this.toastManager.init(),console.debug("StatusMessage component initialized")}createMessageContainer(){this.messageContainer=document.createElement("div"),this.messageContainer.id="statusMessageContainer",this.messageContainer.className="status-message-container",function(t,e,i){const s={position:"fixed",zIndex:"1000",pointerEvents:"none",display:"flex",flexDirection:"column",gap:"10px",maxWidth:"400px",fontFamily:"Arial, sans-serif",fontSize:"14px"};switch(e){case"top-right":s.top=i.POSITION.TOP,s.right=i.POSITION.RIGHT,s.alignItems="flex-end";break;case"top-left":s.top=i.POSITION.TOP,s.left=i.POSITION.LEFT,s.alignItems="flex-start";break;case"bottom-right":s.bottom=i.POSITION.BOTTOM,s.right=i.POSITION.RIGHT,s.alignItems="flex-end",s.flexDirection="column-reverse";break;case"bottom-left":s.bottom=i.POSITION.BOTTOM,s.left=i.POSITION.LEFT,s.alignItems="flex-start",s.flexDirection="column-reverse"}Object.assign(t.style,s)}(this.messageContainer,this.position,xt),this.container.appendChild(this.messageContainer)}show(t,e="info",i=null,s=!1){if(!t||"string"!=typeof t)return console.warn("StatusMessage: Invalid message provided"),null;["success","error","warning","info"].includes(e)||(console.warn("StatusMessage: Invalid type '".concat(e,"', defaulting to 'info'")),e="info");const n="status_".concat(++this.messageIdCounter,"_").concat(Date.now()),o={id:n,message:t,type:e,duration:null!==i?i:this.defaultDuration,persistent:s,createdAt:Date.now(),element:null,timeoutId:null,progress:null};return this.queue.enqueue(o),n}update(t,e,i=null){t?this.queue.update(t,e,i):console.warn("StatusMessage: Invalid message ID for update")}hide(t){t?this.queue.hide(t):console.warn("StatusMessage: Invalid message ID for hide")}hideAll(){this.queue.hideAll()}success(t,e=null){return this.show(t,"success",e)}error(t,e=null){return this.show(t,"error",e||2*xt.DURATION)}warning(t,e=null){return this.show(t,"warning",e)}info(t,e=null){return this.show(t,"info",e)}progress(t,e=0){const i=this.show(t,"info",null,!0);return this.update(i,t,e),i}getStats(){var t;return{...(null==(t=this.queue)?void 0:t.getStats())||{activeMessages:0,queuedMessages:0},totalMessagesSent:this.messageIdCounter,maxMessages:this.maxMessages,defaultDuration:this.defaultDuration,position:this.position}}destroy(){var t,e;this.hideAll();try{null==(t=this.toastManager)||t.destroy()}catch(i){}try{null==(e=this.queue)||e.destroy()}catch(i){}this.messageContainer&&this.messageContainer.parentNode&&this.messageContainer.parentNode.removeChild(this.messageContainer),this.messageContainer=null,console.debug("StatusMessage component destroyed")}}function ee(t,e={}){const{startN:i=10,step:s=10,addPercent:n=!0,ensureM02:o=!0,crlf:a=!0,stripSemicolon:r=!0}=e;"string"!=typeof t&&(t=String(null!=t?t:""));const l=t.split(/\r?\n/),h=[];n&&(l.length&&"%"===l[0].trim()?(h.push("%"),l.shift()):h.push("%"));let c=i;for(let u=0;u<l.length;u++){let t=l[u];if(!t)continue;let e=t.trim();if(e&&"%"!==e){if(r){const t=e.indexOf(";");if(t>=0&&(e=e.slice(0,t).trimEnd(),!e))continue}e=e.replace(/\s+/g," ").trim(),e=ie(e),/^N\d+\b/i.test(e)?h.push(e):(h.push("N".concat(c," ").concat(e)),c+=s)}}if(o){const t=[];for(const e of h)/\bM0?2\b/i.test(e)||t.push(e);h.length=0,h.push(...t),h.push("N".concat(c," M02"))}const d=a?"\r\n":"\n";return h.join(d)+d}function ie(t){return"string"!=typeof t?""+t:t.replace(/\bG0+([0-3])(?!\d)/gi,"G$1")}const se=class t{constructor(t={}){this.statusMessage=t.statusMessage||null,this.gCodeParser=t.gCodeParser||new jt,this.eventBus=st.getInstance(),this.isProcessing=!1,this.currentFile=null,this.loadedData=null,this._bindMethods()}_bindMethods(){this.loadFile=this.loadFile.bind(this),this.exportPoints=this.exportPoints.bind(this),this.exportISOFromPoints=this.exportISOFromPoints.bind(this),this.normalizeContentToISO=this.normalizeContentToISO.bind(this),this.exportNormalizedISOFromText=this.exportNormalizedISOFromText.bind(this),this.validateFile=this.validateFile.bind(this)}async loadFile(t){var e,i,s,a,r;if(this.isProcessing)return null==(e=this.statusMessage)||e.warning("File operation already in progress"),null;try{this.isProcessing=!0,this.currentFile=t;const e=this.validateFile(t);if(!e.valid)return null==(i=this.statusMessage)||i.error(e.message),null;const r=await this._readFileContent(t),l=this.gCodeParser.parse(r);if(!l||!l.path||0===l.path.length){const e=l&&l.errors&&l.errors.length>0?l.errors[0].message:"No valid G-code commands found";return null==(s=this.statusMessage)||s.error("Parse error: ".concat(e)),this.eventBus.emit(o,{file:t,error:e}),null}return this.loadedData={file:t,content:r,parseResult:l},null==(a=this.statusMessage)||a.success("G-code loaded successfully!"),this.eventBus.emit(n,{file:t,path:l.path,bounds:l.bounds,stats:l.stats}),l}catch(l){return null==(r=this.statusMessage)||r.error("Failed to load file: ".concat(l.message)),this.eventBus.emit(o,{file:t,error:l}),null}finally{this.isProcessing=!1}}validateFile(e){if(!e)return{valid:!1,message:"No file provided"};if(e.size>t.MAX_FILE_SIZE){const i=(e.size/1048576).toFixed(2),s=(t.MAX_FILE_SIZE/1048576).toFixed(0);return{valid:!1,message:"File too large (".concat(i,"MB). Maximum size is ").concat(s,"MB.")}}const i=e.name.toLowerCase();return t.SUPPORTED_EXTENSIONS.some(t=>i.endsWith(t))?0===e.size?{valid:!1,message:"File is empty"}:{valid:!0,message:"File is valid"}:{valid:!1,message:"Unsupported file type. Supported formats: ".concat(t.SUPPORTED_EXTENSIONS.join(", "))}}exportPoints(t,e={}){var i,s,n;if(!t||0===t.length)return null==(i=this.statusMessage)||i.warning("No points to export!"),!1;try{const i=e.filename||"wire_path_points.gcode",n=!1!==e.includeHeader;let o="";n&&(o+="".concat(Lt.HEADER_COMMENT,"\n"),o+="; Generated on ".concat((new Date).toLocaleString(),"\n"),o+="; Total points: ".concat(t.length,"\n\n")),t.forEach((t,e)=>{o+="; Point ".concat(e+1,"\n"),o+="G0 X".concat(t.x.toFixed(Tt.DEFAULT_PRECISION)," Y").concat(t.y.toFixed(Tt.DEFAULT_PRECISION),"\n")}),n&&(o+="\n; End of exported points\n");return!!this._downloadFile(o,i,Lt.MIME_TYPE)&&(null==(s=this.statusMessage)||s.success("Points exported successfully! (".concat(t.length," points)")),this.eventBus.emit(X,{pointCount:t.length,filename:i,format:"gcode",points:t}),!0)}catch(o){return null==(n=this.statusMessage)||n.error("Export failed: ".concat(o.message)),this.eventBus.emit(Y,{error:o}),!1}}exportISOFromPoints(t,e={}){var i,s,n,o,a,r,l;if(!t||0===t.length)return null==(i=this.statusMessage)||i.warning("No points to export!"),!1;try{const i=function(t,e={}){const{startN:i=10,step:s=10,crlf:n=!0,precision:o=3,feed:a=1e3,headerCodes:r=["G92","G60","G38","G42 D0","G90"]}=e,l=["%"];let h=i;for(const p of r)l.push("N".concat(h," ").concat(p)),h+=s;if(!t||0===t.length){l.push("N".concat(h," M02"));const t=n?"\r\n":"\n";return l.join(t)+t}const c=t=>Number(t).toFixed(o),d=t[0];l.push("N".concat(h," G0 X").concat(c(d.x)," Y").concat(c(d.y))),h+=s;for(let p=1;p<t.length;p++){const e=t[p];1===p&&"number"==typeof a?l.push("N".concat(h," G1 X").concat(c(e.x)," Y").concat(c(e.y)," F").concat(a)):l.push("N".concat(h," G1 X").concat(c(e.x)," Y").concat(c(e.y))),h+=s}l.push("N".concat(h," M02"));const u=n?"\r\n":"\n";return l.join(u)+u}(t,{startN:null!=(s=e.startN)?s:10,step:null!=(n=e.step)?n:10,precision:null!=(o=e.precision)?o:Tt.DEFAULT_PRECISION,feed:null!=(a=e.feed)?a:1e3,crlf:!0}),l=e.filename||"program.iso";return!!this._downloadFile(i,l,It.MIME_TYPE)&&(null==(r=this.statusMessage)||r.success("ISO exported successfully (".concat(t.length," points)")),this.eventBus.emit(X,{pointCount:t.length,filename:l,format:"iso",points:t}),!0)}catch(h){return null==(l=this.statusMessage)||l.error("ISO export failed: ".concat(h.message)),this.eventBus.emit(Y,{error:h}),!1}}normalizeContentToISO(t,e={}){return ee(t,e)}exportNormalizedISOFromText(t,e={}){var i,s,n,o;try{const o=ee(t||"",{startN:null!=(i=e.startN)?i:10,step:null!=(s=e.step)?s:10,addPercent:!0,ensureM02:!0,crlf:!0,stripSemicolon:!0}),a=e.filename||"program.iso";return!!this._downloadFile(o,a,It.MIME_TYPE)&&(null==(n=this.statusMessage)||n.success("ISO exported successfully"),this.eventBus.emit(X,{filename:a,format:"iso"}),!0)}catch(a){return null==(o=this.statusMessage)||o.error("ISO export failed: ".concat(a.message)),this.eventBus.emit(Y,{error:a}),!1}}getFileInfo(){if(!this.loadedData)return null;const{file:t,parseResult:e}=this.loadedData;return{name:t.name,size:t.size,type:t.type,lastModified:new Date(t.lastModified),stats:e.stats,bounds:e.bounds}}clearLoadedFile(){this.loadedData=null,this.currentFile=null,this.eventBus.emit(r)}_readFileContent(t){return new Promise((e,i)=>{const s=new FileReader;s.onload=t=>{e(t.target.result)},s.onerror=()=>{i(new Error("Failed to read file"))},s.onprogress=t=>{if(t.lengthComputable){const e=t.loaded/t.total*100;this.eventBus.emit(a,{progress:Math.round(e)})}},s.readAsText(t)})}_downloadFile(t,e,i){try{const s=new Blob([t],{type:i}),n=URL.createObjectURL(s),o=document.createElement("a");return o.href=n,o.download=e,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),!0}catch(s){return console.error("Download failed:",s),!1}}destroy(){this.clearLoadedFile(),this.isProcessing=!1,this.currentFile=null,this.statusMessage=null,this.gCodeParser=null}};e(se,"VERSION","1.0.0"),e(se,"SUPPORTED_EXTENSIONS",Et),e(se,"MAX_FILE_SIZE",Ct);let ne=se;class oe{constructor(t={},e={}){this.elements=t,this.onChooseFile=e.onChooseFile||(()=>{}),this.isInitialized=!1,this._bound=null}init(){this.isInitialized||(this._bind(),this._attach(),this.isInitialized=!0)}destroy(){this._detach(),this._bound=null,this.isInitialized=!1}_bind(){this._bound={onChange:t=>{const e=t.target,i=e&&e.files&&e.files[0];i&&this.onChooseFile(i)},onDragOver:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.add("drag-over")},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.remove("drag-over")},onDrop:t=>{t.preventDefault(),t.stopPropagation(),this.elements.fileInputLabel&&this.elements.fileInputLabel.classList.remove("drag-over");const e=t.dataTransfer;e&&e.files&&e.files.length>0&&this.onChooseFile(e.files[0])}}}_attach(){const{fileInput:t,fileInputLabel:e}=this.elements;t&&t.addEventListener("change",this._bound.onChange),e&&(e.addEventListener("dragover",this._bound.onDragOver),e.addEventListener("dragleave",this._bound.onDragLeave),e.addEventListener("drop",this._bound.onDrop))}_detach(){var t,e,i,s;const{fileInput:n,fileInputLabel:o}=this.elements;n&&(null==(t=this._bound)?void 0:t.onChange)&&n.removeEventListener("change",this._bound.onChange),o&&((null==(e=this._bound)?void 0:e.onDragOver)&&o.removeEventListener("dragover",this._bound.onDragOver),(null==(i=this._bound)?void 0:i.onDragLeave)&&o.removeEventListener("dragleave",this._bound.onDragLeave),(null==(s=this._bound)?void 0:s.onDrop)&&o.removeEventListener("drop",this._bound.onDrop))}}class ae{constructor(t={}){this.elements=t,this.isInitialized=!1,this._bound=null,this.bus=st.getInstance(),this._offZoom=null}init(){this.isInitialized||(this._bind(),this._attach(),this._subscribe(),this.isInitialized=!0)}destroy(){this._detach(),"function"==typeof this._offZoom&&this._offZoom(),this._offZoom=null,this._bound=null,this.isInitialized=!1}_bind(){this._bound={onZoomIn:()=>{this.bus.emit(u,{type:"in",source:"toolbar"},{skipValidation:!0})},onZoomOut:()=>{this.bus.emit(u,{type:"out",source:"toolbar"},{skipValidation:!0})},onFit:()=>{this.bus.emit(m,{source:"toolbar"})}}}_attach(){const{zoomInButton:t,zoomOutButton:e,fitToScreenButton:i}=this.elements;t&&t.addEventListener("click",this._bound.onZoomIn),e&&e.addEventListener("click",this._bound.onZoomOut),i&&i.addEventListener("click",this._bound.onFit)}_detach(){var t,e,i;const{zoomInButton:s,zoomOutButton:n,fitToScreenButton:o}=this.elements;s&&(null==(t=this._bound)?void 0:t.onZoomIn)&&s.removeEventListener("click",this._bound.onZoomIn),n&&(null==(e=this._bound)?void 0:e.onZoomOut)&&n.removeEventListener("click",this._bound.onZoomOut),o&&(null==(i=this._bound)?void 0:i.onFit)&&o.removeEventListener("click",this._bound.onFit)}_subscribe(){this._offZoom=this.bus.on(u,t=>{if(t&&"number"==typeof t.zoom){const e=Math.round(100*t.zoom);this.elements.zoomDisplay&&(this.elements.zoomDisplay.textContent="".concat(e,"%"))}})}}class re{constructor(t={},e={}){this.elements=t,this.getTextForNormalization=e.getTextForNormalization||(()=>""),this.exportNormalizedISOFromText=e.exportNormalizedISOFromText||(()=>!1),this.isInitialized=!1,this._bound=null,this.bus=st.getInstance()}init(){this.isInitialized||(this._bind(),this._attach(),this.isInitialized=!0)}destroy(){this._detach(),this._bound=null,this.isInitialized=!1}_bind(){this._bound={onClear:()=>{this.bus.emit(T,{source:"toolbar"})},onExportISO:()=>{this.bus.emit(N,{source:"toolbar",format:"iso"})},onToggleDrawer:()=>{this.bus.emit("drawer:toggle")},onNormalizeISO:()=>{const t=this.getTextForNormalization()||"",e="normalized_".concat((new Date).toISOString().slice(0,19).replace(/[:T]/g,"-"),".iso");this.exportNormalizedISOFromText(t,{filename:e})&&this.bus.emit("status:show",{message:"Normalized to ISO",type:"success"},{skipValidation:!0})}}}_attach(){const{clearPointsButton:t,exportPointsButton:e,drawerToggleButton:i,normalizeButton:s}=this.elements;t&&t.addEventListener("click",this._bound.onClear),e&&e.addEventListener("click",this._bound.onExportISO),i&&i.addEventListener("click",this._bound.onToggleDrawer),s&&s.addEventListener("click",this._bound.onNormalizeISO)}_detach(){var t,e,i,s;const{clearPointsButton:n,exportPointsButton:o,drawerToggleButton:a,normalizeButton:r}=this.elements;n&&(null==(t=this._bound)?void 0:t.onClear)&&n.removeEventListener("click",this._bound.onClear),o&&(null==(e=this._bound)?void 0:e.onExportISO)&&o.removeEventListener("click",this._bound.onExportISO),a&&(null==(i=this._bound)?void 0:i.onToggleDrawer)&&a.removeEventListener("click",this._bound.onToggleDrawer),r&&(null==(s=this._bound)?void 0:s.onNormalizeISO)&&r.removeEventListener("click",this._bound.onNormalizeISO)}}class le{constructor(t,e={}){if(!t)throw new Error("Container element is required");this.container=t,this.options={enableFileInput:!0,enableZoomControls:!0,enableUtilityButtons:!0,...e},this.eventBus=st.getInstance(),this.gcodeDrawer=this.options.gcodeDrawer||null,this.fileHandler=new ne,this.fileControls=null,this.viewControls=null,this.actionControls=null,this.state={currentFile:null,zoomLevel:ht,isFileLoading:!1,hasClickedPoints:!1},this.elements={fileInput:null,fileInputLabel:null,zoomInButton:null,zoomOutButton:null,fitToScreenButton:null,zoomDisplay:null,clearPointsButton:null,exportPointsButton:null},this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._onPointsChange=this._onPointsChange.bind(this),this._onFileLoadStart=this._onFileLoadStart.bind(this),this._onFileLoadSuccess=this._onFileLoadSuccess.bind(this),this._onFileLoadError=this._onFileLoadError.bind(this),this._onPointsExportResponse=this._onPointsExportResponse.bind(this)}init(){if(this.isInitialized)console.warn("Toolbar already initialized");else try{this._renderToolbar(),this._setupEventListeners(),this._subscribeToEvents(),this.isInitialized=!0,console.log("Toolbar initialized successfully")}catch(t){throw console.error("Failed to initialize Toolbar:",t),t}}_renderToolbar(){const t="\n      ".concat(this.options.enableFileInput?this._renderFileInput():"","\n      ").concat(this.options.enableZoomControls?this._renderZoomControls():"","\n      ").concat(this.options.enableUtilityButtons?this._renderUtilityButtons():"","\n    ");this.container.innerHTML=t,this._getElementReferences()}_renderFileInput(){return'\n      <div class="file-input-wrapper">\n        <input type="file" id="fileInput" accept=".gcode,.nc,.txt,.iso" data-toolbar="file-input">\n        <label for="fileInput" class="file-input-label" data-toolbar="file-input-label" title="Load G-Code files (.gcode, .nc, .txt) or drag and drop files here">\n          Load G-Code File\n        </label>\n      </div>\n    '}_renderZoomControls(){return'\n      <div class="zoom-controls">\n        <button data-toolbar="zoom-in" type="button" title="Zoom in (or use mouse wheel)">Zoom +</button>\n        <button data-toolbar="zoom-out" type="button" title="Zoom out (or use mouse wheel)">Zoom -</button>\n        <button data-toolbar="fit-to-screen" type="button" title="Fit G-Code to screen">Fit to Screen</button>\n        <span class="zoom-display" title="Current zoom level">Zoom: <span data-toolbar="zoom-level">100%</span></span>\n      </div>\n    '}_renderUtilityButtons(){return'\n      <button data-toolbar="clear-points" type="button" title="Clear all measurement points">Clear Points</button>\n      <button data-toolbar="export-points" type="button" title="Export clicked points as ISO file (.iso)">Export ISO</button>\n      <button data-toolbar="toggle-gcode-drawer" type="button" title="Show/Hide G-Code preview drawer">G-Code Drawer</button>\n      <button data-toolbar="normalize-to-iso" type="button" title="Normalize current drawer content to .iso (no points needed)">Normalize to ISO</button>\n    '}_getElementReferences(){this.elements.fileInput=this.container.querySelector('[data-toolbar="file-input"]'),this.elements.fileInputLabel=this.container.querySelector('[data-toolbar="file-input-label"]'),this.elements.zoomInButton=this.container.querySelector('[data-toolbar="zoom-in"]'),this.elements.zoomOutButton=this.container.querySelector('[data-toolbar="zoom-out"]'),this.elements.fitToScreenButton=this.container.querySelector('[data-toolbar="fit-to-screen"]'),this.elements.zoomDisplay=this.container.querySelector('[data-toolbar="zoom-level"]'),this.elements.clearPointsButton=this.container.querySelector('[data-toolbar="clear-points"]'),this.elements.exportPointsButton=this.container.querySelector('[data-toolbar="export-points"]'),this.elements.drawerToggleButton=this.container.querySelector('[data-toolbar="toggle-gcode-drawer"]'),this.elements.normalizeButton=this.container.querySelector('[data-toolbar="normalize-to-iso"]')}_setupEventListeners(){this.fileControls=new oe({fileInput:this.elements.fileInput,fileInputLabel:this.elements.fileInputLabel},{onChooseFile:t=>this._loadFile(t)}),this.fileControls.init(),this.viewControls=new ae({zoomInButton:this.elements.zoomInButton,zoomOutButton:this.elements.zoomOutButton,fitToScreenButton:this.elements.fitToScreenButton,zoomDisplay:this.elements.zoomDisplay}),this.viewControls.init(),this.actionControls=new re({clearPointsButton:this.elements.clearPointsButton,exportPointsButton:this.elements.exportPointsButton,drawerToggleButton:this.elements.drawerToggleButton,normalizeButton:this.elements.normalizeButton},{getTextForNormalization:()=>{var t,e,i,s;const n=null==(e=null==(t=this.gcodeDrawer)?void 0:t.getText)?void 0:e.call(t);return n&&""!==n.trim()?n:(null==(s=null==(i=this.fileHandler)?void 0:i.loadedData)?void 0:s.content)||""},exportNormalizedISOFromText:(t,e)=>{var i,s;return null==(s=null==(i=this.fileHandler)?void 0:i.exportNormalizedISOFromText)?void 0:s.call(i,t,e)}}),this.actionControls.init()}setGCodeDrawer(t){this.gcodeDrawer=t||null}_subscribeToEvents(){this.eventBus.on(x,this._onPointsChange),this.eventBus.on(s,this._onFileLoadStart),this.eventBus.on(n,this._onFileLoadSuccess),this.eventBus.on(o,this._onFileLoadError),this.eventBus.on(X,this._onPointsExportResponse)}_exportPoints(t){if(!t||0===t.length)return;this.fileHandler.exportPoints(t)&&this._updateButtons()}async _loadFile(t){try{this.state.currentFile=t,this.state.isFileLoading=!0,this.eventBus.emit(s,{file:t});await this.fileHandler.loadFile(t)?(this.state.isFileLoading=!1,this._updateFileInputDisplay("".concat(t.name," loaded")),this._updateButtons()):(this.state.isFileLoading=!1,this.state.currentFile=null,this._updateFileInputDisplay("Load G-Code File"),this._updateButtons())}catch(e){this.state.isFileLoading=!1,this.state.currentFile=null,this._updateFileInputDisplay("Load G-Code File"),this._updateButtons(),console.error("File loading error:",e)}}_onPointsChange(t){this.state.hasClickedPoints=t.pointCount>0,this._updateButtonStates()}_onFileLoadStart(t){this.state.isFileLoading=!0,this._updateFileInputLabel("Loading..."),this._updateButtonStates()}_onFileLoadSuccess(t){this.state.isFileLoading=!1,this._updateFileInputLabel("Load G-Code File"),this._updateButtonStates()}_onFileLoadError(t){this.state.isFileLoading=!1,this._updateFileInputLabel("Load G-Code File"),this._updateButtonStates(),this.elements.fileInput&&(this.elements.fileInput.value="")}_onPointsExportResponse(t){this._updateButtonStates()}_updateFileInputLabel(t){this.elements.fileInputLabel&&(this.elements.fileInputLabel.textContent=t)}_updateFileInputDisplay(t){this._updateFileInputLabel(t)}_updateButtons(){this._updateButtonStates()}_updateButtonStates(){this.elements.exportPointsButton&&(this.elements.exportPointsButton.disabled=!this.state.hasClickedPoints),this.elements.clearPointsButton&&(this.elements.clearPointsButton.disabled=!this.state.hasClickedPoints),this.elements.fileInput&&(this.elements.fileInput.disabled=this.state.isFileLoading)}getState(){return{...this.state,isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}updateOptions(t){this.options={...this.options,...t},this.isInitialized&&(this._renderToolbar(),this._setupEventListeners())}destroy(){this.isDestroyed||(this.eventBus.off(x,this._onPointsChange),this.eventBus.off(s,this._onFileLoadStart),this.eventBus.off(n,this._onFileLoadSuccess),this.eventBus.off(o,this._onFileLoadError),this.eventBus.off(X,this._onPointsExportResponse),this.container.innerHTML="",this.fileHandler&&(this.fileHandler.destroy(),this.fileHandler=null),this.fileControls&&(this.fileControls.destroy(),this.fileControls=null),this.viewControls&&(this.viewControls.destroy(),this.viewControls=null),this.actionControls&&(this.actionControls.destroy(),this.actionControls=null),this.elements={},this.state={currentFile:null,zoomLevel:ht,isFileLoading:!1,hasClickedPoints:!1},this.isDestroyed=!0)}}class he{constructor(t,e={}){if(!t)throw new Error("Sidebar requires a container element");this.container=t,this.options={showCoordinates:!0,showPoints:!0,showPathInfo:!0,...e},this.currentMousePosition={x:0,y:0},this.gridSnapEnabled=!1,this.clickedPoints=[],this.pathInfo=null,this.init()}init(){try{this.createSidebarStructure(),this.bindEvents(),this.updateDisplay()}catch(t){throw console.error("Failed to initialize Sidebar:",t),t}}createSidebarStructure(){if(this.container.innerHTML='\n      <div class="sidebar">\n        <div class="coordinates-display">\n          <h3>Current Position</h3>\n          <div class="coordinate-item">Mouse X: <span id="mouseX">0.000</span> mm</div>\n          <div class="coordinate-item">Mouse Y: <span id="mouseY">0.000</span> mm</div>\n          <div class="coordinate-item">Grid Snap: <span id="gridSnap">OFF</span></div>\n        </div>\n        \n        <div class="clicked-points">\n          <h3>Clicked Points</h3>\n          <div class="point-list" id="pointList"></div>\n        </div>\n        \n        <div class="path-info">\n          <h3>Path Information</h3>\n          <div id="pathInfo">No G-Code loaded</div>\n        </div>\n        \n        <div class="usage-panel">\n          <h3>Usage & Controls</h3>\n          <div class="usage-content">\n            <div class="usage-section">\n              <h4>File Operations</h4>\n              <p>‚Ä¢ Use "Load G-Code File" button to upload .gcode, .nc, or .txt files</p>\n              <p>‚Ä¢ Drag and drop files onto the load button</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Navigation</h4>\n              <p>‚Ä¢ <strong>Mouse wheel:</strong> Zoom in/out</p>\n              <p>‚Ä¢ <strong>Shift + Click:</strong> Pan view</p>\n              <p>‚Ä¢ <strong>Zoom buttons:</strong> +/- or Fit to Screen</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Measurement</h4>\n              <p>‚Ä¢ <strong>Click:</strong> Add measurement point</p>\n              <p>‚Ä¢ <strong>Clear Points:</strong> Remove all points</p>\n              <p>‚Ä¢ <strong>Export Points:</strong> Save as G-Code</p>\n            </div>\n            \n            <div class="usage-section">\n              <h4>Keyboard Shortcuts</h4>\n              <p>‚Ä¢ <strong>G:</strong> Toggle grid snap ON/OFF</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',this.mouseXElement=this.container.querySelector("#mouseX"),this.mouseYElement=this.container.querySelector("#mouseY"),this.gridSnapElement=this.container.querySelector("#gridSnap"),this.pointListElement=this.container.querySelector("#pointList"),this.pathInfoElement=this.container.querySelector("#pathInfo"),!(this.mouseXElement&&this.mouseYElement&&this.gridSnapElement&&this.pointListElement&&this.pathInfoElement))throw new Error("Failed to create sidebar DOM elements")}bindEvents(){const t=st.getInstance();this._unsubscribes=[],this._handleMouseMove=this.handleMouseMove.bind(this),this._handleMouseLeave=this.handleMouseLeave.bind(this),this._handleGridSnapToggle=this.handleGridSnapToggle.bind(this),this._handlePointUpdate=this.handlePointUpdate.bind(this),this._handleParseSuccess=this.handlePathInfoUpdate.bind(this),this._handleFileLoad=this.handleFileLoad.bind(this),this._unsubscribes.push(t.on(v,this._handleMouseMove)),this._unsubscribes.push(t.on(w,this._handleMouseLeave)),this._unsubscribes.push(t.on(P,this._handleGridSnapToggle)),this._unsubscribes.push(t.on(x,this._handlePointUpdate)),this._unsubscribes.push(t.on(h,this._handleParseSuccess)),this._unsubscribes.push(t.on(n,this._handleFileLoad))}handleMouseMove(t){t&&"number"==typeof t.worldX&&"number"==typeof t.worldY&&(this.currentMousePosition={x:t.worldX,y:t.worldY},this.updateCoordinateDisplay())}handleMouseLeave(){this.currentMousePosition={x:0,y:0},this.updateCoordinateDisplay()}handleGridSnapToggle(t){this.gridSnapEnabled=(null==t?void 0:t.enabled)||!1,this.updateGridSnapDisplay()}handlePointUpdate(t){t&&"number"==typeof t.pointCount?(this.clickedPoints=t.points||[],this.updatePointList()):console.warn("Invalid point update event data:",t)}handlePathInfoUpdate(t){t&&(this.pathInfo={totalMoves:t.totalMoves||0,rapidMoves:t.rapidMoves||0,cuttingMoves:t.cuttingMoves||0,arcMoves:t.arcMoves||0,bounds:t.bounds||null,parseTime:t.parseTime||0},this.updatePathInfoDisplay())}handleFileLoad(t){var e,i;t&&(this.pathInfo&&(this.pathInfo.fileName=(null==(e=t.file)?void 0:e.name)||"Unknown",this.pathInfo.fileSize=(null==(i=t.file)?void 0:i.size)||0),this.updatePathInfoDisplay())}updateCoordinateDisplay(){if(!this.mouseXElement||!this.mouseYElement)return;const t=this.currentMousePosition.x.toFixed(Dt),e=this.currentMousePosition.y.toFixed(Dt);this.mouseXElement.textContent=t,this.mouseYElement.textContent=e}updateGridSnapDisplay(){this.gridSnapElement&&(this.gridSnapElement.textContent=this.gridSnapEnabled?"ON":"OFF",this.gridSnapElement.classList.toggle("enabled",this.gridSnapEnabled))}updatePointList(){if(!this.pointListElement)return;if(0===this.clickedPoints.length)return void(this.pointListElement.innerHTML='<div class="no-points">No points selected</div>');const t=this.clickedPoints.map(t=>{var e;const i=t.x.toFixed(Dt),s=t.y.toFixed(Dt);return'\n        <div class="point-item" data-point-id="'.concat(t.id,'">\n          <span class="point-label">P').concat((null!=(e=t.index)?e:0)+1,'</span>\n          <span class="point-coords">(').concat(i,", ").concat(s,')</span>\n          <button class="delete-point-btn" data-point-id="').concat(t.id,'" title="Delete point">√ó</button>\n        </div>\n      ')}).join("");this.pointListElement.innerHTML=t}updatePathInfoDisplay(){if(!this.pathInfoElement)return;if(!this.pathInfo)return void(this.pathInfoElement.innerHTML="No G-Code loaded");const t=this.pathInfo.bounds,e=t?"".concat(t.minX.toFixed(1),", ").concat(t.minY.toFixed(1)," to ").concat(t.maxX.toFixed(1),", ").concat(t.maxY.toFixed(1)):"Unknown";this.pathInfoElement.innerHTML='\n      <div class="path-stat">\n        <span class="stat-label">Total Moves:</span> \n        <span class="stat-value">'.concat(this.pathInfo.totalMoves,'</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Rapid Moves:</span> \n        <span class="stat-value">').concat(this.pathInfo.rapidMoves,'</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Cutting Moves:</span> \n        <span class="stat-value">').concat(this.pathInfo.cuttingMoves,'</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Arc Moves:</span> \n        <span class="stat-value">').concat(this.pathInfo.arcMoves,'</span>\n      </div>\n      <div class="path-stat">\n        <span class="stat-label">Bounds:</span> \n        <span class="stat-value">').concat(e,"</span>\n      </div>\n      ").concat(this.pathInfo.fileName?'\n        <div class="path-stat">\n          <span class="stat-label">File:</span> \n          <span class="stat-value">'.concat(this.pathInfo.fileName,"</span>\n        </div>\n      "):"","\n    ")}reindexPoints(){this.clickedPoints.forEach((t,e)=>{t.index=e+1})}updateDisplay(){this.updateCoordinateDisplay(),this.updateGridSnapDisplay(),this.updatePointList(),this.updatePathInfoDisplay()}getState(){return{mousePosition:{...this.currentMousePosition},gridSnapEnabled:this.gridSnapEnabled,clickedPoints:[...this.clickedPoints],pathInfo:this.pathInfo?{...this.pathInfo}:null}}destroy(){st.getInstance(),Array.isArray(this._unsubscribes)&&(this._unsubscribes.forEach(t=>{try{t&&t()}catch(e){}}),this._unsubscribes.length=0),this.container.innerHTML="",this.mouseXElement=null,this.mouseYElement=null,this.gridSnapElement=null,this.pointListElement=null,this.pathInfoElement=null,this.clickedPoints=[],this.pathInfo=null}}function ce(t){if(!t||"string"!=typeof t)return"";const e=document.createElement("div");e.textContent=t;let i=e.innerHTML;const s={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#x27;":"'","&#x2F;":"/"};return i=i.replace(/&(lt|gt|amp|quot|#x27|#x2F);/g,(t,e)=>s["&".concat(e,";")]||t),i=i.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim(),i}function de(t){if(!t)return;const e=t.textContent||"",i=ce(e);if(e!==i){const e=window.getSelection(),n=e.rangeCount>0?e.getRangeAt(0):null,o=n?n.startOffset:0;t.textContent=i;try{n&&i.length>=o&&(n.setStart(t.childNodes[0]||t,Math.min(o,i.length)),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}catch(s){}}}function ue(t){return"string"!=typeof t?"":t.replace(/[;(].*$/g,"").trim()}function pe(t){return(t||"").replace(/^N\d+\s+/i,"")}function ge(t){if(!t)return!1;const e=ie(pe(ue(t))).toUpperCase();return/^(G0|G1|G2|G3)\b/.test(e)}function me(t){if("string"!=typeof t)return{x:null,y:null,xText:null,yText:null};const e=ue(t),i="[-+]?(?:\\d+(?:\\.\\d*)?|\\.\\d+)(?:[Ee][-+]?\\d+)?",s=e.match(new RegExp("\\bX\\s*("+i+")","i")),n=e.match(new RegExp("\\bY\\s*("+i+")","i")),o=s?s[1]:null,a=n?n[1]:null;return{x:null!=o?parseFloat(o):null,y:null!=a?parseFloat(a):null,xText:o,yText:a}}function ve(t,e,i=1e-6){return null!=t&&null!=e&&(null!=t.x&&null!=t.y&&null!=e.x&&null!=e.y&&(Math.abs(t.x-e.x)<=i&&Math.abs(t.y-e.y)<=i))}function ye(t,e,i={}){const{ensureClosure:s=!0}=i;if("string"!=typeof t||!t.length)return{text:t||"",newStartLine:1};const n=t.split(/\r?\n/);if(!Array.isArray(n)||0===n.length)return{text:t,newStartLine:1};let o=[...n],a=-1;for(let w=0;w<o.length;w++)if(ge(o[w])){a=w;break}if(-1===a)return{text:t,newStartLine:1};const r=o.slice(0,a),l=o.slice(a),h=(c=(0|e)-1,d=0,u=o.length-1,Math.max(d,Math.min(u,c)));var c,d,u;let p=Math.max(0,h-a);const g=ge(o[h]);if(h<a||!g)return{text:t,newStartLine:r.length+1};const m=me(l[p]),v=me(l[0]),y=l.slice(p).concat(l.slice(0,p)),f=0===p?0:l.length-p;if(f>0&&f<y.length){const t=f-1;ve(me(y[t]),v)&&y.splice(t,1)}const b=0===p?0:l.length-p;if(b>0){const t=y[b]||"",e=ie(pe(ue(t))).toUpperCase();/^G0\b/.test(e)&&(y[b]=function(t){if("string"!=typeof t)return t;const e=t.match(/[;(].*$/),i=e?t.slice(e.index):"";return ie(e?t.slice(0,e.index):t).replace(/^(\s*(?:N\d+\s+)?)(G0)\b/i,(t,e)=>"".concat(e,"G1"))+i}(t))}if(s){let t=y.length-1;for(;t>=0&&""===(y[t]||"").trim();)t--;ve(me(t>=0?y[t]:""),m)||y.push(function(t,e){const i=["G1"];return null!=t&&i.push("X".concat(t)),null!=e&&i.push("Y".concat(e)),i.join(" ")}(m.xText,m.yText))}const S=[...r,...y],_=r.length+1;return{text:S.join("\n"),newStartLine:_}}class fe{constructor(t={}){this.undoStack=[],this.redoStack=[],this.maxHistorySize="number"==typeof t.max?t.max:50,this._onChange="function"==typeof t.onChange?t.onChange:null}setMax(t){if("number"==typeof t&&t>0){for(this.maxHistorySize=t;this.undoStack.length>this.maxHistorySize;)this.undoStack.shift();this._notify()}}onChange(t){this._onChange="function"==typeof t?t:null}push(t){this.undoStack.push(t),this.redoStack=[],this.undoStack.length>this.maxHistorySize&&this.undoStack.shift(),this._notify()}undo(){if(0===this.undoStack.length)return null;const t=this.undoStack.pop();return t.undo(),this.redoStack.push(t),this._notify(),t}redo(){if(0===this.redoStack.length)return null;const t=this.redoStack.pop();return t.execute(),this.undoStack.push(t),this._notify(),t}clear(){this.undoStack=[],this.redoStack=[],this._notify()}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoCount(){return this.undoStack.length}getRedoCount(){return this.redoStack.length}_notify(){if(this._onChange)try{this._onChange({canUndo:this.canUndo(),canRedo:this.canRedo(),undoCount:this.getUndoCount(),redoCount:this.getRedoCount()})}catch(t){}}}class be{constructor(t=null){this._set=new Set,t&&this.setSelection(t)}clear(){return this._set.clear(),this}selectSingle(t){return this._set.clear(),Number.isFinite(t)&&this._set.add(t),this}toggle(t){return Number.isFinite(t)?(this._set.has(t)?this._set.delete(t):this._set.add(t),this):this}selectRange(t,e){const i=Math.min(t,e),s=Math.max(t,e);this._set.clear();for(let n=i;n<=s;n++)this._set.add(n);return this}setSelection(t){if(this._set.clear(),!t)return this;const e=t instanceof Set||Array.isArray(t)?t.values():null;if(!e)return this;for(const i of e)Number.isFinite(i)&&this._set.add(i);return this}getSelection(){return new Set(this._set)}has(t){return this._set.has(t)}size(){return this._set.size}}class Se{constructor(t,e={}){this.container=t,this.handlers=e,this.headerEl=null,this.contextToolbarEl=null,this._render(),this._bindEvents()}_render(){const t=document.createElement("div");t.className="gcode-drawer-header",t.innerHTML='\n      <div class="gcode-drawer-title">\n        <strong>G-Code</strong>\n        <span class="gcode-line-count">0 lines</span>\n      </div>\n      <div class="gcode-mode-toggle">\n        <button class="gcode-mode-btn gcode-mode-btn--select active" data-mode="select" title="Select mode - Click lines to select" aria-pressed="true">Select</button>\n        <button class="gcode-mode-btn gcode-mode-btn--edit" data-mode="edit" title="Edit mode - Click text to edit" aria-pressed="false">Edit</button>\n      </div>\n      <div class="gcode-drawer-actions">\n        <button class="gcode-action-btn" data-action="undo" title="Undo (Ctrl+Z)" disabled>‚Ü∂</button>\n        <button class="gcode-action-btn" data-action="redo" title="Redo (Ctrl+Y)" disabled>‚Ü∑</button>\n        <button class="gcode-action-btn" data-action="close" title="Close drawer">√ó</button>\n      </div>\n    ';const e=document.createElement("div");e.className="gcode-context-toolbar",e.style.display="none",e.innerHTML='\n      <div class="gcode-selection-info">\n        <span class="gcode-selection-counter"></span>\n      </div>\n      <div class="gcode-selection-actions">\n        <button class="gcode-toolbar-btn" data-action="set-start" title="Set selected line as new start" disabled>Start Here</button>\n        <button class="gcode-toolbar-btn" data-action="move-up" title="Move selected lines up" disabled>‚Üë</button>\n        <button class="gcode-toolbar-btn" data-action="move-down" title="Move selected lines down" disabled>‚Üì</button>\n        <button class="gcode-toolbar-btn" data-action="insert-points" title="Insert clicked points">+ Points</button>\n        <button class="gcode-toolbar-btn" data-action="delete-selected" title="Delete selected lines">üóë</button>\n      </div>\n    ',this.container.prepend(e),this.container.prepend(t),this.headerEl=t,this.contextToolbarEl=e}_bindEvents(){const t=(t,e,i)=>{const s=this.container.querySelector(t);s&&i&&s.addEventListener(e,i)};t('[data-action="close"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onClose)?void 0:e.call(t)}),t('[data-action="undo"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onUndo)?void 0:e.call(t)}),t('[data-action="redo"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onRedo)?void 0:e.call(t)}),t('[data-action="set-start"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onSetStartHere)?void 0:e.call(t)}),t('[data-action="move-up"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onMoveUp)?void 0:e.call(t)}),t('[data-action="move-down"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onMoveDown)?void 0:e.call(t)}),t('[data-action="insert-points"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onInsertPoints)?void 0:e.call(t)}),t('[data-action="delete-selected"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onDeleteSelected)?void 0:e.call(t)}),t('[data-mode="select"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onModeToggle)?void 0:e.call(t,"select")}),t('[data-mode="edit"]',"click",()=>{var t,e;return null==(e=(t=this.handlers).onModeToggle)?void 0:e.call(t,"edit")})}updateLineCount(t){const e=this.container.querySelector(".gcode-line-count");e&&(e.textContent="".concat(t," line").concat(1!==t?"s":""))}setUndoRedoState(t,e){const i=this.container.querySelector('[data-action="undo"]'),s=this.container.querySelector('[data-action="redo"]');i&&(i.disabled=!(t>0),i.title=t>0?"Undo (Ctrl+Z) - ".concat(t," action").concat(1!==t?"s":""):"Undo (Ctrl+Z)"),s&&(s.disabled=!(e>0),s.title=e>0?"Redo (Ctrl+Y) - ".concat(e," action").concat(1!==e?"s":""):"Redo (Ctrl+Y)")}updateSelectionUI(t,e){const i=this.container.querySelector(".gcode-context-toolbar");i&&(i.style.display=t?"flex":"none");const s=this.container.querySelector(".gcode-selection-counter");s&&t&&(s.textContent="".concat(e," line").concat(1!==e?"s":""," selected"));const n=this.container.querySelector('[data-action="move-up"]'),o=this.container.querySelector('[data-action="move-down"]'),a=this.container.querySelector('[data-action="delete-selected"]'),r=this.container.querySelector('[data-action="insert-points"]'),l=this.container.querySelector('[data-action="set-start"]');n&&(n.disabled=!t),o&&(o.disabled=!t),a&&(a.disabled=!t),r&&(r.disabled=!t),l&&(l.disabled=!t)}updateModeUI(t){const e=this.container.querySelector('[data-mode="select"]'),i=this.container.querySelector('[data-mode="edit"]'),s=this.container.querySelector(".gcode-context-toolbar");e&&i&&(t?(e.classList.remove("active"),i.classList.add("active"),e.setAttribute("aria-pressed","false"),i.setAttribute("aria-pressed","true")):(e.classList.add("active"),i.classList.remove("active"),e.setAttribute("aria-pressed","true"),i.setAttribute("aria-pressed","false"))),s&&t&&(s.style.display="none")}}class _e{constructor(t,{undoSystem:e,editMode:i=!1,onLineEdited:s,onHover:n,onLeave:o,onClick:a,onDeleteLine:r,onBulkDelete:l,getSelection:h,applySelection:c,updateLineCount:d}){this.bodyEl=t,this.undoSystem=e,this.editMode=i,this.onLineEdited=s,this.onHover=n,this.onLeave=o,this.onClick=a,this.onDeleteLine=r,this.onBulkDelete=l,this.getSelection=h,this.applySelection=c,this.updateLineCount=d,this.currentlyEditingLine=null,this.editingOriginalText=new Map}updateSelectionClasses(t){const e=t instanceof Set?t:new Set(t||[]);this.bodyEl.querySelectorAll(".gcode-line").forEach(t=>t.classList.remove("selected")),e.forEach(t=>{const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));e&&e.classList.add("selected")})}setLines(t){var e;this.bodyEl.innerHTML="",(t||[]).forEach((t,e)=>{const i=e+1,s=this._createLineElement(i,t||"");this.bodyEl.appendChild(s)}),null==(e=this.updateLineCount)||e.call(this)}rebindLineEvents(){try{this.bodyEl.querySelectorAll(".gcode-line").forEach(t=>{const e=parseInt(t.dataset.line);if(!isNaN(e)){const i=t.cloneNode(!0);t.parentNode.replaceChild(i,t),this._bindLineEvents(i,e)}})}catch(t){console.error("Error rebinding line events:",t)}}getText(){const t=[];return this.bodyEl.querySelectorAll(".gcode-line").forEach(e=>{t.push(e.querySelector(".gcode-line-text").textContent||"")}),t.join("\n")}setEditMode(t){this.editMode=t,this.bodyEl.querySelectorAll(".gcode-line-text").forEach(e=>{e.contentEditable=t}),this.rebindLineEvents()}createDeleteCommand(t,e){return{type:"delete",execute:()=>{var e;t.forEach(t=>{const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));e&&e.remove()}),this.applySelection(new Set),this._renumberLines(),null==(e=this.updateLineCount)||e.call(this)},undo:()=>{var t;e.forEach(({lineNum:t,text:e,originalIndex:i})=>{const s=this._createLineElement(t,e),n=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));i<n.length?this.bodyEl.insertBefore(s,n[i]):this.bodyEl.appendChild(s)}),this._renumberLines(),null==(t=this.updateLineCount)||t.call(this)}}}createInsertCommand(t,e){const i=t+1;return{type:"insert",startLine:i,lineCount:e.length,execute:()=>{var s;const n=document.createDocumentFragment();e.forEach((t,e)=>{const s=this._createLineElement(i+e,t);n.appendChild(s)});const o=Array.from(this.bodyEl.querySelectorAll(".gcode-line"))[t]||null;o?this.bodyEl.insertBefore(n,o):this.bodyEl.appendChild(n),this._renumberLines(),null==(s=this.updateLineCount)||s.call(this);const a=[];for(let t=0;t<e.length;t++)a.push(i+t);this.applySelection(a)},undo:()=>{var t;for(let s=e.length-1;s>=0;s--){const t=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(i+s,'"]'));t&&t.remove()}this._renumberLines(),null==(t=this.updateLineCount)||t.call(this),this.applySelection(new Set)}}}createMoveCommand(t,e){const i=[...t];return{type:"move",fromIndices:i,direction:e,execute:()=>{this.applySelection(i.map(t=>t+e)),this._moveSelectedLinesInternal(e)},undo:()=>{this.applySelection(i.map(t=>t+e)),this._moveSelectedLinesInternal(-e),this.applySelection(i)}}}createEditCommand(t,e,i){return{type:"edit",lineNum:t,oldText:e,newText:i,execute:()=>{const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));if(!e)return;const s=e.querySelector(".gcode-line-text");s&&(s.textContent=i,this._markLineAsChanged(t))},undo:()=>{const i=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));if(!i)return;const s=i.querySelector(".gcode-line-text");s&&(s.textContent=e,this._markLineAsChanged(t))}}}_renumberLines(){this.bodyEl.querySelectorAll(".gcode-line").forEach((t,e)=>{const i=e+1;t.dataset.line=String(i);const s=t.querySelector(".gcode-line-num");s&&(s.textContent=String(i))})}_moveSelectedLinesInternal(t){var e;const i=Array.from((null==(e=this.getSelection)?void 0:e.call(this))||[]).sort((t,e)=>t-e);if(0!==i.length)try{const e=Array.from(this.bodyEl.querySelectorAll(".gcode-line")).length;if(-1===t&&i[0]<=1)return;if(1===t&&i[i.length-1]>=e)return;const s=i.map(t=>this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'))).filter(Boolean);if(0===s.length)return;const n=document.createDocumentFragment(),o=s.map(t=>({content:t.querySelector(".gcode-line-text").textContent,lineNum:parseInt(t.dataset.line)}));let a;a=-1===t?Math.max(0,i[0]-2):Math.min(e-s.length,i[i.length-1]),s.forEach(t=>t.remove());const r=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));o.forEach(e=>{const i=this._createLineElement(e.lineNum+t,e.content);n.appendChild(i)});const l=r[a];l?this.bodyEl.insertBefore(n,l):this.bodyEl.appendChild(n);const h=i.map(e=>e+t);this.applySelection(h),this._renumberLines()}catch(s){console.error("Error moving selected lines:",s)}}_markLineAsChanged(t){const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));e&&e.classList.add("has-changes")}_setCurrentlyEditing(t){if(null!==this.currentlyEditingLine){const t=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(this.currentlyEditingLine,'"]'));t&&t.classList.remove("editing")}if(this.currentlyEditingLine=t,null!==t){const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));e&&e.classList.add("editing")}}_clearChangeIndicators(){this.bodyEl.querySelectorAll(".gcode-line.has-changes").forEach(t=>t.classList.remove("has-changes"))}_createLineElement(t,e){const i=document.createElement("div");i.className="gcode-line",i.dataset.line=String(t);const s=document.createElement("span");s.className="gcode-line-num",s.textContent=String(t);const n=document.createElement("span");n.className="gcode-line-text",n.contentEditable=this.editMode,n.textContent=e||"";const o=document.createElement("button");return o.className="gcode-del",o.title="Delete line",o.setAttribute("aria-label","Delete line"),o.textContent="√ó",i.appendChild(s),i.appendChild(n),i.appendChild(o),this._bindLineEvents(i,t),i}_bindLineEvents(t,e){try{t.addEventListener("mouseenter",()=>{var t;return null==(t=this.onHover)?void 0:t.call(this,e)}),t.addEventListener("mouseleave",()=>{var t;return null==(t=this.onLeave)?void 0:t.call(this,e)}),t.addEventListener("click",i=>{var s,n;i.target&&(null==(s=i.target.classList)?void 0:s.contains("gcode-del"))||this.editMode||null==(n=this.onClick)||n.call(this,e,t,i)});const i=t.querySelector(".gcode-line-text");i&&this.editMode&&(i.addEventListener("input",t=>{var i;de(t.target),this._markLineAsChanged(e),null==(i=this.onLineEdited)||i.call(this,!1)}),i.addEventListener("focus",t=>{const i=t.target.textContent||"";this.editingOriginalText.set(e,i),this._setCurrentlyEditing(e)}),i.addEventListener("blur",t=>{var i;de(t.target);const s=t.target.textContent||"",n=this.editingOriginalText.get(e);if(void 0!==n&&n!==s){const t=this.createEditCommand(e,n,s);this.undoSystem.push(t)}this.editingOriginalText.delete(e),this._setCurrentlyEditing(null),null==(i=this.onLineEdited)||i.call(this,!0)}),i.addEventListener("paste",t=>{t.preventDefault();const i=ce((t.clipboardData||window.clipboardData).getData("text/plain"));document.execCommand("insertText",!1,i),this._markLineAsChanged(e)}));const s=t.querySelector(".gcode-del");s&&s.addEventListener("click",t=>{var i,s,n;t.stopPropagation();const o=(null==(i=this.getSelection)?void 0:i.call(this))||new Set;o.has(e)&&o.size>1?null==(s=this.onBulkDelete)||s.call(this):null==(n=this.onDeleteLine)||n.call(this,e)})}catch(i){console.error("Error binding events for line",e,":",i)}}}class we{constructor(t=document.body,e={}){this.eventBus=st.getInstance(),this.options={anchor:"right",debug:!1,...e},this.container=document.createElement("div"),this.container.className="gcode-drawer",this.headerEl=null,this.bodyEl=null,this.footerEl=null,this.toolbar=null,this.editor=null,this.lines=[],this.lineIndexToPathIndex=new Map,this.pathIndexToLineIndex=new Map,this.selectedLines=new Set,this.selection=new be,this.lastClickedLine=null,this._debounceTimer=null,this.maxHistorySize=50,this.undoSystem=new fe({max:this.maxHistorySize,onChange:()=>this._updateUndoRedoButtons()}),this.editMode="edit"===localStorage.getItem("gcodeDrawerMode")||!1,this._pendingSelectionRestore=null,t.appendChild(this.container),this._applyAnchorClass(),this._render(),this._bindGlobalEvents()}_applyAnchorClass(){const t="left"===this.options.anchor?"left":"right";this.container.classList.remove("gcode-drawer--left","gcode-drawer--right"),this.container.classList.add("gcode-drawer--".concat(t))}_debug(...t){this.options.debug&&console.log("[GCodeDrawer]",...t)}_render(){var t;this.container.innerHTML='\n      <div class="gcode-drawer-body" tabindex="0"></div>\n      <div class="gcode-drawer-footer">\n        <div class="gcode-help-text">Hover to preview ‚Ä¢ Click to select ‚Ä¢ Ctrl+click for multi-select</div>\n      </div>\n    ',this.toolbar=new Se(this.container,{onClose:()=>this.toggle(!1),onUndo:()=>this._undo(),onRedo:()=>this._redo(),onSetStartHere:()=>this._setSelectedAsStart(),onMoveUp:()=>this._moveSelectedLines(-1),onMoveDown:()=>this._moveSelectedLines(1),onInsertPoints:async()=>{var t;try{const e=this.selectedLines.size>0?Math.min(...this.selectedLines):null,i=null!=e&&null!=(t=this.lineIndexToPathIndex.get(e))?t:null,s=await this._getClickedPointsFromApp();this.eventBus.emit("drawer:insert:points",{atIndex:i,points:s},{skipValidation:!0})}catch(e){console.error("Error inserting points:",e)}},onDeleteSelected:()=>this._onBulkDelete(),onModeToggle:t=>this._onModeToggle(t)}),this.headerEl=this.container.querySelector(".gcode-drawer-header"),this.bodyEl=this.container.querySelector(".gcode-drawer-body"),this.footerEl=this.container.querySelector(".gcode-drawer-footer"),this.bodyEl.addEventListener("keydown",t=>this._onKeyDown(t)),this.editor=new _e(this.bodyEl,{undoSystem:this.undoSystem,editMode:this.editMode,onLineEdited:t=>this._onLineEdited(t),onHover:t=>this._onHover(t),onLeave:t=>this._onLeave(t),onClick:(t,e,i)=>this._onClick(t,e,i),onDeleteLine:t=>this._onDelete(t),onBulkDelete:()=>this._onBulkDelete(),getSelection:()=>this.selectedLines,applySelection:t=>{const e=t instanceof Set?t:new Set(t||[]);this.selection.setSelection(e),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals()},updateLineCount:()=>this._updateLineCount()}),null==(t=this.toolbar)||t.updateModeUI(this.editMode),this._applyModeClass(),this._updateHelpText()}_bindGlobalEvents(){this.eventBus.on("drawer:toggle",()=>this.toggle())}_applyModeClass(){this.container.classList.toggle("gcode-drawer--mode-edit",!!this.editMode),this.container.classList.toggle("gcode-drawer--mode-select",!this.editMode)}_updateHelpText(){const t=this.container.querySelector(".gcode-help-text");t&&(this.editMode?t.textContent="Edit mode: Click text to edit ‚Ä¢ Blur commits change ‚Ä¢ Undo/Redo while typing uses browser shortcuts":t.textContent="Select mode: Hover to preview ‚Ä¢ Click to select ‚Ä¢ Ctrl/Cmd+click for multi-select ‚Ä¢ Shift+click for range")}toggle(t){const e=this.container.classList.contains("open"),i="boolean"==typeof t?t:!e;this.container.classList.toggle("open",i)}setContent({text:t,mapping:e,preserveHistory:i=!1}){this.bodyEl.innerHTML="",this.lines=[],this.lineIndexToPathIndex.clear(),this.pathIndexToLineIndex.clear(),this.selection.clear(),this.selectedLines=this.selection.getSelection(),this.lastClickedLine=null,i?console.log("GCodeDrawer: Preserving undo/redo history, stack sizes:",this.undoSystem.getUndoCount(),this.undoSystem.getRedoCount()):(console.log("GCodeDrawer: Clearing undo/redo history"),this.undoSystem.clear());const s=(t||"").split(/\r?\n/);if(this.editor.setLines(s),this.lines=s.map((t,e)=>({num:e+1,text:t})),null==e||e.forEach(t=>{"number"==typeof(null==t?void 0:t.line)&&"number"==typeof(null==t?void 0:t.index)&&(this.lineIndexToPathIndex.has(t.line)||this.lineIndexToPathIndex.set(t.line,t.index),this.pathIndexToLineIndex.has(t.index)||this.pathIndexToLineIndex.set(t.index,t.line))}),this._updateLineCount(),this._updateUndoRedoButtons(),this._pendingSelectionRestore&&(this._pendingSelectionRestore.size||this._pendingSelectionRestore.length)){const t=Array.from(this._pendingSelectionRestore);this._pendingSelectionRestore=null,this._restoreSelection(t)}}_onHover(t){const e=this.lineIndexToPathIndex.get(t);null!=e&&this.eventBus.emit("drawer:line:hover",{index:e},{skipValidation:!0})}_onLeave(t){this.eventBus.emit("drawer:line:leave",{},{skipValidation:!0})}_onClick(t,e,i){i.shiftKey&&null!=this.lastClickedLine?this._selectRange(Math.min(this.lastClickedLine,t),Math.max(this.lastClickedLine,t)):i.ctrlKey||i.metaKey?this._toggleSelection(t,e):this._selectSingle(t,e),this.lastClickedLine=t,this._updateSelectionVisuals();const s=Math.min(...this.selectedLines),n=this.lineIndexToPathIndex.get(s);null!=n&&this.eventBus.emit("drawer:line:click",{index:n},{skipValidation:!0})}_selectSingle(t,e){this.selection.selectSingle(t),this.selectedLines=this.selection.getSelection()}_toggleSelection(t,e){this.selection.setSelection(this.selectedLines).toggle(t),this.selectedLines=this.selection.getSelection()}_selectRange(t,e){this.selection.selectRange(t,e),this.selectedLines=this.selection.getSelection()}_updateSelectionVisuals(){this.editor&&this.editor.updateSelectionClasses(this.selectedLines);const t=this.selectedLines.size,e=t>0;this.toolbar&&this.toolbar.updateSelectionUI(e,t)}_restoreSelection(t){console.log("GCodeDrawer: Restoring selection to lines:",t);const e=[];t.forEach(t=>{this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'))&&e.push(t)}),this.selection.setSelection(e),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals()}_updateLineCount(){const t=this.bodyEl?this.bodyEl.querySelectorAll(".gcode-line").length:this.lines.length;this.toolbar&&this.toolbar.updateLineCount(t)}_undo(){if(!this.undoSystem.canUndo())return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.undoSystem.undo();if(t)if(this._debug("Executed undo for command:",t.type),"move"===t.type){const t=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(t)},0)}else this._pendingSelectionRestore=new Set(this.selectedLines),this._emitContentChanged(this.getText())}_redo(){if(!this.undoSystem.canRedo())return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.undoSystem.redo();if(t)if(this._debug("Executed redo for command:",t.type),"move"===t.type){const t=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(t)},0)}else this._pendingSelectionRestore=new Set(this.selectedLines),this._emitContentChanged(this.getText())}_updateUndoRedoButtons(){const t=this.undoSystem.getUndoCount(),e=this.undoSystem.getRedoCount();this._debug("Updating undo/redo buttons. Undo stack:",t,"Redo stack:",e),this.toolbar&&this.toolbar.setUndoRedoState(t,e)}insertPointsAt(t,e){if(!Array.isArray(e)||0===e.length)return;this.getText();let i=null;"number"==typeof t&&this.pathIndexToLineIndex.has(t)&&(i=this.pathIndexToLineIndex.get(t)),null==i&&(i=this.selectedLines.size>0?Math.min(...this.selectedLines):1);const s=e.flatMap((t,e)=>["; inserted G0 P".concat(e+1),"G0 X".concat(t.x.toFixed(3)," Y").concat(t.y.toFixed(3))]),n=this.editor.createInsertCommand(i,s);this.undoSystem.push(n),n.execute();const o=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(o)},0)}getText(){return this.editor?this.editor.getText():""}async _getClickedPointsFromApp(){return new Promise(t=>{const e=({points:i})=>{this.eventBus.off(D,e),t(i||[])};this.eventBus.on(D,e),this.eventBus.emit(M,{},{skipValidation:!0}),setTimeout(()=>{this.eventBus.off(D,e),t([])},1e3)})}_onLineEdited(t=!1){this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const e=()=>this._emitContentChanged(this.getText());t?(this._pendingSelectionRestore=new Set(this.selectedLines),e()):(this._pendingSelectionRestore=new Set(this.selectedLines),this._debounceTimer=setTimeout(e,3e3))}_onDelete(t){const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]'));if(!e)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const i=Array.from(this.bodyEl.querySelectorAll(".gcode-line")),s=[{lineNum:t,text:e.querySelector(".gcode-line-text").textContent,originalIndex:i.indexOf(e)}],n=this.editor.createDeleteCommand([t],s);this.undoSystem.push(n),n.execute(),this.lines=this.lines.filter(e=>e.num!==t);const o=new Set(this.selectedLines);o.delete(t),this.selection.setSelection(o),this.selectedLines=this.selection.getSelection(),this.lastClickedLine===t&&(this.lastClickedLine=null),this._emitContentChanged(this.getText())}_onKeyDown(t){var e,i;if(!t.target||!t.target.isContentEditable&&!(null==(i=(e=t.target).closest)?void 0:i.call(e,".gcode-line-text"))){if((t.ctrlKey||t.metaKey)&&!t.shiftKey)switch(t.key.toLowerCase()){case"z":return t.preventDefault(),void this._undo();case"y":return t.preventDefault(),void this._redo()}if((t.ctrlKey||t.metaKey)&&t.shiftKey&&"z"===t.key.toLowerCase())return t.preventDefault(),void this._redo();"Delete"!==t.key&&"Backspace"!==t.key||this.selectedLines.size>0&&(t.preventDefault(),this._onBulkDelete()),"Escape"===t.key&&this.selectedLines.size>0&&(this.selection.clear(),this.selectedLines=this.selection.getSelection(),this._updateSelectionVisuals())}}_onBulkDelete(){if(0===this.selectedLines.size)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const t=this.selectedLines.size;if(t>3){if(!confirm("Delete ".concat(t," selected lines? Use Ctrl+Z to undo if needed.")))return}const e=Array.from(this.selectedLines).sort((t,e)=>t-e),i=e.map(t=>{const e=this.bodyEl.querySelector('.gcode-line[data-line="'.concat(t,'"]')),i=Array.from(this.bodyEl.querySelectorAll(".gcode-line"));return{lineNum:t,text:e?e.querySelector(".gcode-line-text").textContent:"",originalIndex:i.indexOf(e)}}),s=this.editor.createDeleteCommand(e,i);this.undoSystem.push(s),s.execute(),this._emitContentChanged(this.getText())}_moveSelectedLines(t){if(0===this.selectedLines.size)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const e=Array.from(this.selectedLines).sort((t,e)=>t-e),i=this.editor.createMoveCommand(e,t);this.undoSystem.push(i),this.editor._moveSelectedLinesInternal(t);const s=Array.from(this.selectedLines);this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection(s)},0)}_setSelectedAsStart(){var t,e;if(1!==this.selectedLines.size)return void this.eventBus.emit(G,{message:"Select exactly one motion line in the body to set as start.",type:"warning"});if(this.editMode)return;this._debounceTimer&&(clearTimeout(this._debounceTimer),this._debounceTimer=null);const i=Math.min(...this.selectedLines),s=t=>{const e=((t||"").replace(/[;(].*$/g,"").trim().replace(/^N\d+\s+/i,"")||"").toUpperCase().replace(/\bG0+([0-3])(?!\d)/g,"G$1");return/^(G0|G1|G2|G3)\b/.test(e)};let n=-1;for(let p=0;p<this.lines.length;p++)if(s((null==(t=this.lines[p])?void 0:t.text)||"")){n=p;break}const o=i-1,a=(null==(e=this.lines[o])?void 0:e.text)||"";if(!(n>=0&&o>=n&&s(a)))return void this.eventBus.emit(G,{message:"Invalid selection: choose a motion line (G0/G1/G2/G3) within the body.",type:"warning"});const r=this.getText(),{text:l,newStartLine:h}=ye(r,i,{ensureClosure:!0});if(l===r)return;const c=r.split(/\r?\n/),d=l.split(/\r?\n/),u={type:"replace",execute:()=>{this.editor.setLines(d),this._updateLineCount()},undo:()=>{this.editor.setLines(c),this._updateLineCount()}};this.undoSystem.push(u),u.execute(),this._emitContentChanged(this.getText()),setTimeout(()=>{this._restoreSelection([h])},0)}_onModeToggle(t){var e,i,s;if(this.editMode="edit"===t,localStorage.setItem("gcodeDrawerMode",t),null==(e=this.editor)||e.setEditMode(this.editMode),null==(i=this.toolbar)||i.updateModeUI(this.editMode),!this.editMode){const t=this.selectedLines.size;null==(s=this.toolbar)||s.updateSelectionUI(t>0,t)}this._applyModeClass(),this._updateHelpText(),this._debug("Mode toggled to:",t,"editMode:",this.editMode)}_emitContentChanged(t){const e=ce(t);this.eventBus.emit("drawer:content:changed",{text:e},{skipValidation:!0})}}class Ee{constructor(t,e){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas element is required");if(!e)throw new Error("Viewport instance is required");this.canvas=t,this.viewport=e,this.eventBus=st.getInstance(),this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.lastWheelTime=0,this.wheelThrottleDelay=16,this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this._handleClick=this._handleClick.bind(this),this._handleWheel=this._handleWheel.bind(this),this._handleContextMenu=this._handleContextMenu.bind(this),this._handleMouseEnter=this._handleMouseEnter.bind(this),this._handleMouseLeave=this._handleMouseLeave.bind(this)}init(){this.isInitialized?console.warn("MouseEventHandler already initialized"):(this.canvas.addEventListener("mousemove",this._handleMouseMove),this.canvas.addEventListener("mousedown",this._handleMouseDown),this.canvas.addEventListener("mouseup",this._handleMouseUp),this.canvas.addEventListener("click",this._handleClick),this.canvas.addEventListener("wheel",this._handleWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",this._handleContextMenu),this.canvas.addEventListener("mouseenter",this._handleMouseEnter),this.canvas.addEventListener("mouseleave",this._handleMouseLeave),this.canvas.style.cursor=yt,this.isInitialized=!0)}_handleMouseMove(t){if(this.isDestroyed)return;const e=ot.createMouseEventData(t,this.viewport);this.isDragging&&(this.viewport.updateDrag(e.screenX,e.screenY),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height})),this.eventBus.emit(v,e)}_handleMouseDown(t){if(this.isDestroyed)return;const e=ot.createMouseEventData(t,this.viewport);(1===t.button||0===t.button&&t.shiftKey)&&(this.isDragging=!0,this.dragStartX=e.screenX,this.dragStartY=e.screenY,this.viewport.startDrag(e.screenX,e.screenY),t.preventDefault()),this.eventBus.emit(f,e)}_handleMouseUp(t){if(this.isDestroyed)return;const e=ot.createMouseEventData(t,this.viewport);this.isDragging&&(this.isDragging=!1,this.viewport.endDrag(),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height})),this.eventBus.emit(b,e)}_handleClick(t){if(this.isDestroyed)return;if(t.shiftKey)return void console.log("Click ignored - shift key held for panning");const e=ot.createMouseEventData(t,this.viewport),i=this.viewport.debugCoordinateConversion(t);console.log("Click handler - mouse data:",e),console.log("Coordinate conversion accuracy:",i),this.viewport.isValidCoordinate(e.worldX)&&this.viewport.isValidCoordinate(e.worldY)?(console.log("Emitting MOUSE_CLICK event with valid coordinates"),this.eventBus.emit(y,e)):console.log("Click ignored - invalid coordinates:",e.worldX,e.worldY)}_handleWheel(t){if(this.isDestroyed)return;t.preventDefault();const e=Date.now();if(e-this.lastWheelTime<this.wheelThrottleDelay)return;this.lastWheelTime=e;const i=ot.createMouseEventData(t,this.viewport),s=t.deltaY>0?-1:1,n=this.canvas.width/2,o=this.canvas.height/2;this.viewport.zoomAtPoint(n,o,s),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:this.canvas.width,canvasHeight:this.canvas.height}),this.eventBus.emit(S,{...i,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ||0,deltaMode:t.deltaMode})}_handleContextMenu(t){t.preventDefault()}_handleMouseEnter(t){if(this.isDestroyed)return;const e=ot.createMouseEventData(t,this.viewport);this.eventBus.emit(_,e)}_handleMouseLeave(t){if(this.isDestroyed)return;const e=ot.createMouseEventData(t,this.viewport);this.eventBus.emit(w,e),this.isDragging&&(this.isDragging=!1,this.viewport.endDrag())}getState(){return{isDragging:this.isDragging,dragStartX:this.dragStartX,dragStartY:this.dragStartY,isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}setEnabled(t){this.canvas.style.pointerEvents=t?"auto":"none"}setCursor(t){this.canvas.style.cursor=t}destroy(){this.isDestroyed||(this.canvas.removeEventListener("mousemove",this._handleMouseMove),this.canvas.removeEventListener("mousedown",this._handleMouseDown),this.canvas.removeEventListener("mouseup",this._handleMouseUp),this.canvas.removeEventListener("click",this._handleClick),this.canvas.removeEventListener("wheel",this._handleWheel),this.canvas.removeEventListener("contextmenu",this._handleContextMenu),this.canvas.removeEventListener("mouseenter",this._handleMouseEnter),this.canvas.removeEventListener("mouseleave",this._handleMouseLeave),this.isDragging=!1,this.canvas.style.cursor=yt,this.isDestroyed=!0)}}class Ce{constructor(t=document,e=null){this.targetElement=t,this.viewport=e,this.eventBus=st.getInstance(),this.shortcuts=new Map,this.isInitialized=!1,this.isDestroyed=!1,this.pressedKeys=new Set,this.lastKeyTime=0,this.keyThrottleDelay=50,this._bindMethods(),this._registerDefaultShortcuts()}_bindMethods(){this._handleKeyDown=this._handleKeyDown.bind(this),this._handleKeyUp=this._handleKeyUp.bind(this),this._handleKeyPress=this._handleKeyPress.bind(this)}init(){this.isInitialized?console.warn("KeyboardHandler already initialized"):(this.targetElement.addEventListener("keydown",this._handleKeyDown),this.targetElement.addEventListener("keyup",this._handleKeyUp),this.targetElement.addEventListener("keypress",this._handleKeyPress),this.isInitialized=!0)}_registerDefaultShortcuts(){this.registerShortcut("KeyG",{description:"Toggle grid visibility",action:()=>{this.eventBus.emit(O)}}),this.registerShortcut("Equal",{description:"Zoom in",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.zoomIn(),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("Minus",{description:"Zoom out",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.zoomOut(),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("Digit0",{description:"Reset zoom to 100%",requiresCtrl:!0,action:()=>{this.viewport&&(this.viewport.setZoom(ht),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("KeyF",{description:"Fit to screen",action:()=>{this.eventBus.emit(m)}}),this.registerShortcut("KeyR",{description:"Reset viewport",action:()=>{this.viewport&&(this.viewport.reset(),this.eventBus.emit(g,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("KeyC",{description:"Clear all points",requiresCtrl:!0,action:()=>{this.eventBus.emit(T)}}),this.registerShortcut("ArrowLeft",{description:"Pan left",action:()=>{this.viewport&&(this.viewport.pan(mt,0),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowRight",{description:"Pan right",action:()=>{this.viewport&&(this.viewport.pan(-50,0),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowUp",{description:"Pan up",action:()=>{this.viewport&&(this.viewport.pan(0,-50),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}}),this.registerShortcut("ArrowDown",{description:"Pan down",action:()=>{this.viewport&&(this.viewport.pan(0,mt),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:this.viewport.canvas.width,canvasHeight:this.viewport.canvas.height}))}})}_handleKeyDown(t){if(this.isDestroyed)return;if(this._isInputFocused())return;const e=ot.createKeyboardEventData(t);this.pressedKeys.add(t.code);const i=this._findMatchingShortcut(t);if(i){t.preventDefault();const n=Date.now();if(n-this.lastKeyTime<this.keyThrottleDelay)return;this.lastKeyTime=n;try{i.action(),this.eventBus.emit(F,{...e,shortcut:i.description})}catch(s){console.error("Error executing keyboard shortcut:",s)}}this.eventBus.emit(H,e)}_handleKeyUp(t){if(this.isDestroyed)return;const e=ot.createKeyboardEventData(t);this.pressedKeys.delete(t.code),this.eventBus.emit(B,e)}_handleKeyPress(t){if(this.isDestroyed)return;if(this._isInputFocused())return;const e=ot.createKeyboardEventData(t);console.debug("KeyPress event:",e)}_isInputFocused(){const t=document.activeElement;return t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||"true"===t.contentEditable)}_findMatchingShortcut(t){for(const[e,i]of this.shortcuts)if(t.code===e){if(i.requiresCtrl&&!t.ctrlKey)continue;if(i.requiresShift&&!t.shiftKey)continue;if(i.requiresAlt&&!t.altKey)continue;if(i.requiresMeta&&!t.metaKey)continue;if(i.forbidCtrl&&t.ctrlKey)continue;if(i.forbidShift&&t.shiftKey)continue;if(i.forbidAlt&&t.altKey)continue;if(i.forbidMeta&&t.metaKey)continue;return i}return null}registerShortcut(t,e){if("string"!=typeof t)throw new Error("Key code must be a string");if(!e||"function"!=typeof e.action)throw new Error("Shortcut must have an action function");this.shortcuts.set(t,{description:e.description||"Custom shortcut",action:e.action,requiresCtrl:e.requiresCtrl||!1,requiresShift:e.requiresShift||!1,requiresAlt:e.requiresAlt||!1,requiresMeta:e.requiresMeta||!1,forbidCtrl:e.forbidCtrl||!1,forbidShift:e.forbidShift||!1,forbidAlt:e.forbidAlt||!1,forbidMeta:e.forbidMeta||!1})}unregisterShortcut(t){this.shortcuts.delete(t)}getShortcuts(){return new Map(this.shortcuts)}getPressedKeys(){return new Set(this.pressedKeys)}isKeyPressed(t){return this.pressedKeys.has(t)}clearPressedKeys(){this.pressedKeys.clear()}getHelpText(){return Array.from(this.shortcuts.entries()).map(([t,e])=>{let i=t.replace(/^Key/,"").replace(/^Digit/,"");const s=[];return e.requiresCtrl&&s.push("Ctrl"),e.requiresShift&&s.push("Shift"),e.requiresAlt&&s.push("Alt"),e.requiresMeta&&s.push("Meta"),s.length>0&&(i=s.join("+")+"+"+i),"".concat(i,": ").concat(e.description)}).join("\n")}destroy(){this.isDestroyed||(this.targetElement.removeEventListener("keydown",this._handleKeyDown),this.targetElement.removeEventListener("keyup",this._handleKeyUp),this.targetElement.removeEventListener("keypress",this._handleKeyPress),this.shortcuts.clear(),this.pressedKeys.clear(),this.isDestroyed=!0)}}class xe{constructor(t={}){this.config={tapThreshold:10,tapTimeout:300,doubleTapTimeout:500,longPressTimeout:800,pinchThreshold:50,preventContextMenu:!0,...t},this.touches=new Map,this.lastTouchTime=0,this.touchThrottleDelay=16,this.gestureState={type:null,startTime:0,lastDistance:0,lastCenter:{x:0,y:0},tapCount:0,tapTimeout:null}}detectGestureStart(t){const e=t.length;return this.updateTouchTracking(t,"start"),1===e?this._handleSingleTouchStart(t[0]):2===e?this._handlePinchStart(t[0],t[1]):(this.resetGestureState(),{type:"unknown",touchCount:e})}detectGestureMove(t){const e=t.length;return Date.now()-this.lastTouchTime<this.touchThrottleDelay?{type:this.gestureState.type,throttled:!0}:(this.updateTouchTracking(t,"move"),1===e?this._handleSingleTouchMove(t[0]):2===e?this._handlePinchMove(t[0],t[1]):{type:this.gestureState.type,touchCount:e})}detectGestureEnd(t,e){return t.forEach(t=>{this.touches.delete(t.identifier)}),0===e.length?this._handleGestureEnd(t[0]):1===e.length&&"zoom"===this.gestureState.type?this._handleSingleTouchStart(e[0]):{type:this.gestureState.type,remainingTouches:e.length}}updateTouchTracking(t,e="move"){const i=Date.now();t.forEach(t=>{if("start"===e)this.touches.set(t.identifier,{id:t.identifier,startX:t.clientX,startY:t.clientY,currentX:t.clientX,currentY:t.clientY,startTime:i});else if("move"===e){const e=this.touches.get(t.identifier);e&&(e.currentX=t.clientX,e.currentY=t.clientY)}}),this.lastTouchTime=i}_handleSingleTouchStart(t){const e=Date.now();return e-this.lastTouchTime<this.config.doubleTapTimeout?this.gestureState.tapCount++:this.gestureState.tapCount=1,this.gestureState.type="potential-tap",this.gestureState.startTime=e,this.gestureState.lastCenter={x:t.clientX,y:t.clientY},this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),{type:"potential-tap",tapCount:this.gestureState.tapCount,center:this.gestureState.lastCenter}}_handlePinchStart(t,e){const i=this.calculateDistance(t,e),s=this.calculateCenter(t,e);return this.gestureState.type="zoom",this.gestureState.startTime=Date.now(),this.gestureState.lastDistance=i,this.gestureState.lastCenter=s,this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),{type:"zoom",distance:i,center:s,startDistance:i}}_handleSingleTouchMove(t){const e=this.touches.get(t.identifier);if(!e)return{type:"unknown",error:"Touch not tracked"};const i=t.clientX-e.startX,s=t.clientY-e.startY,n=Math.sqrt(i*i+s*s);if(n>this.config.tapThreshold&&("potential-tap"===this.gestureState.type&&(this.gestureState.type="pan",this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null)),"pan"===this.gestureState.type)){const e=t.clientX-this.gestureState.lastCenter.x,i=t.clientY-this.gestureState.lastCenter.y;return this.gestureState.lastCenter={x:t.clientX,y:t.clientY},{type:"pan",deltaX:e,deltaY:i,totalDistance:n}}return{type:this.gestureState.type,distance:n}}_handlePinchMove(t,e){const i=this.calculateDistance(t,e),s=this.calculateCenter(t,e);if("zoom"===this.gestureState.type){const t=i-this.gestureState.lastDistance;if(Math.abs(t)>this.config.pinchThreshold)return this.gestureState.lastDistance=i,{type:"zoom",distance:i,center:s,distanceDelta:t,zoomDirection:t>0?"out":"in"}}return{type:"zoom",distance:i,center:s,distanceDelta:0}}_handleGestureEnd(t){const e=this.gestureState.type;let i={type:e,completed:!0};return"potential-tap"===e?i={type:"tap",tapCount:this.gestureState.tapCount,touch:t,completed:!0}:"pan"===e?i={type:"pan-end",completed:!0}:"zoom"===e&&(i={type:"zoom-end",completed:!0}),this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),this.resetGestureState(),i}calculateDistance(t,e){const i=t.clientX-e.clientX,s=t.clientY-e.clientY;return Math.sqrt(i*i+s*s)}calculateCenter(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}resetGestureState(){this.gestureState.type=null,this.gestureState.startTime=0,this.gestureState.lastDistance=0,this.gestureState.lastCenter={x:0,y:0}}handleTouchCancel(){this.touches.clear(),this.gestureState.tapTimeout&&(clearTimeout(this.gestureState.tapTimeout),this.gestureState.tapTimeout=null),this.resetGestureState()}getGestureState(){return{...this.gestureState}}updateConfig(t){this.config={...this.config,...t}}getTouchState(){return{touchCount:this.touches.size,lastTouchTime:this.lastTouchTime,gestureType:this.gestureState.type,tapCount:this.gestureState.tapCount}}}class Te{constructor(t,e){if(!t)throw new Error("Viewport instance is required");if(!e)throw new Error("EventBus instance is required");this.viewport=t,this.eventBus=e}handleTap(t,e=1){1===e?this.eventBus.emit(y,t):2===e&&this.eventBus.emit(m,{gesture:"double-tap",touch:t})}handleLongPress(t){this.eventBus.emit(y,{...t,button:2,gesture:"long-press"})}handlePan(t,e){(t.deltaX||t.deltaY)&&(this.viewport.pan(t.deltaX,-t.deltaY),this.eventBus.emit(p,{...this.viewport.getState(),canvasWidth:e.width,canvasHeight:e.height,gesture:"touch-pan"}))}handleZoom(t,e){if(!t.distanceDelta||0===t.distanceDelta)return;const i=e.getBoundingClientRect(),s=t.center.x-i.left,n=t.center.y-i.top,o=t.distanceDelta>0?1:-1;this.viewport.zoomAtPoint(s,n,o),this.eventBus.emit(u,{...this.viewport.getState(),canvasWidth:e.width,canvasHeight:e.height,gesture:"touch-zoom"})}createTouchEventData(t){const e={clientX:t.clientX,clientY:t.clientY,button:0,ctrlKey:!1,shiftKey:!1,altKey:!1,target:t.target,type:"touch",preventDefault:()=>{},stopPropagation:()=>{}};return ot.createMouseEventData(e,this.viewport)}handlePanStart(t){return{type:"pan-start",startCenter:t.center}}handlePanEnd(t){return{type:"pan-end",completed:!0}}handleZoomStart(t){return{type:"zoom-start",startDistance:t.distance,startCenter:t.center}}handleZoomEnd(t){return{type:"zoom-end",completed:!0}}processGesture(t,e,i=null){switch(t.type){case"tap":const s=this.createTouchEventData(i||t.touch);this.handleTap(s,t.tapCount);break;case"long-press":const n=this.createTouchEventData(i);this.handleLongPress(n);break;case"pan":this.handlePan(t,e);break;case"pan-start":return this.handlePanStart(t);case"pan-end":return this.handlePanEnd(t);case"zoom":this.handleZoom(t,e);break;case"zoom-start":return this.handleZoomStart(t);case"zoom-end":return this.handleZoomEnd(t)}return{processed:!0,type:t.type}}getState(){return{viewport:this.viewport.getState(),hasEventBus:!!this.eventBus,hasViewport:!!this.viewport}}}class Le{constructor(t,e){if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas element is required");if(!e)throw new Error("Viewport instance is required");this.canvas=t,this.viewport=e,this.eventBus=st.getInstance(),this.config={tapThreshold:10,tapTimeout:300,doubleTapTimeout:500,longPressTimeout:800,pinchThreshold:50,preventContextMenu:!0},this.touchGestures=new xe(this.config),this.touchInteractions=new Te(this.viewport,this.eventBus),this._currentLongPressTimeout=null,this._bindMethods(),this.isInitialized=!1,this.isDestroyed=!1}_bindMethods(){this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),this._handleTouchCancel=this._handleTouchCancel.bind(this),this._handleContextMenu=this._handleContextMenu.bind(this)}init(){this.isInitialized?console.warn("TouchEventHandler already initialized"):(this.canvas.addEventListener("touchstart",this._handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this._handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this._handleTouchEnd,{passive:!1}),this.canvas.addEventListener("touchcancel",this._handleTouchCancel,{passive:!1}),this.config.preventContextMenu&&this.canvas.addEventListener("contextmenu",this._handleContextMenu),this.isInitialized=!0)}_handleTouchStart(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.touches),i=this.touchGestures.detectGestureStart(e);this._setupLongPressDetection(i,e[0])}_handleTouchMove(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.touches),i=this.touchGestures.detectGestureMove(e);!i.throttled&&i.type&&"unknown"!==i.type&&this.touchInteractions.processGesture(i,this.canvas)}_handleTouchEnd(t){if(this.isDestroyed)return;t.preventDefault();const e=Array.from(t.changedTouches),i=Array.from(t.touches),s=this.touchGestures.detectGestureEnd(e,i);s.completed&&this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),(s.completed||"tap"===s.type)&&this.touchInteractions.processGesture(s,this.canvas,e[0])}_setupLongPressDetection(t,e){"potential-tap"===t.type&&(this._currentLongPressTimeout&&clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=setTimeout(()=>{if("potential-tap"===this.touchGestures.getGestureState().type){const t=this.touchInteractions.createTouchEventData(e);this.touchInteractions.handleLongPress(t)}this._currentLongPressTimeout=null},this.config.longPressTimeout))}_handleTouchCancel(t){this.isDestroyed||(this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),this.touchGestures.handleTouchCancel())}_handleContextMenu(t){t.preventDefault()}getState(){return{...this.touchGestures.getTouchState(),...this.touchInteractions.getState(),isInitialized:this.isInitialized,isDestroyed:this.isDestroyed}}setEnabled(t){this.canvas.style.touchAction=t?"none":"auto"}updateConfig(t){this.config={...this.config,...t},this.touchGestures.updateConfig(t)}destroy(){this.isDestroyed||(this.canvas.removeEventListener("touchstart",this._handleTouchStart),this.canvas.removeEventListener("touchmove",this._handleTouchMove),this.canvas.removeEventListener("touchend",this._handleTouchEnd),this.canvas.removeEventListener("touchcancel",this._handleTouchCancel),this.config.preventContextMenu&&this.canvas.removeEventListener("contextmenu",this._handleContextMenu),this._currentLongPressTimeout&&(clearTimeout(this._currentLongPressTimeout),this._currentLongPressTimeout=null),this.touchGestures.handleTouchCancel(),this.isDestroyed=!0)}}class Ie{constructor(t=document){this.rootElement=t,this.eventBus=st.getInstance(),this.delegations=new Map,this.isInitialized=!1,this.isDestroyed=!1,this.dragOverlay=null,this.dragOverlayTimer=null,this._bindMethods()}_bindMethods(){this._handleDelegatedEvent=this._handleDelegatedEvent.bind(this)}init(){this.isInitialized?console.warn("EventDelegator already initialized"):(this._registerDefaultDelegations(),this._addGlobalDragHandlers(),this.isInitialized=!0)}_registerDefaultDelegations(){this.addDelegation("click","button",(t,e)=>{var i;const s=e.dataset.action||(null==(i=e.onclick)?void 0:i.toString())||"button-click";this.eventBus.emit(k,{action:s,element:e,event:t})}),this.addDelegation("click",".delete-point-btn",(t,e)=>{const i=e.dataset.pointId;this.eventBus.emit(C,{id:i,element:e,event:t})}),this.addDelegation("click",".zoom-in",(t,e)=>{this.eventBus.emit(u,{action:"zoom-in",element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".zoom-out",(t,e)=>{this.eventBus.emit(u,{action:"zoom-out",element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".fit-to-screen",(t,e)=>{this.eventBus.emit(m,{element:e,event:t})}),this.addDelegation("click",".clear-points",(t,e)=>{this.eventBus.emit(T,{element:e,event:t})}),this.addDelegation("click",".export-points",(t,e)=>{this.eventBus.emit(N,{type:"points",element:e,event:t})}),this.addDelegation("click",".grid-toggle",(t,e)=>{this.eventBus.emit(P,{element:e,event:t},{skipValidation:!0})}),this.addDelegation("click",".theme-toggle",(t,e)=>{this.eventBus.emit(z,{element:e,event:t})}),this.addDelegation("click",".sidebar-toggle",(t,e)=>{this.eventBus.emit(A,{element:e,event:t})}),this.addDelegation("click","[data-nav]",(t,e)=>{const i=e.dataset.nav;this.eventBus.emit(k,{action:"navigate",target:i,element:e,event:t})}),this.addDelegation("submit","form",(t,e)=>{t.preventDefault();const i=new FormData(e),n=Object.fromEntries(i.entries());this.eventBus.emit(s,{type:"form-submit",data:n,element:e,event:t})}),this.addDelegation("dragover",".file-drop-area, canvas",(t,e)=>{t.preventDefault(),t.dataTransfer.dropEffect="copy",e.classList.add("drag-over"),this._showDragOverlay()}),this.addDelegation("dragleave",".file-drop-area, canvas",(t,e)=>{t.preventDefault(),e.contains(t.relatedTarget)||e.classList.remove("drag-over")}),this.addDelegation("drop",".file-drop-area, canvas",(t,e)=>{t.preventDefault(),e.classList.remove("drag-over"),this._hideDragOverlay();const i=Array.from(t.dataTransfer.files||[]);if(0===i.length)return void this.eventBus.emit(G,{type:"warning",message:"No files were dropped"});i.length>1&&this.eventBus.emit(G,{type:"warning",message:"Multiple files dropped. Using first file: ".concat(i[0].name)});const n=i[0];this.eventBus.emit(s,{name:n.name,size:n.size,type:n.type,file:n,element:e,event:t,isDrop:!0,source:"drag-drop"})})}addDelegation(t,e,i,s={}){if("string"!=typeof t)throw new Error("Event type must be a string");if("string"!=typeof e)throw new Error("Selector must be a string");if("function"!=typeof i)throw new Error("Handler must be a function");const n="".concat(t,":").concat(e);this.delegations.has(n)||this.delegations.set(n,{eventType:t,selector:e,handlers:[],listener:null});const o=this.delegations.get(n);return o.handlers.push(i),1===o.handlers.length&&(o.listener=t=>{this._handleDelegatedEvent(t,e,n)},this.rootElement.addEventListener(t,o.listener,{capture:!0,...s})),()=>{this.removeDelegation(t,e,i)}}removeDelegation(t,e,i=null){const s="".concat(t,":").concat(e),n=this.delegations.get(s);n&&(n.handlers=i?n.handlers.filter(t=>t!==i):[],0===n.handlers.length&&(n.listener&&this.rootElement.removeEventListener(t,n.listener,!0),this.delegations.delete(s)))}_handleDelegatedEvent(t,e,i){if(this.isDestroyed)return;const s=t.target.closest(e);if(!s)return;const n=this.delegations.get(i);n&&n.handlers.forEach(e=>{try{e(t,s)}catch(n){console.error("Error in delegated event handler for ".concat(i,":"),n)}})}getDelegations(){return new Map(this.delegations)}getStats(){const t={totalDelegations:this.delegations.size,totalHandlers:0,eventTypes:new Set,selectors:new Set};return this.delegations.forEach((e,i)=>{t.totalHandlers+=e.handlers.length,t.eventTypes.add(e.eventType),t.selectors.add(e.selector)}),{...t,eventTypes:Array.from(t.eventTypes),selectors:Array.from(t.selectors)}}clearDelegations(){this.delegations.forEach((t,e)=>{const[i]=e.split(":");t.listener&&this.rootElement.removeEventListener(i,t.listener,!0)}),this.delegations.clear()}_addGlobalDragHandlers(){document.addEventListener("dragleave",t=>{0===t.clientX&&0===t.clientY&&this._hideDragOverlay()}),window.addEventListener("blur",()=>{this._hideDragOverlay()})}_showDragOverlay(){this.dragOverlayTimer&&(clearTimeout(this.dragOverlayTimer),this.dragOverlayTimer=null),this.dragOverlay||(this.dragOverlay=document.createElement("div"),this.dragOverlay.className="drag-overlay",this.dragOverlay.innerHTML='\n        <div class="drag-overlay-content">\n          <div class="drag-overlay-icon">üìÅ</div>\n          <div class="drag-overlay-text">Drop G-code file here</div>\n        </div>\n      ',document.body.appendChild(this.dragOverlay)),this.dragOverlay.style.display="flex",requestAnimationFrame(()=>{this.dragOverlay.classList.add("visible")})}_hideDragOverlay(){this.dragOverlay&&(this.dragOverlay.classList.remove("visible"),this.dragOverlayTimer=setTimeout(()=>{this.dragOverlay&&(this.dragOverlay.style.display="none")},300))}destroy(){this.isDestroyed||(this.clearDelegations(),this.dragOverlay&&(this.dragOverlay.remove(),this.dragOverlay=null),this.dragOverlayTimer&&(clearTimeout(this.dragOverlayTimer),this.dragOverlayTimer=null),this.isDestroyed=!0)}}class Me{constructor(t,e,i={}){this.canvas=t,this.viewport=e,this.options={enableMouse:!0,enableKeyboard:!0,enableTouch:!0,enableDelegation:!0,...i},this.eventBus=st.getInstance(),this.mouseHandler=null,this.keyboardHandler=null,this.touchHandler=null,this.delegator=null,this.isInitialized=!1,this.isDestroyed=!1}async init(){if(this.isInitialized)console.warn("EventIntegration already initialized");else try{this.options.enableMouse&&(this.mouseHandler=new Ee(this.canvas,this.viewport),this.mouseHandler.init()),this.options.enableKeyboard&&(this.keyboardHandler=new Ce(document,this.viewport),this.keyboardHandler.init()),this.options.enableTouch&&(this.touchHandler=new Le(this.canvas,this.viewport),this.touchHandler.init()),this.options.enableDelegation&&(this.delegator=new Ie(document),this.delegator.init()),this.isInitialized=!0,console.log("EventIntegration initialized successfully")}catch(t){throw console.error("Failed to initialize EventIntegration:",t),t}}getStats(){var t,e,i,s;return{mouse:(null==(t=this.mouseHandler)?void 0:t.getState())||null,keyboard:(null==(e=this.keyboardHandler)?void 0:e.getPressedKeys())||null,touch:(null==(i=this.touchHandler)?void 0:i.getState())||null,delegation:(null==(s=this.delegator)?void 0:s.getStats())||null,eventBus:this.eventBus.getStats()}}setEventTypeEnabled(t,e){switch(t){case"mouse":this.mouseHandler&&this.mouseHandler.setEnabled(e);break;case"keyboard":case"delegation":break;case"touch":this.touchHandler&&this.touchHandler.setEnabled(e);break;default:console.warn("Unknown event type: ".concat(t))}}registerKeyboardShortcut(t,e){this.keyboardHandler&&this.keyboardHandler.registerShortcut(t,e)}registerDelegation(t,e,i){return this.delegator?this.delegator.addDelegation(t,e,i):()=>{}}updateTouchConfig(t){this.touchHandler&&this.touchHandler.updateConfig(t)}getKeyboardHelp(){var t;return(null==(t=this.keyboardHandler)?void 0:t.getHelpText())||"Keyboard handler not available"}clearPressedKeys(){this.keyboardHandler&&this.keyboardHandler.clearPressedKeys()}isKeyPressed(t){var e;return(null==(e=this.keyboardHandler)?void 0:e.isKeyPressed(t))||!1}getMouseState(){var t;return(null==(t=this.mouseHandler)?void 0:t.getState())||null}getTouchState(){var t;return(null==(t=this.touchHandler)?void 0:t.getState())||null}destroy(){this.isDestroyed||(this.mouseHandler&&(this.mouseHandler.destroy(),this.mouseHandler=null),this.keyboardHandler&&(this.keyboardHandler.destroy(),this.keyboardHandler=null),this.touchHandler&&(this.touchHandler.destroy(),this.touchHandler=null),this.delegator&&(this.delegator.destroy(),this.delegator=null),this.isDestroyed=!0)}}function De(t){var e;const i=st.getInstance(),a=[],r=(t,e,s)=>{const n=i.on(t,e,s);return a.push(n),n};r(s,()=>{var e;null==(e=t.statusMessage)||e.show("Loading G-Code file...","info")}),r(n,async e=>{var i,s,n,o,a,r,l;try{if(t.currentGCode={path:e.path,bounds:e.bounds,stats:e.stats},null==(i=t.canvas)||i.setGCodePath(e.path),null==(s=t.canvas)||s.viewport.fitToBounds(e.bounds),null==(n=t.canvas)||n.redraw(),t.gcodeDrawer&&(null==(a=null==(o=t.toolbar)?void 0:o.fileHandler)?void 0:a.loadedData)){const i=t.toolbar.fileHandler.loadedData.content;try{const s=function(t){if("string"!=typeof t)return"";const e=t.split(/\r?\n/),i=[];let s=0;for(e.length&&"%"===e[0].trim()&&(s=1);s<e.length;s++){let t=e[s];if(!t){i.push("");continue}let n=t.trim();if("%"!==n){if(n=n.replace(/^N\d+\s+/i,""),n=ie(n),/\bG92\b/i.test(n)){const t=/\bX-?\d+(?:\.\d+)?\b/i.test(n),e=/\bY-?\d+(?:\.\d+)?\b/i.test(n);if(!t&&!e){const t=(0).toFixed(Tt.DEFAULT_PRECISION);n="".concat(n," X").concat(t," Y").concat(t).trim()}}i.push(n)}}for(let n=i.length-1;n>=0;n--)if(""!==i[n].trim()){/\bM0?2\b/i.test(i[n])&&i.slice(n+1).every(t=>""===t.trim())&&i.splice(n,1);break}return i.join("\n")}(i);t.gcodeDrawer.setContent({text:s,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}catch(h){try{const s=ie(i);t.gcodeDrawer.setContent({text:s,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}catch(c){t.gcodeDrawer.setContent({text:i,mapping:e.path.map((t,e)=>({index:e,line:t.line||null,point:t}))})}}}null==(r=t.statusMessage)||r.show("G-Code loaded: ".concat(e.file.name),"success")}catch(d){console.error("File display failed:",d),null==(l=t.statusMessage)||l.show("Failed to display file: ".concat(d.message),"error")}}),r(o,e=>{var i;console.error("File loading failed:",e.error),null==(i=t.statusMessage)||i.show("Failed to load file: ".concat(e.error.message||e.error),"error")}),r(y,e=>{var i;"canvas"===e.target&&(null==(i=t.addMeasurementPoint)||i.call(t,e.worldX,e.worldY))}),r(p,()=>{var e;null==(e=t.canvas)||e.redraw()}),r(R,()=>{var e;null==(e=t.canvas)||e._handleResize()}),t.gcodeDrawer&&(r("drawer:line:hover",({index:e})=>{var i;null==(i=t.canvas)||i.setHoverHighlight(e)}),r("drawer:line:leave",()=>{var e;null==(e=t.canvas)||e.setHoverHighlight(null)}),r("drawer:line:click",({index:e})=>{var i;null==(i=t.canvas)||i.togglePersistentHighlight(e)}),r("drawer:insert:points",({atIndex:e,points:i})=>{i&&0!==i.length&&t.gcodeDrawer.insertPointsAt(e,i)}),r("drawer:content:changed",async({text:e})=>{var i,s;try{const n=ie(e||""),o=t.parser.parse(n);t.currentGCode={path:o.path,bounds:o.bounds,stats:o.stats},null==(i=t.canvas)||i.setGCodePath(o.path),null==(s=t.canvas)||s.redraw(),t.gcodeDrawer.setContent({text:n,mapping:o.path.map((t,e)=>({index:e,line:t.line||null,point:t})),preserveHistory:!0})}catch(n){console.error("Re-parse failed:",n)}})),r(E,e=>{var s,n;const o={id:e.id||Date.now(),x:e.x,y:e.y,index:t.clickedPoints.length};t.clickedPoints.push(o),null==(s=t.canvas)||s.setClickedPoints(t.clickedPoints),null==(n=t.canvas)||n.redraw(),i.emit(x,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),r(C,e=>{var s,n;t.clickedPoints=t.clickedPoints.filter(t=>t.id!==e.id),t.clickedPoints.forEach((t,e)=>{t.index=e}),null==(s=t.canvas)||s.setClickedPoints(t.clickedPoints),null==(n=t.canvas)||n.redraw(),i.emit(x,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),r(T,()=>{var e,s;t.clickedPoints=[],null==(e=t.canvas)||e.setClickedPoints(t.clickedPoints),null==(s=t.canvas)||s.redraw(),i.emit(x,{pointCount:t.clickedPoints.length,points:t.clickedPoints})}),r(M,()=>{i.emit(D,{points:[...t.clickedPoints]},{skipValidation:!0})}),r(u,e=>{var s,n,o,a;if(e&&"string"==typeof e.type){"in"===e.type?null==(s=t.canvas)||s.viewport.zoomIn():"out"===e.type&&(null==(n=t.canvas)||n.viewport.zoomOut()),null==(o=t.canvas)||o.redraw();const a={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};return void i.emit(u,a)}null==(a=t.canvas)||a.redraw()}),r(m,()=>{var e,s;if(t.currentGCode){null==(e=t.canvas)||e.viewport.fitToBounds(t.currentGCode.bounds),null==(s=t.canvas)||s.redraw();const n={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};i.emit(u,n)}}),r(g,()=>{var e,s;null==(e=t.canvas)||e.viewport.reset(),null==(s=t.canvas)||s.redraw();const n={...t.canvas.viewport.getState(),canvasWidth:t.canvas.canvas.width,canvasHeight:t.canvas.canvas.height};i.emit(u,n)}),r(P,e=>{var s,n;const o=e&&"boolean"==typeof e.enabled;o?t.gridSnapEnabled=e.enabled:(t.gridSnapEnabled=!t.gridSnapEnabled,i.emit(P,{enabled:t.gridSnapEnabled},{skipValidation:!0})),null==(s=t.canvas)||s.viewport.setGridSnap(t.gridSnapEnabled,t.canvas.gridSize),o||null==(n=t.statusMessage)||n.show("Grid snap ".concat(t.gridSnapEnabled?"enabled":"disabled"),"info")}),r(O,()=>{var e,i,s;const n=null==(e=t.canvas)?void 0:e.gridEnabled;null==(i=t.canvas)||i.setGridEnabled(!n),null==(s=t.statusMessage)||s.show("Grid ".concat(n?"disabled":"enabled"),"info")}),r(N,e=>{var i,s,n,o,a,r,l,h,c,d,u,p,g;const m=e&&"string"==typeof e.format?e.format.toLowerCase():"iso";if("iso"===m){const e=null==(s=null==(i=t.gcodeDrawer)?void 0:i.getText)?void 0:s.call(i);if(!e||""===e.trim())return void(null==(n=t.statusMessage)||n.show("Nothing to export. Load a file or add content.","warning"));return void((null==(a=null==(o=t.toolbar)?void 0:o.fileHandler)?void 0:a.exportNormalizedISOFromText(e,{filename:"program_".concat((new Date).toISOString().slice(0,19).replace(/[:T]/g,"-"),".iso")}))||null==(r=t.statusMessage)||r.show("ISO export failed","error"))}if("csv"===m){if(0===t.clickedPoints.length)return void(null==(l=t.statusMessage)||l.show("No points to export","warning"));const e={points:t.clickedPoints,format:"csv",timestamp:(new Date).toISOString()};if("function"==typeof t._exportPointsAsCSV)t._exportPointsAsCSV(e);else{const t=["Point,X,Y",...e.points.map((t,e)=>"P".concat(e+1,",").concat(t.x.toFixed(3),",").concat(t.y.toFixed(3)))].join("\n"),i=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download="measurement_points.csv",n.click(),URL.revokeObjectURL(s)}return}const v=null==(c=null==(h=t.gcodeDrawer)?void 0:h.getText)?void 0:c.call(h);if(!v||""===v.trim())return void(null==(d=t.statusMessage)||d.show("Nothing to export. Load a file or add content.","warning"));(null==(p=null==(u=t.toolbar)?void 0:u.fileHandler)?void 0:p.exportNormalizedISOFromText(v,{filename:"program_".concat((new Date).toISOString().slice(0,19).replace(/[:T]/g,"-"),".iso")}))||null==(g=t.statusMessage)||g.show("Export failed","error")});const l=()=>{i.emit(R,{width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",l),null==(e=t.eventIntegration)||e.init(),function(){var e;a.forEach(t=>{try{"function"==typeof t&&t()}catch(e){}}),a.length=0;try{window.removeEventListener("resize",l)}catch(i){}try{null==(e=t.eventIntegration)||e.destroy()}catch(i){}}}class Pe{constructor(t={}){this.options=t,this.eventBus=st.getInstance(),this.isInitialized=!1,this.isDestroyed=!1,this.currentGCode=null,this.clickedPoints=[],this.gridSnapEnabled=!1,this.domRefs=null,this.canvas=null,this.toolbar=null,this.sidebar=null,this.gcodeDrawer=null,this.statusMessage=null,this.eventIntegration=null,this.parser=null,this._detachWiring=null}async init(){"loading"===document.readyState&&await new Promise(t=>{document.addEventListener("DOMContentLoaded",t)}),this.eventBus.emit(Z,{timestamp:Date.now()},{skipValidation:!0}),this.domRefs=function(){const t=document.getElementById("app");if(!t)throw new Error("App container element not found");t.innerHTML="";const e=document.createElement("div");e.className="wire-edm-viewer",e.innerHTML='\n    <header class="header">\n      <div id="toolbar-container" class="controls"></div>\n    </header>\n    \n    <main class="main-container">\n      <div class="canvas-container">\n        <canvas id="main-canvas" class="main-canvas"></canvas>\n        <div id="canvas-overlay" class="canvas-overlay"></div>\n      </div>\n      \n      <aside id="sidebar-container" class="sidebar"></aside>\n    </main>\n    \n    <div id="status-container" class="status-container"></div>\n  ',t.appendChild(e);const i=document.getElementById("main-canvas");if(!i)throw new Error("Canvas element not found");return{appContainer:t,canvasElement:i,toolbarContainer:document.getElementById("toolbar-container"),sidebarContainer:document.getElementById("sidebar-container"),statusContainer:document.getElementById("status-container"),canvasOverlay:document.getElementById("canvas-overlay")}}();const t=await async function(t){if(!t||!t.canvasElement)throw new Error("initAppComponents requires valid domRefs");const{canvasElement:e,toolbarContainer:i,sidebarContainer:s,statusContainer:n}=t,o=new Vt(e,{showGrid:!0,gridSize:at,enableHighDPI:!1});await o.init();const a=new le(i,{enableFileInput:!0,enableZoomControls:!0,enableUtilityButtons:!0});a.init();const r=new he(s,{showCoordinates:!0,showPoints:!0,showPathInfo:!0}),l=new we(document.body,{anchor:"right"});return"function"==typeof a.setGCodeDrawer&&a.setGCodeDrawer(l),{canvas:o,toolbar:a,sidebar:r,gcodeDrawer:l,statusMessage:new te({container:n,position:"top-right",maxMessages:3,defaultDuration:3e3}),eventIntegration:new Me(e,o.viewport,{enableMouse:!0,enableKeyboard:!0,enableTouch:!0,enableDelegation:!0}),parser:new jt}}(this.domRefs);this.canvas=t.canvas,this.toolbar=t.toolbar,this.sidebar=t.sidebar,this.gcodeDrawer=t.gcodeDrawer,this.statusMessage=t.statusMessage,this.eventIntegration=t.eventIntegration,this.parser=t.parser,this._detachWiring=De(this),this.hideLoadingIndicator(),this.isInitialized=!0,this.eventBus.emit(j,{timestamp:Date.now(),version:"2.0.0",components:["Canvas","Toolbar","Sidebar","StatusMessage"]})}addMeasurementPoint(t,e){const i={id:Date.now().toString(),x:t,y:e};this.eventBus.emit(E,i)}_exportPointsAsCSV(t){var e;const i=["Point,X,Y",...t.points.map((t,e)=>"P".concat(e+1,",").concat(t.x.toFixed(3),",").concat(t.y.toFixed(3)))].join("\n"),s=new Blob([i],{type:"text/csv"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download="measurement_points_".concat((new Date).toISOString().slice(0,19).replace(/:/g,"-"),".csv"),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),null==(e=this.statusMessage)||e.show("Exported ".concat(t.points.length," points to CSV"),"success"),this.eventBus.emit(X,{pointCount:t.points.length,format:"csv",points:t.points})}hideLoadingIndicator(){const t=document.getElementById("loading");t&&(t.style.display="none")}showError(t){this.statusMessage?this.statusMessage.show(t,"error"):alert("Error: "+t)}destroy(){var t;if(!this.isDestroyed)try{if(this._detachWiring){try{this._detachWiring()}catch(e){}this._detachWiring=null}this.eventIntegration&&this.eventIntegration.destroy(),this.canvas&&this.canvas.destroy(),this.toolbar&&this.toolbar.destroy(),this.sidebar&&this.sidebar.destroy(),this.statusMessage&&this.statusMessage.destroy(),this.eventBus&&this.eventBus.removeAllListeners(),(null==(t=this.domRefs)?void 0:t.appContainer)&&(this.domRefs.appContainer.innerHTML=""),this.isDestroyed=!0,this.eventBus.emit(J,{timestamp:Date.now()},{skipValidation:!0})}catch(i){console.error("AppOrchestrator cleanup failed:",i)}}}!async function(){try{const t=new Pe;await t.init(),window.wireEDMViewer=t,window.addEventListener("beforeunload",()=>{try{t.destroy()}catch(e){}})}catch(t){console.error("‚ùå Application startup failed:",t);const e=document.getElementById("app");e&&(e.innerHTML='\n        <div style="padding: 20px; text-align: center; color: #ff6b6b;">\n          <h2>‚ùå Application Failed to Start</h2>\n          <p>'.concat(t.message,"</p>\n          <p>Please refresh the page to try again.</p>\n        </div>\n      "))}}();export{i as __vite_legacy_guard};
